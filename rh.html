<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal de Recursos Humanos</title>
    <link rel="stylesheet" href="css/admin.css" />
    <link rel="stylesheet" href="css/index.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="icon" href="Media/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  </head>
  <body>
    <header>
      <div class="header-container">
        <a href="#" class="back-button" onclick="logout()">
          <i class="bi bi-arrow-left"></i>
          Cerrar Sesión
        </a>
        <img src="Media/logo.png" alt="Logo" class="logo" />
        <h1>Portal De Recursos Humanos</h1>
      </div>
    </header>

    <div class="welcome-section">
      <div class="welcome-message">
        ¡Hola <span id="employee-name"></span>!
      </div>
      <p>¿Qué deseas hacer hoy?</p>
    </div>

    <div class="content-wrapper">
      <div class="employee-table-container">
        <h2>
          Empleados Registrados
          <button class="add-employee-btn" onclick="abrirModalAltaEmpleado()">
            Agregar empleado +
          </button>

          <button
            class="add-employee-btn"
            onclick="abrirModalExportarExcel()"
            style="margin-left: 2px"
          >
            Exportar Excel +
          </button>
        </h2>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <select
            id="filtro-estado"
            style="
              padding: 8px 12px;
              border-radius: 6px;
              font-family: Arial, sans-serif;
              font-size: 1rem;
              border: 1.5px solid #bbb;
              background-color: #fff;
              cursor: pointer;
              outline: none;
              transition: border-color 0.3s ease;
              margin-right: 450px;
            "
          >
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
            <option value="todos">Todos</option>
          </select>
          <input
            type="text"
            id="busquedaEmpleado"
            oninput="buscarEmpleado()"
            placeholder="Buscar por ID o nombre"
            style="
              padding: 8px;
              width: 250px;
              margin-right: 8px;
              border-radius: 4px;
              border: 1px solid #ccc;
            "
          />
          <button
            onclick="buscarEmpleado()"
            style="
              background-color: #2c3e50;
              color: white;
              padding: 8px 12px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            <i class="bi bi-search"></i>
          </button>
        </div>

        <table class="employee-table">
          <thead>
            <tr>
              <th>Número</th>
              <th>Nombre</th>
              <th>Puesto</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="empleados-body"></tbody>
        </table>
      </div>
      <div class="options-container">
        <a href="evaluarSoli.html" class="option-button">
          <span id="notificacion-solicitudes" class="badge-notificacion"
            >0</span
          >
          <i class="bi bi-search" style="font-size: 24px"></i>
          <h2>Solicitudes</h2>
          <p>Evalúa las solicitudes de tus empleados</p>
        </a>

        <a href="verSolicitudes.html" class="option-button">
          <i class="bi bi-search" style="font-size: 24px"></i>
          <h2>Ver Solicitudes</h2>
          <p>Mira el historial de las solicitudes evaluadas.</p>
        </a>

        <a href="incapacidad.html" class="option-button">
          <i class="bi bi-hospital" style="font-size: 24px"></i>
          <h2>Incapacidades</h2>
          <p>Autorizaciones</p>
        </a>

        <a href="verIncapacidades.html" class="option-button">
          <i class="bi bi-hospital" style="font-size: 24px"></i>
          <h2>Ver Incapacidades</h2>
          <p>Consulta que empleados están en una incapacidad</p>
        </a>

        <a href="#" class="option-button" onclick="abrirModalAgregarArea()">
          <i class="bi bi-building" style="font-size: 24px"></i>
          <h2>Área</h2>
          <p>Agregar</p>
        </a>

        <a
          href="#"
          class="option-button"
          onclick="abrirModalAgregarFestivo()"
          style="text-decoration: none"
        >
          <i class="bi bi-calendar-plus" style="font-size: 24px"></i>
          <h2>Día Festivo</h2>
          <p>Agregar un nuevo día festivo</p>
        </a>

        <a href="reporte.html" class="option-button">
          <i class="bi bi-bar-chart-line" style="font-size: 24px"></i>
          <h2>Reportes</h2>
          <p>Genera un reporte</p>
        </a>

        <a href="verReportes.html" class="option-button">
          <i class="bi bi-bar-chart-line" style="font-size: 24px"></i>
          <h2>Ver reportes</h2>
          <p>Visualiza los reportes generados</p>
        </a>

        <a href="vacante.html" class="option-button">
          <i class="bi bi-pin-map" style="font-size: 24px"></i>
          <h2>Vacante</h2>
          <p>Administra</p>
        </a>

        <a href="verVacantes.html" class="option-button">
          <i class="bi bi-pencil" style="font-size: 24px"></i>
          <h2>Ver Vacantes</h2>
          <p>Administra las vacantes solicitadas por tus compañeros</p>
        </a>
      </div>
    </div>

    <!-- Modal para ver detalles del empleado -->
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2>Detalle del Empleado</h2>
        <div id="modal-body"></div>
      </div>
    </div>

    <!-- Modal para dar de alta empleado -->
    <div id="add-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAltaEmpleado()">&times;</span>
        <h2>Dar de alta nuevo empleado</h2>
        <form id="employee-form" class="add-employee-form">
          <!-- Campo 1 -->
          <div class="form-group">
            <label for="idUsuario">ID Usuario:</label>
            <input type="number" id="idUsuario" name="idUsuario" required />
          </div>

          <!-- Campo 2 (Combobox) -->
          <div class="form-group">
            <label for="tipoRol">Tipo de Rol:</label>
            <select id="tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <div class="form-group">
            <label>Áreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="toggle-areas"
              onclick="toggleAreas()"
            >
              Mostrar Áreas ▼
            </button>

            <div id="checkbox-areas" class="desplegable-container">
              <!-- Checkboxes se cargarán aquí -->
            </div>
            <small>Puedes seleccionar una o más áreas.</small>
          </div>

          <!-- Campo 4 -->
          <div class="form-group">
            <label for="nombres">Nombres:</label>
            <input type="text" id="nombres" name="nombres" required />
          </div>

          <!-- Campo 5 -->
          <div class="form-group">
            <label for="paterno">Apellido Paterno:</label>
            <input type="text" id="paterno" name="paterno" required />
          </div>

          <!-- Campo 6 -->
          <div class="form-group">
            <label for="materno">Apellido Materno:</label>
            <input type="text" id="materno" name="materno" />
          </div>

          <!-- Campo 7 -->
          <div class="form-group">
            <label for="fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Campo 8 -->
          <div class="form-group">
            <label for="direccion">Dirección:</label>
            <input type="text" id="direccion" name="direccion" required />
          </div>

          <!-- Campo 9 -->
          <div class="form-group">
            <label for="codigoPostal">Código Postal:</label>
            <input type="text" id="codigoPostal" name="codigoPostal" required />
          </div>

          <!-- Campo 10 -->
          <div class="form-group">
            <label for="correo">Correo Electrónico:</label>
            <input type="email" id="correo" name="correo" required />
          </div>

          <!-- Campo 11 -->
          <div class="form-group">
            <label for="nss">Número de Seguro Social (NSS):</label>
            <input type="text" id="nss" name="nss" required />
          </div>

          <!-- Campo 12 -->
          <div class="form-group">
            <label for="telefono">Teléfono:</label>
            <input type="tel" id="telefono" name="telefono" required />
          </div>

          <!-- Campo 13 -->
          <div class="form-group">
            <label for="fechaIngreso">Fecha de Ingreso:</label>
            <input type="date" id="fechaIngreso" name="fechaIngreso" required />
          </div>

          <!-- Campo 14 -->
          <div class="form-group">
            <label for="rfc">RFC:</label>
            <input type="text" id="rfc" name="rfc" required />
          </div>

          <!-- Campo 15 -->
          <div class="form-group">
            <label for="curp">CURP:</label>
            <input type="text" id="curp" name="curp" required />
          </div>

          <!-- Campo 16 -->
          <div class="form-group">
            <label for="puesto">Puesto:</label>
            <input type="text" id="puesto" name="puesto" required />
          </div>

          <!-- Campo 17 -->
          <div class="form-group">
            <label for="nombreContactoEmergencia"
              >Beneficiario/Contacto Emergencia:</label
            >
            <input
              type="text"
              id="nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Campo 18 -->
          <div class="form-group">
            <label for="telefonoEmergencia">Teléfono Emergencia:</label>
            <input
              type="tel"
              id="telefonoEmergencia"
              name="telefonoEmergencia"
              required
            />
          </div>

          <!-- Campo 19 -->
          <div class="form-group">
            <label for="parentesco">Parentesco:</label>
            <input type="text" id="parentesco" name="parentesco" required />
          </div>

          <!-- Campo 20 -->
          <div class="form-group">
            <label for="contraseña">Contraseña:</label>
            <input type="password" id="contraseña" name="contraseña" required />
          </div>

          <!-- Campo 21 -->
          <div class="form-group">
            <label for="confirmarContraseña">Confirmar Contraseña:</label>
            <input
              type="password"
              id="confirmarContraseña"
              name="confirmarContraseña"
              required
            />
          </div>

          <!-- Campo Sueldo Diario -->
          <div class="form-group">
            <label for="sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="sueldoDiario"
              name="SueldoDiario"
              required
            />
          </div>

          <!-- Campo Sueldo Semanal -->
          <div class="form-group">
            <label for="sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="sueldoSemanal"
              name="SueldoSemanal"
              required
            />
          </div>

          <!-- Campo Bono Semanal -->
          <div class="form-group">
            <label for="bonoSemanal">Bono Semanal:</label>
            <input type="number" id="bonoSemanal" name="BonoSemanal" required />
          </div>

          <!-- Campo Vacaciones Disponibles -->
          <div class="form-group">
            <label for="vacacionesDisponibles">Vacaciones Disponibles:</label>
            <input
              type="number"
              id="diasDisponibles"
              name="diasDisponibles"
              required
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAltaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para editar empleado -->
    <div id="edit-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalEditarEmpleado()">&times;</span>
        <h2>Editar Empleado</h2>
        <form id="edit-employee-form" class="add-employee-form">
          <!-- ID -->
          <div class="form-group">
            <label for="edit-idUsuario">ID Usuario:</label>
            <input
              type="number"
              id="edit-idUsuario"
              name="idUsuario"
              readonly
            />
          </div>

          <!-- Rol -->
          <div class="form-group">
            <label for="edit-tipoRol">Tipo de Rol:</label>
            <select id="edit-tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <!-- Áreas con toggle -->
          <div class="form-group">
            <label>Áreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="edit-toggle-areas"
              onclick="toggleAreas('edit')"
            >
              Mostrar Áreas ▼
            </button>
            <div id="edit-checkbox-areas" class="desplegable-container">
              <!-- checkboxes se insertan dinámicamente -->
            </div>
            <small>Puedes seleccionar una o más áreas.</small>
          </div>

          <!-- Nombres -->
          <div class="form-group">
            <label for="edit-nombres">Nombres:</label>
            <input type="text" id="edit-nombres" name="nombres" required />
          </div>

          <!-- Paterno -->
          <div class="form-group">
            <label for="edit-paterno">Apellido Paterno:</label>
            <input type="text" id="edit-paterno" name="paterno" required />
          </div>

          <!-- Materno -->
          <div class="form-group">
            <label for="edit-materno">Apellido Materno:</label>
            <input type="text" id="edit-materno" name="materno" />
          </div>

          <!-- Fecha de Nacimiento -->
          <div class="form-group">
            <label for="edit-fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="edit-fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Dirección -->
          <div class="form-group">
            <label for="edit-direccion">Dirección:</label>
            <input type="text" id="edit-direccion" name="direccion" required />
          </div>

          <!-- Código Postal -->
          <div class="form-group">
            <label for="edit-codigoPostal">Código Postal:</label>
            <input
              type="text"
              id="edit-codigoPostal"
              name="codigoPostal"
              required
            />
          </div>

          <!-- Correo -->
          <div class="form-group">
            <label for="edit-correo">Correo Electrónico:</label>
            <input type="email" id="edit-correo" name="correo" required />
          </div>

          <!-- NSS -->
          <div class="form-group">
            <label for="edit-nss">Número de Seguro Social (NSS):</label>
            <input type="text" id="edit-nss" name="nss" required />
          </div>

          <!-- Teléfono -->
          <div class="form-group">
            <label for="edit-telefono">Teléfono:</label>
            <input type="tel" id="edit-telefono" name="telefono" required />
          </div>

          <!-- Fecha de Ingreso -->
          <div class="form-group">
            <label for="edit-fechaIngreso">Fecha de Ingreso:</label>
            <input
              type="date"
              id="edit-fechaIngreso"
              name="fechaIngreso"
              required
            />
          </div>

          <!-- RFC -->
          <div class="form-group">
            <label for="edit-rfc">RFC:</label>
            <input type="text" id="edit-rfc" name="rfc" required />
          </div>

          <!-- CURP -->
          <div class="form-group">
            <label for="edit-curp">CURP:</label>
            <input type="text" id="edit-curp" name="curp" required />
          </div>

          <!-- Puesto -->
          <div class="form-group">
            <label for="edit-puesto">Puesto:</label>
            <input type="text" id="edit-puesto" name="puesto" required />
          </div>

          <!-- Contacto de Emergencia -->
          <div class="form-group">
            <label for="edit-nombreContactoEmergencia"
              >Nombre Contacto Emergencia:</label
            >
            <input
              type="text"
              id="edit-nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Teléfono Emergencia -->
          <div class="form-group">
            <label for="edit-telefonoEmergencia">Teléfono Emergencia:</label>
            <input
              type="tel"
              id="edit-telefonoEmergencia"
              name="telefonoEmergencia"
              required
            />
          </div>

          <!-- Parentesco -->
          <div class="form-group">
            <label for="edit-parentesco">Parentesco:</label>
            <input
              type="text"
              id="edit-parentesco"
              name="parentesco"
              required
            />
          </div>

          <!-- Contraseña -->
          <div class="form-group">
            <label for="edit-contraseña">Contraseña:</label>
            <input
              type="password"
              id="edit-contraseña"
              name="contraseña"
              required
            />
          </div>

          <!-- Confirmar Contraseña -->
          <div class="form-group">
            <label for="edit-confirmarContraseña">Confirmar Contraseña:</label>
            <input
              type="password"
              id="edit-confirmarContraseña"
              name="confirmarContraseña"
              required
            />
          </div>

          <!-- Sueldo Diario -->
          <div class="form-group">
            <label for="edit-sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="edit-sueldoDiario"
              name="SueldoDiario"
              required
            />
          </div>

          <!-- Sueldo Semanal -->
          <div class="form-group">
            <label for="edit-sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="edit-sueldoSemanal"
              name="SueldoSemanal"
              required
            />
          </div>

          <!-- Bono Semanal -->
          <div class="form-group">
            <label for="edit-bonoSemanal">Bono Semanal:</label>
            <input
              type="number"
              id="edit-bonoSemanal"
              name="BonoSemanal"
              required
            />
          </div>

          <!-- Fecha de Baja -->
          <div class="form-group">
            <label for="edit-fechaBaja">Fecha de Baja:</label>
            <input type="date" id="edit-fechaBaja" name="fechaBaja" />
          </div>

          <!-- Comentario de Salida -->
          <div class="form-group">
            <label for="edit-comentarioSalida">Comentario de Salida:</label>
            <input
              type="text"
              id="edit-comentarioSalida"
              name="comentarioSalida"
            />
          </div>

          <!-- Vacaciones -->
          <div class="form-group">
            <label for="edit-vacaciones">Vacaciones:</label>
            <input type="number" id="edit-vacaciones" name="Vacaciones" />
          </div>

          <!-- Vacaciones Disponibles -->
          <div class="form-group">
            <label for="edit-diasDisponibles">Vacaciones disponibles:</label>
            <input
              type="text"
              id="edit-diasDisponibles"
              name="diasDisponibles"
            />
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalEditarEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Actualizar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar día festivo -->
    <div id="add-holiday-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarFestivo()">&times;</span>
        <h2>Agregar Día Festivo</h2>
        <form id="holiday-form" class="add-employee-form">
          <!-- Campo Fecha -->
          <div class="form-group">
            <label for="fechaFestivo">Fecha:</label>
            <input type="date" id="fechaFestivo" name="fechaFestivo" required />
          </div>

          <!-- Campo Descripción -->
          <div class="form-group">
            <label for="descripcionFestivo">Descripción:</label>
            <input
              type="text"
              id="descripcionFestivo"
              name="descripcionFestivo"
              required
              placeholder="Ej. Día de la Independencia"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarFestivo()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Agregar Festivo
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar área -->
    <div id="add-area-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarArea()">&times;</span>
        <h2>Agregar Área</h2>
        <form id="area-form" class="add-employee-form">
          <!-- Campo Nombre del Área -->
          <div class="form-group">
            <label for="nombreArea">Nombre del Área:</label>
            <input
              type="text"
              id="nombreArea"
              name="nombreArea"
              required
              placeholder="Ej. Recursos Humanos"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarArea()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Agregar Área</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para exportar a Excel (actualizado) -->
    <div id="export-excel-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalExportarExcel()">&times;</span>

        <!-- Paso 1: Selección de campos -->
        <div id="paso-campos">
          <h2>Exportar datos (1/2)</h2>
          <p>Selecciona los campos que deseas incluir en el reporte:</p>
          <div id="export-fields-container" class="fields-grid"></div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalExportarExcel()"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="mostrarPasoEmpleados()"
            >
              Siguiente
            </button>
          </div>
        </div>

        <!-- Paso 2: Selección de empleados -->
        <div id="paso-empleados" class="hidden">
          <h2>Exportar datos (2/2)</h2>
          <p>Selecciona los empleados a incluir en el reporte:</p>
          <div style="margin-bottom: 10px">
           
          </div>
          <div id="export-employees-container" class="fields-grid"></div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="mostrarPasoCampos()"
            >
              Anterior
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportarExcel()"
            >
              Generar Excel
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-confirmacion" class="modal-confirmacion hidden">
      <div class="modal-contenido">
        <p id="modal-texto">¿Quieres eliminar este empleado?</p>
        <div class="modal-botones">
          <button id="modal-cancelar" class="btn">Cancelar</button>
          <button id="modal-confirmar" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </div>

    <div id="modal-exito" class="modal-exito hidden">
      <div class="modal-contenido-exito">
        <p>Actualización correcta</p>
        <button id="btn-cerrar-exito" class="btn btn-primary">Aceptar</button>
      </div>
    </div>

    <div id="modal-baja-empleado" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModalBajaEmpleado()">&times;</span>
        <h2>Dar de Baja Empleado</h2>

        <div style="margin-bottom: 15px">
          <p>
            Empleado: <strong id="nombre-empleado-baja"></strong> <br /><br />
          </p>
          <p>ID: <strong id="id-empleado-baja"></strong></p>
        </div>

        <form id="form-baja-empleado">
          <input type="hidden" id="baja-idUsuario" />

          <div class="form-group">
            <label for="baja-fecha">Fecha de Baja:</label>
            <input type="date" id="baja-fecha" name="fechaBaja" required />
          </div>

          <div class="form-group">
            <label for="baja-comentario">Motivo de la baja:</label>
            <textarea
              id="baja-comentario"
              name="comentarioSalida"
              rows="4"
              required
              class="estilo-textarea"
            ></textarea>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalBajaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-danger">Confirmar Baja</button>
          </div>
        </form>
      </div>
    </div>



<script>
  let empleadosVisibles = []; 
  function toggleAreas(context = "") {
    const prefix = context ? context + "-" : "";
    const contenedor = document.getElementById(`${prefix}checkbox-areas`);
    const boton = document.getElementById(`${prefix}toggle-areas`);

    if (!contenedor || !boton) return;

    if (contenedor.classList.contains("abierto")) {
      contenedor.classList.remove("abierto");
      boton.textContent = "Mostrar Áreas ▼";
    } else {
      contenedor.classList.add("abierto");
      boton.textContent = "Ocultar Áreas ▲";
    }
  }

  function verificarSesion() {
    const idUsuario = localStorage.getItem("idUsuario");
    if (!idUsuario) {
      window.location.href = "index.html";
    }
    return idUsuario;
  }

  async function cargarNotificaciones() {
    try {
      const idUsuario = localStorage.getItem("idUsuario");
      if (!idUsuario) return;

      const response = await fetch(`/api/totalSolicitudes/${idUsuario}`);
      if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

      const data = await response.json();
      const badge = document.getElementById("notificacion-solicitudes");
      if (!badge) return;

      badge.textContent = data.total > 0 ? data.total : "";
      badge.style.display = data.total > 0 ? "inline-block" : "none";
    } catch (error) {
      console.error("Error al cargar notificaciones:", error);
    }
  }

  function cargarEmpleadosPorEstado() {
  const estadoSeleccionado = document.getElementById("filtro-estado").value;
  const termino = document.getElementById("busquedaEmpleado").value.toLowerCase();

  fetch(`/api/empleados?estado=${estadoSeleccionado}`)
    .then((response) => response.json())
    .then((data) => {
      const empleadosFiltrados = data.filter(
        (emp) =>
          emp.id.toString().includes(termino) ||
          emp.nombre.toLowerCase().includes(termino)
      );

      empleadosVisibles = empleadosFiltrados;


      const tbody = document.getElementById("empleados-body");
      tbody.innerHTML = "";

      if (empleadosFiltrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">No se encontraron empleados</td></tr>`;
        return;
      }

      empleadosFiltrados.forEach((emp) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${emp.id}</td>
          <td>${emp.nombre}</td>
          <td>${emp.puesto}</td>
          <td>
            <button class="action-btn" onclick="verEmpleado(${emp.id})">
              <i class="bi bi-eye"></i>
            </button>
            <button class="action-btn" onclick="editarEmpleado(${emp.id})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="action-btn" onclick="abrirModalBajaEmpleado(${emp.id})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    })
    .catch((error) => {
      console.error("Error al cargar empleados:", error);
    });
}

// ✅ Reemplaza buscarEmpleado por esta versión:
function buscarEmpleado() {
  cargarEmpleadosPorEstado(); // ahora la búsqueda se combina con el filtro actual
}




  // ✅ INICIALIZACIÓN
  document.addEventListener("DOMContentLoaded", function () {
    const idUsuario = verificarSesion();
    cargarNotificaciones();
    setInterval(cargarNotificaciones, 1200000);

    // Cargar nombre del usuario
    if (idUsuario) {
      cargarNombreUsuario(idUsuario);
    }

// Eventos
  document.getElementById("filtro-estado").addEventListener("change", cargarEmpleadosPorEstado);
  document.getElementById("busquedaEmpleado").addEventListener("input", buscarEmpleado);

  // Carga inicial
  cargarEmpleadosPorEstado();
});

  

      function cargarNombreUsuario(idUsuario) {
        fetch("/api/usuario/nombre", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ idUsuario: idUsuario }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error al obtener el nombre del usuario");
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error(data.error);
              document.getElementById("employee-name").textContent =
                "Administrador";
            } else {
              // Formatear el nombre completo manejando casos donde falte materno
              let nombreCompleto = data.nombres || "";
              if (data.paterno) nombreCompleto += ` ${data.paterno}`;
              if (data.materno) nombreCompleto += ` ${data.materno}`;

              document.getElementById("employee-name").textContent =
                nombreCompleto.trim() || "Administrador";
            }
          })
          .catch((error) => {
            console.error("Error al cargar nombre:", error);
            document.getElementById("employee-name").textContent =
              "Administrador";
          });
      }

      

      function verEmpleado(id) {
        document.body.classList.add("no-scroll");
        fetch(`/api/empleado/${id}`)
          .then((res) => {
            if (!res.ok) throw new Error("Error al cargar datos del empleado");
            return res.json();
          })
          .then((data) => {
            const modalBody = document.getElementById("modal-body");

            const renderField = (label, value) => {
              const texto =
                value === null ||
                value === undefined ||
                value === "" ||
                value === "null"
                  ? "Sin información"
                  : value;
              return `<p><strong>${label}:</strong> ${texto}</p>`;
            };

            // Construir una cadena de texto con todas las áreas
            const areasTexto =
              data.Areas && data.Areas.length > 0
                ? data.Areas.map((area) => area.NombreArea).join(", ")
                : "Sin información";

            modalBody.innerHTML = `
        ${renderField("ID", data.idUsuario)}
        ${renderField("Rol", data.TipoRol)}
        ${renderField("Áreas", areasTexto)}
        ${renderField(
          "Nombre Completo",
          `${data.Nombres} ${data.Paterno} ${data.Materno}`
        )}
        ${renderField("Fecha Nacimiento", data.FechaNacimiento)}
        ${renderField("Dirección", data.Direccion)}
        ${renderField("Código Postal", data.CodigoPostal)}
        ${renderField("Correo", data.Correo)}
        ${renderField("NSS", data.NSS)}
        ${renderField("Teléfono", data.Telefono)}
        ${renderField("Fecha Ingreso", data.FechaIngreso)}
        ${renderField("RFC", data.RFC)}
        ${renderField("CURP", data.Curp)}
        ${renderField("Puesto", data.Puesto)}
        ${renderField("Contacto Emergencia", data.NombreContactoEmergencia)}
        ${renderField("Teléfono Emergencia", data.TelefonoEmergencia)}
        ${renderField("Parentesco", data.Parentesco)}
        ${renderField("Fecha Baja", data.FechaBaja)}
        ${renderField("Comentario Salida", data.ComentarioSalida)}
        ${renderField("Clave", data.clave)}
        ${renderField("Estado", data.Estado)}
        ${renderField("Sueldo Diario", data.SueldoDiario)}
        ${renderField("Sueldo Semanal", data.SueldoSemanal)}
        ${renderField("Bono Semanal", data.BonoSemanal)}
        ${renderField("Vacaciones", data.Vacaciones)}
        ${renderField("Vacaciones disponibles", data.DiasDisponibles)}
      `;

            document.getElementById("modal").classList.remove("hidden");
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al cargar los datos del empleado");
          });
      }

      function cerrarModal() {
        document.getElementById("modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      function abrirModalAltaEmpleado() {
        // Mostrar el modal
        document
          .getElementById("add-employee-modal")
          .classList.remove("hidden");
        document.body.classList.add("no-scroll");
        // Llenar roles
        fetch("/api/roles")
          .then((res) => res.json())
          .then((data) => {
            const selectRol = document.getElementById("tipoRol");
            selectRol.innerHTML = '<option value="">Seleccione un rol</option>';
            data.forEach((rol) => {
              const option = document.createElement("option");
              option.value = rol.idRol;
              option.textContent = rol.TipoRol;
              selectRol.appendChild(option);
            });
          });

        // Llenar áreas como checkboxes
        fetch("/api/areas")
          .then((res) => res.json())
          .then((data) => {
            const container = document.getElementById("checkbox-areas");
            container.innerHTML = "";

            data.forEach((area) => {
              const item = document.createElement("div");
              item.className = "area-item";

              const label = document.createElement("label");
              label.textContent = area.NombreArea;
              label.className = "area-label";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "areas";
              checkbox.value = area.idArea;
              checkbox.className = "area-checkbox";

              item.appendChild(label);
              item.appendChild(checkbox);

              container.appendChild(item);
            });
          });
      }

      function cargarAreasParaEditar(idUsuario, areasSeleccionadas) {
        fetch("/api/areas")
          .then((res) => res.json())
          .then((areas) => {
            const container = document.getElementById("edit-checkbox-areas");
            container.innerHTML = "";

            areas.forEach((area) => {
              const wrapper = document.createElement("div");
              wrapper.className = "area-item";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "areas";
              checkbox.value = area.idArea;
              checkbox.id = `area-${area.idArea}`;
              checkbox.checked = areasSeleccionadas.includes(area.idArea);
              checkbox.className = "area-checkbox";

              const label = document.createElement("label");
              label.htmlFor = checkbox.id;
              label.className = "area-label";
              label.textContent = area.NombreArea;

              wrapper.appendChild(label);
              wrapper.appendChild(checkbox);

              container.appendChild(wrapper);
            });
          });
      }

      function cerrarModalAltaEmpleado() {
        document.getElementById("add-employee-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      //Dar de alta a empleado
      document
        .getElementById("employee-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const fechaIngreso = document.getElementById("fechaIngreso").value;
          const diasVacaciones = calcularDiasVacaciones(fechaIngreso);

          const contraseña = document.getElementById("contraseña").value;
          const confirmarContraseña = document.getElementById(
            "confirmarContraseña"
          ).value;

          if (contraseña !== confirmarContraseña) {
            alert("Las contraseñas no coinciden");
            return;
          }

          const formData = new FormData(this);
          const empleadoData = {};

          formData.forEach((value, key) => {
            empleadoData[key] = value;
          });

          // Obtener las áreas seleccionadas (checkboxes)
          const areasSeleccionadas = Array.from(
            document.querySelectorAll('input[name="areas"]:checked')
          ).map((cb) => parseInt(cb.value));

          if (areasSeleccionadas.length === 0) {
            alert("Debes seleccionar al menos un área.");
            return;
          }

          empleadoData.areas = areasSeleccionadas;

          // Mapear y limpiar campos adicionales
          empleadoData.rol_id = empleadoData.tipoRol;
          delete empleadoData.tipoRol;
          delete empleadoData.nombreArea; // ← ya no se usa

          // Agregar días de vacaciones
          empleadoData.Vacaciones = diasVacaciones;

          // Convertir a número
          empleadoData.idUsuario = Number(empleadoData.idUsuario);
          empleadoData.nss = Number(empleadoData.nss);
          empleadoData.telefono = Number(empleadoData.telefono);
          empleadoData.telefonoEmergencia = Number(
            empleadoData.telefonoEmergencia
          );
          empleadoData.SueldoDiario = Number(empleadoData.SueldoDiario);
          empleadoData.SueldoSemanal = Number(empleadoData.SueldoSemanal);
          empleadoData.BonoSemanal = Number(empleadoData.BonoSemanal);
          empleadoData.Vacaciones = Number(empleadoData.Vacaciones);
          empleadoData.diasDisponibles = Number(empleadoData.diasDisponibles);

          // Validaciones finales
          if (
            isNaN(empleadoData.idUsuario) ||
            isNaN(empleadoData.nss) ||
            isNaN(empleadoData.telefono) ||
            isNaN(empleadoData.telefonoEmergencia) ||
            isNaN(empleadoData.SueldoDiario) ||
            isNaN(empleadoData.SueldoSemanal) ||
            isNaN(empleadoData.BonoSemanal)
          ) {
            alert(
              "Por favor, ingresa valores numéricos válidos en los campos requeridos."
            );
            return;
          }

          // Enviar al backend
          fetch("/api/empleado", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(empleadoData),
          })
            .then((res) => {
              if (!res.ok)
                return res.json().then((data) => {
                  throw new Error(data.error || "Error al guardar el empleado");
                });
              return res.json();
            })
            .then((data) => {
              alert(data.mensaje);
              cerrarModalAltaEmpleado();
              location.reload(); // o actualiza tabla sin recargar
            })
            .catch((error) => {
              console.error("Error al insertar:", error);
              alert("Hubo un error al guardar el empleado: " + error.message);
            });
        });

      // Alternativa para manejar zona horaria
      function formatoFechaParaInput(fecha) {
        if (!fecha) return "";

        // Si ya está en formato YYYY-MM-DD
        if (typeof fecha === "string" && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
          return fecha;
        }

        // Parsear fecha y ajustar por zona horaria
        const date = new Date(fecha);
        const offset = date.getTimezoneOffset();
        date.setMinutes(date.getMinutes() + offset);

        return date.toISOString().split("T")[0];
      }

      function editarEmpleado(id) {
        document
          .getElementById("edit-employee-modal")
          .classList.remove("hidden");
        document.body.classList.add("no-scroll");
        fetch(`/api/empleado/${id}`)
          .then((res) => {
            if (!res.ok) throw new Error("Error al obtener datos del empleado");
            return res.json();
          })
          .then((data) => {
            Promise.all([
              fetch("/api/roles").then((res) => res.json()),
              fetch("/api/areas").then((res) => res.json()),
            ]).then(([roles, areas]) => {
              const selectRol = document.getElementById("edit-tipoRol");

              // Llenar roles
              selectRol.innerHTML =
                '<option value="">Seleccione un rol</option>';
              roles.forEach((rol) => {
                const option = document.createElement("option");
                option.value = rol.idRol;
                option.textContent = rol.TipoRol;
                selectRol.appendChild(option);
              });

              // Llenar campos del formulario
              document.getElementById("edit-idUsuario").value =
                data.idUsuario || "";
              document.getElementById("edit-tipoRol").value =
                data.Rol_idRol || "";
              document.getElementById("edit-nombres").value =
                data.Nombres || "";
              document.getElementById("edit-paterno").value =
                data.Paterno || "";
              document.getElementById("edit-materno").value =
                data.Materno || "";
              document.getElementById("edit-fechaNacimiento").value =
                formatoFechaParaInput(data.FechaNacimiento);
              document.getElementById("edit-direccion").value =
                data.Direccion || "";
              document.getElementById("edit-codigoPostal").value =
                data.CodigoPostal || "";
              document.getElementById("edit-correo").value = data.Correo || "";
              document.getElementById("edit-nss").value = data.NSS || "";
              document.getElementById("edit-telefono").value =
                data.Telefono || "";
              document.getElementById("edit-rfc").value = data.RFC || "";
              document.getElementById("edit-curp").value = data.Curp || "";
              document.getElementById("edit-puesto").value = data.Puesto || "";
              document.getElementById("edit-nombreContactoEmergencia").value =
                data.NombreContactoEmergencia || "";
              document.getElementById("edit-telefonoEmergencia").value =
                data.TelefonoEmergencia || "";
              document.getElementById("edit-parentesco").value =
                data.Parentesco || "";
              document.getElementById("edit-contraseña").value =
                data.clave || "";
              document.getElementById("edit-confirmarContraseña").value =
                data.clave || "";
              document.getElementById("edit-sueldoDiario").value =
                data.SueldoDiario || "";
              document.getElementById("edit-sueldoSemanal").value =
                data.SueldoSemanal || "";
              document.getElementById("edit-bonoSemanal").value =
                data.BonoSemanal || "";
              document.getElementById("edit-fechaBaja").value =
                formatoFechaParaInput(data.FechaBaja);
              document.getElementById("edit-comentarioSalida").value =
                data.ComentarioSalida || "";

              const fechaIngresoInput =
                document.getElementById("edit-fechaIngreso");
              fechaIngresoInput.value = formatoFechaParaInput(
                data.FechaIngreso
              );

              const campoVacaciones =
                document.getElementById("edit-vacaciones");
              campoVacaciones.value =
                data.Vacaciones != null
                  ? data.Vacaciones
                  : calcularDiasVacaciones(fechaIngresoInput.value);

              document.getElementById("edit-diasDisponibles").value =
                data.DiasDisponibles || 0;

              // ✅ Cargar áreas como checkboxes
              const idsDeAreas = (data.Areas || []).map((area) => area.idArea);
              cargarAreasParaEditar(data.idUsuario, idsDeAreas);

              // Recalcular vacaciones si cambia la fecha de ingreso
              fechaIngresoInput.addEventListener("change", function () {
                const nuevaFecha = this.value;
                const dias = calcularDiasVacaciones(nuevaFecha);
                document.getElementById("edit-vacaciones").value = dias;
              });
            });
          })
          .catch((error) => {
            console.error("Error al cargar datos del empleado:", error);
            alert("No se pudieron cargar los datos del empleado.");
          });
      }

      function cerrarModalEditarEmpleado() {
        document.getElementById("edit-employee-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }



      document
        .getElementById("edit-employee-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const contraseña = document.getElementById("edit-contraseña").value;
          const confirmar = document.getElementById(
            "edit-confirmarContraseña"
          ).value;

          if (contraseña !== confirmar) {
            alert("Las contraseñas no coinciden");
            return;
          }

          const empleadoData = {
            idUsuario: Number(document.getElementById("edit-idUsuario").value),
            rol_id: document.getElementById("edit-tipoRol").value,
            nombres: document.getElementById("edit-nombres").value,
            paterno: document.getElementById("edit-paterno").value,
            materno: document.getElementById("edit-materno").value,
            fechaNacimiento: document.getElementById("edit-fechaNacimiento")
              .value,
            direccion: document.getElementById("edit-direccion").value,
            codigoPostal: document.getElementById("edit-codigoPostal").value,
            correo: document.getElementById("edit-correo").value,
            nss: Number(document.getElementById("edit-nss").value),
            telefono: Number(document.getElementById("edit-telefono").value),
            fechaIngreso: document.getElementById("edit-fechaIngreso").value,
            rfc: document.getElementById("edit-rfc").value,
            curp: document.getElementById("edit-curp").value,
            puesto: document.getElementById("edit-puesto").value,
            nombreContactoEmergencia: document.getElementById(
              "edit-nombreContactoEmergencia"
            ).value,
            telefonoEmergencia: Number(
              document.getElementById("edit-telefonoEmergencia").value
            ),
            parentesco: document.getElementById("edit-parentesco").value,
            contraseña: contraseña,
            SueldoDiario: Number(
              document.getElementById("edit-sueldoDiario").value
            ),
            SueldoSemanal: Number(
              document.getElementById("edit-sueldoSemanal").value
            ),
            BonoSemanal: Number(
              document.getElementById("edit-bonoSemanal").value
            ),
            fechaBaja: document.getElementById("edit-fechaBaja").value || null,
            comentarioSalida:
              document.getElementById("edit-comentarioSalida").value || null,
            Vacaciones:
              Number(document.getElementById("edit-vacaciones").value) || 0,
            diasDisponibles:
              Number(document.getElementById("edit-diasDisponibles").value) ||
              0,
          };

          // ✅ Agregar áreas seleccionadas
          const checkboxes = document.querySelectorAll(
            "#edit-checkbox-areas input[name='areas']:checked"
          );
          const areasSeleccionadas = Array.from(checkboxes).map((cb) =>
            parseInt(cb.value)
          );
          empleadoData.areas = areasSeleccionadas;

          fetch(`/api/empleado/${empleadoData.idUsuario}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(empleadoData),
          })
            .then((res) => {
              if (!res.ok) throw new Error("Error al actualizar el empleado");
              return res.json();
            })
            .then((data) => {
              alert(data.mensaje);
              cerrarModalEditarEmpleado();
              location.reload();
            })
            .catch((err) => {
              console.error("Error:", err);
              alert("Hubo un error al actualizar: " + err.message);
            });
        });

      // Campos disponibles para exportación
      const camposExportacion = [
        { id: "idUsuario", nombre: "ID Usuario" },
        { id: "TipoRol", nombre: "Tipo de Rol" },
        { id: "Areas", nombre: "Área" },
        { id: "Nombres", nombre: "Nombres" },
        { id: "Paterno", nombre: "Apellido Paterno" },
        { id: "Materno", nombre: "Apellido Materno" },
        { id: "FechaNacimiento", nombre: "Fecha Nacimiento" },
        { id: "Direccion", nombre: "Dirección" },
        { id: "CodigoPostal", nombre: "Código Postal" },
        { id: "Correo", nombre: "Correo Electrónico" },
        { id: "NSS", nombre: "Número de Seguro Social" },
        { id: "Telefono", nombre: "Teléfono" },
        { id: "FechaIngreso", nombre: "Fecha Ingreso" },
        { id: "RFC", nombre: "RFC" },
        { id: "Curp", nombre: "CURP" },
        { id: "Puesto", nombre: "Puesto" },
        { id: "NombreContactoEmergencia", nombre: "Contacto Emergencia" },
        { id: "TelefonoEmergencia", nombre: "Teléfono Emergencia" },
        { id: "Parentesco", nombre: "Parentesco" },
        { id: "FechaBaja", nombre: "Fecha Baja" },
        { id: "ComentarioSalida", nombre: "Comentario Salida" },
        { id: "Estado", nombre: "Estado" },
        { id: "SueldoDiario", nombre: "Sueldo Diario" },
        { id: "SueldoSemanal", nombre: "Sueldo Semanal" },
        { id: "BonoSemanal", nombre: "Bono Semanal" },
        { id: "Vacaciones", nombre: "Vacaciones" },
        { id: "DiasDisponibles", nombre: "Dias Disponibles" },
      ];

      let camposSeleccionados = [];
      let empleadosSeleccionados = [];

      function abrirModalExportarExcel() {
        document
          .getElementById("export-excel-modal")
          .classList.remove("hidden");
        mostrarPasoCampos();
        document.body.classList.add("no-scroll");
      }

function mostrarPasoEmpleados() {
  // Guardar campos seleccionados
  const checkboxes = document.querySelectorAll(
    '#export-fields-container input[type="checkbox"]:checked'
  );
  camposSeleccionados = Array.from(checkboxes).map((cb) => cb.value);

  if (camposSeleccionados.length === 0) {
    // Mejoramos el alert con un modal más profesional
    Swal.fire({
      icon: 'warning',
      title: 'Campos requeridos',
      text: 'Por favor selecciona al menos un campo para exportar',
      confirmButtonColor: '#4dabf7'
    });
    return;
  }

  document.getElementById("paso-campos").classList.add("oculto");
  document.getElementById("paso-empleados").classList.add("visible");

  // Mostrar solo los empleados visibles actualmente
  const container = document.getElementById("export-employees-container");
  container.innerHTML = "";
  container.style.display = "grid";
  container.style.gridTemplateColumns = "repeat(auto-fill, minmax(250px, 1fr))";
  container.style.gap = "12px";
  container.style.padding = "16px";
  container.style.maxHeight = "400px";
  container.style.overflowY = "auto";

  if (empleadosVisibles.length === 0) {
    container.innerHTML = `
      <div style="
        grid-column: 1 / -1;
        text-align: center;
        padding: 20px;
        color: #6c757d;
        font-size: 16px;
      ">
        <i class="fas fa-users-slash" style="font-size: 24px; margin-bottom: 8px;"></i>
        <p>No hay empleados para exportar</p>
      </div>
    `;
    return;
  }

  // Añadir select all/none
  const selectAllDiv = document.createElement("div");
  selectAllDiv.style.gridColumn = "1 / -1";
  selectAllDiv.style.display = "flex";
  selectAllDiv.style.gap = "12px";
  selectAllDiv.style.marginBottom = "8px";
  
  const selectAllBtn = document.createElement("button");
  selectAllBtn.textContent = "Seleccionar todos";
  selectAllBtn.style.padding = "6px 12px";
  selectAllBtn.style.background = "#174da3";
  selectAllBtn.style.color = "white";
  selectAllBtn.style.border = "none";
  selectAllBtn.style.borderRadius = "4px";
  selectAllBtn.style.cursor = "pointer";
  
  const deselectAllBtn = document.createElement("button");
  deselectAllBtn.textContent = "Quitar todos";
  deselectAllBtn.style.padding = "6px 12px";
  deselectAllBtn.style.background = "#f1f3f5";
  deselectAllBtn.style.color = "#495057";
  deselectAllBtn.style.border = "1px solid #dee2e6";
  deselectAllBtn.style.borderRadius = "4px";
  deselectAllBtn.style.cursor = "pointer";
  
  selectAllBtn.onclick = () => {
    document.querySelectorAll('.empleado-checkbox').forEach(cb => cb.checked = true);
  };
  
  deselectAllBtn.onclick = () => {
    document.querySelectorAll('.empleado-checkbox').forEach(cb => cb.checked = false);
  };
  
  selectAllDiv.appendChild(selectAllBtn);
  selectAllDiv.appendChild(deselectAllBtn);
  container.appendChild(selectAllDiv);

  empleadosVisibles.forEach((emp) => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "12px";
    div.style.padding = "10px";
    div.style.borderRadius = "6px";
    div.style.backgroundColor = "#f8f9fa";
    div.style.transition = "all 0.2s ease";

    // Efecto hover
    div.onmouseenter = () => {
      div.style.backgroundColor = "#e9ecef";
    };
    div.onmouseleave = () => {
      div.style.backgroundColor = "#f8f9fa";
    };

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "empleado-checkbox";
    checkbox.value = emp.id;
    checkbox.checked = true;
    checkbox.style.width = "18px";
    checkbox.style.height = "18px";
    checkbox.style.cursor = "pointer";
    checkbox.style.accentColor = "#4dabf7";

    const label = document.createElement("label");
    label.textContent = `${emp.id} - ${emp.nombre}`;
    label.style.cursor = "pointer";
    label.style.fontSize = "14px";
    label.style.userSelect = "none";
    label.style.color = "#495057";
    label.style.flex = "1";
    label.style.overflow = "hidden";
    label.style.textOverflow = "ellipsis";
    label.style.whiteSpace = "nowrap";

    div.appendChild(checkbox);
    div.appendChild(label);
    container.appendChild(div);
  });

  // Añadir contador de seleccionados
  const counterDiv = document.createElement("div");
  counterDiv.style.gridColumn = "1 / -1";
  counterDiv.style.textAlign = "right";
  counterDiv.style.fontSize = "14px";
  counterDiv.style.color = "#6c757d";
  counterDiv.id = "employee-counter";
  container.appendChild(counterDiv);
  updateEmployeeCounter();

  // Actualizar contador cuando cambien los checkboxes
  container.addEventListener('change', updateEmployeeCounter);
  
  function updateEmployeeCounter() {
    const total = empleadosVisibles.length;
    const selected = document.querySelectorAll('.empleado-checkbox:checked').length;
    document.getElementById('employee-counter').textContent = 
      `${selected} de ${total} empleados seleccionados`;
  }
}

function mostrarPasoCampos() {
  document.getElementById("paso-empleados").classList.remove("visible");
  document.getElementById("paso-campos").classList.remove("oculto");

  const container = document.getElementById("export-fields-container");
  container.innerHTML = "";
  container.style.display = "grid";
  container.style.gridTemplateColumns = "repeat(auto-fill, minmax(200px, 1fr))";
  container.style.gap = "12px";
  container.style.padding = "12px";

  camposExportacion.forEach((campo) => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "10px";
    div.style.padding = "8px";
    div.style.borderRadius = "6px";
    div.style.backgroundColor = "#f8f9fa";
    div.style.transition = "all 0.2s ease";

    // Efecto hover
    div.onmouseenter = () => {
      div.style.backgroundColor = "#e9ecef";
      div.style.transform = "translateY(-2px)";
    };
    div.onmouseleave = () => {
      div.style.backgroundColor = "#f8f9fa";
      div.style.transform = "none";
    };

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = `export-${campo.id}`;
    checkbox.value = campo.id;
    checkbox.checked = true;
    checkbox.style.width = "18px";
    checkbox.style.height = "18px";
    checkbox.style.cursor = "pointer";
    checkbox.style.accentColor = "#4dabf7"; // Color azul moderno

    const label = document.createElement("label");
    label.htmlFor = `export-${campo.id}`;
    label.textContent = campo.nombre;
    label.style.cursor = "pointer";
    label.style.fontSize = "14px";
    label.style.userSelect = "none";
    label.style.color = "#495057";

    div.appendChild(checkbox);
    div.appendChild(label);
    container.appendChild(div);
  });
}



      function toggleSeleccionarTodos() {
        const checkboxes = document.querySelectorAll(
          '#export-employees-container input[type="checkbox"]'
        );
        const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

        checkboxes.forEach((checkbox) => {
          checkbox.checked = !allChecked;
        });
      }

 

      function cerrarModalExportarExcel() {
        document.getElementById("export-excel-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
        camposSeleccionados = [];
        empleadosSeleccionados = [];
      }

      function mostrarModalConfirmacion({
        texto,
        textoBotonConfirmar = "Confirmar",
        claseBotonConfirmar = "btn-danger",
        onConfirmar,
        onCancelar,
      }) {
        const modal = document.getElementById("modal-confirmacion");
        const modalTexto = document.getElementById("modal-texto");
        const btnConfirmar = document.getElementById("modal-confirmar");
        const btnCancelar = document.getElementById("modal-cancelar");

        modalTexto.textContent = texto;

        // Cambiar texto y clases del botón confirmar
        btnConfirmar.textContent = textoBotonConfirmar;
        btnConfirmar.className = "btn " + claseBotonConfirmar;

        modal.classList.remove("hidden");

        // Remover listeners previos
        btnConfirmar.onclick = null;
        btnCancelar.onclick = null;

        btnConfirmar.onclick = () => {
          if (typeof onConfirmar === "function") onConfirmar();
          modal.classList.add("hidden");
        };

        btnCancelar.onclick = () => {
          if (typeof onCancelar === "function") onCancelar();
          modal.classList.add("hidden");
        };
      }

      function mostrarModalExito() {
        const modal = document.getElementById("modal-exito");
        const btnCerrar = document.getElementById("btn-cerrar-exito");

        modal.classList.remove("hidden");

        btnCerrar.onclick = () => {
          modal.classList.add("hidden");
        };
      }

      function calcularDiasVacaciones(fechaIngreso) {
        const hoy = new Date();
        const ingreso = new Date(fechaIngreso);

        // Ajustar horas para evitar problemas de zona horaria
        hoy.setHours(0, 0, 0, 0);
        ingreso.setHours(0, 0, 0, 0);

        // Calcular diferencia exacta en años
        let años = hoy.getFullYear() - ingreso.getFullYear();
        const mesActual = hoy.getMonth();
        const diaActual = hoy.getDate();
        const mesIngreso = ingreso.getMonth();
        const diaIngreso = ingreso.getDate();

        // Ajustar si aún no cumple años en el año actual
        if (
          mesActual < mesIngreso ||
          (mesActual === mesIngreso && diaActual < diaIngreso)
        ) {
          años--;
        }

        // Tabla LFT
        if (años < 1) return 0; // Menos de 1 año: 0 días
        if (años === 1) return 12; // 1 año: 12 días
        if (años === 2) return 14; // 2 años: 14 días
        if (años === 3) return 16; // 3 años: 16 días
        if (años === 4) return 18; // ... y así sucesivamente
        if (años === 5) return 20;
        if (años >= 6 && años <= 10) return 22;
        if (años >= 11 && años <= 15) return 24;
        if (años >= 16 && años <= 20) return 26;
        if (años >= 21 && años <= 25) return 28;
        return 30; // 26+ años: 30 días
      }

      // Función para abrir el modal de días festivos
      function abrirModalAgregarFestivo() {
        document.getElementById("add-holiday-modal").classList.remove("hidden");
        document.body.classList.add("no-scroll");
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fechaFestivo").value = today;
      }

      // Función para cerrar el modal de días festivos
      function cerrarModalAgregarFestivo() {
        document.getElementById("add-holiday-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      // Función para abrir el modal de baja
      function abrirModalBajaEmpleado(idUsuario) {
        document.body.classList.add("no-scroll");
        fetch(`/api/empleado/${idUsuario}`)
          .then((res) => {
            if (!res.ok) throw new Error("No se encontró el empleado");
            return res.json();
          })
          .then((empleado) => {
            document.getElementById(
              "nombre-empleado-baja"
            ).textContent = `${empleado.Nombres} ${empleado.Paterno} ${empleado.Materno}`;
            document.getElementById("id-empleado-baja").textContent = idUsuario;
            document.getElementById("baja-idUsuario").value = idUsuario;

            document
              .getElementById("modal-baja-empleado")
              .classList.remove("hidden");
          })
          .catch((err) => {
            console.error("Error al cargar empleado:", err);
            alert("No se pudo abrir el modal de baja.");
          });
      }

      function cerrarModalBajaEmpleado() {
        document.getElementById("modal-baja-empleado").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      // Enviar solicitud de baja
      document
        .getElementById("form-baja-empleado")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const idUsuario = document.getElementById("baja-idUsuario").value;
          const fechaBaja = document.getElementById("baja-fecha").value;
          const comentarioSalida =
            document.getElementById("baja-comentario").value;

          if (!fechaBaja || !comentarioSalida) {
            alert("Todos los campos son obligatorios");
            return;
          }

          const body = {
            fechaBaja,
            comentarioSalida,
          };

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Procesando...";

          fetch(`/api/empleado/baja/${idUsuario}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          })
            .then(async (res) => {
              let data = null;
              try {
                data = await res.json();
              } catch (_) {}

              if (!res.ok || !data) {
                throw new Error(
                  data?.error || "Error al dar de baja al empleado"
                );
              }
              return data;
            })
            .then((data) => {
              alert("Empleado dado de baja correctamente.");
              cerrarModalBajaEmpleado();
              setTimeout(() => location.reload(), 1000);
            })
            .catch((err) => {
              console.error("Error al dar de baja:", err);
              alert("Hubo un error al procesar la baja: " + err.message);
            })
            .finally(() => {
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            });
        });

      document
        .getElementById("area-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const nombreArea = document.getElementById("nombreArea").value;

          fetch("/api/agregarArea", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ Area: nombreArea }),
          })
            .then((response) => {
              if (!response.ok) throw new Error("Error al guardar el área");
              return response.json();
            })
            .then((data) => {
              //alert("Área agregada correctamente");
              cerrarModalAgregarArea();
              document.getElementById("area-form").reset();
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error al guardar el área: " + error.message);
            });
        });

      function abrirModalAgregarArea() {
        document.getElementById("add-area-modal").classList.remove("hidden");
        document.body.classList.add("no-scroll");
      }

      function cerrarModalAgregarArea() {
        document.getElementById("add-area-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      // Enviar día festivo
      document
        .getElementById("holiday-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const fecha = document.getElementById("fechaFestivo").value;
          const descripcion =
            document.getElementById("descripcionFestivo").value;
          const anio = new Date(fecha).getFullYear();

          fetch("/api/diafestivo", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              fecha: fecha,
              descripcion: descripcion,
              anio: anio,
            }),
          })
            .then((response) => {
              if (!response.ok)
                throw new Error("Error al guardar el día festivo");
              return response.json();
            })
            .then((data) => {
              //alert("Día festivo agregado correctamente");
              cerrarModalAgregarFestivo();
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error al guardar el día festivo: " + error.message);
            });
        });
    </script>
  </body>
</html>
