<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal de Recursos Humanos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="icon" href="Media/favicon.ico" />

    
   
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src = "js/utils.js"></script>
  </head>

  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Arial", sans-serif;
}

body {
  background-color: #f5f5f5;
  color: #333;
}

header {
  background-color: #2c3e50;
  color: white;
  padding: 40px 0;
  height: 180px;
  display: flex;
  align-items: center;
}

.header-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  width: 100%;
  position: relative;
}

.logo {
  width: 50%;
  height: 25%;
  margin-bottom: 15px;
  max-height: 25%;
  max-width: 25%;
}

h1 {
  font-size: 28px;
  font-weight: 600;
  text-align: center;
}

.welcome-section {
  text-align: center;
  margin: 30px auto;
}

.welcome-message {
  font-size: 32px;
  color: #2c3e50;
  margin-bottom: 10px;
}

.content-wrapper {
  display: flex;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  gap: 30px;
}

.employee-table-container {
  flex: 7;
}

.employee-table-container h2 {
  margin-bottom: 15px;
  color: #2c3e50;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.employee-table {
  width: 100%;
  border-collapse: collapse;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.employee-table th,
.employee-table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.employee-table th {
  background-color: #2c3e50;
  color: white;
}

.options-container {
  flex: 2.5;
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

.option-button {
  position: relative;
  background-color: white;
  border: none;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 10px;
  height: 100px;
  text-align: center;
}

.option-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.option-button h2 {
  font-size: 14px;
  color: #2c3e50;
  margin-bottom: 4px;
}

.option-button p {
  color: #666;
  font-size: 12px;
}

.action-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  margin: 0 2px;
  padding: 3px;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background: white;
  padding: 25px 30px;
  width: 90%;
  max-width: 850px;
  border-radius: 12px;
  position: relative;
  animation: slideIn 0.3s ease;
  box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
}

.modal-content h2 {
  margin-bottom: 20px;
  color: #2c3e50;
  font-size: 24px;
  border-bottom: 2px solid #2c3e50;
  padding-bottom: 10px;
}

.area-item {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  border-bottom: 1px solid #eee;
  gap: 8px;
}

.area-item:last-child {
  border-bottom: none;
}

.area-checkbox {
  width: 18px;
  height: 18px;
  margin-right: 10px;
  accent-color: #2c3e50;
}

.area-label {
  flex: 1;
  min-width: 150px;
  font-size: 14px;
}

.modal-content span.close {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 30px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
  transition: color 0.3s ease;
}

.modal-content span.close:hover {
  color: #e74c3c;
}

.hidden {
  display: none;
}

#modal-body {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
  margin-top: 15px;
  align-items: start;
}

#modal-body p {
  background: #f9f9f9;
  padding: 10px 12px;
  border-left: 4px solid #2c3e50;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  font-size: 13px;
  line-height: 1.4;
  margin: 0;
  word-break: break-word;
}

#modal-body strong {
  display: block;
  font-weight: bold;
  margin-bottom: 3px;
  color: #2c3e50;
  font-size: 13px;
}

.add-employee-modal {
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
}

.add-employee-form {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 15px;
}

.form-group {
  margin-bottom: 10px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #2c3e50;
  font-size: 14px;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.form-group select {
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 15px;
}

.form-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.btn {
  padding: 8px 15px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-primary {
  background-color: #2c3e50;
  color: white;
  border: none;
}

.btn-primary:hover {
  background-color: #1a252f;
}

.btn-secondary {
  background-color: #f5f5f5;
  color: #333;
  border: 1px solid #ddd;
}

.btn-secondary:hover {
  background-color: #e0e0e0;
}

.add-employee-btn {
  background-color: #2c3e50;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.add-employee-btn:hover {
  background-color: #1a252f;
}

#export-fields-container {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
}

.fields-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 10px;
  margin-top: 20px;
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
}

.fields-grid div {
  padding: 8px;
  background: #d6d4d4;
  border-radius: 4px;
}

#paso-empleados {
  display: none;
}

#paso-empleados.visible {
  display: block;
}

#paso-campos.oculto {
  display: none;
}

.modal-confirmacion {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-confirmacion.hidden {
  display: none;
}

.modal-contenido {
  background: white;
  padding: 20px 30px;
  border-radius: 8px;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
}

.modal-botones {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}

textarea.estilo-textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
  resize: vertical;
  font-size: 14px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.btn-danger {
  background-color: #e74c3c;
  color: white;
}

.desplegable-container {
  border: 1px solid #ccc;
  border-top: none;
  border-radius: 0 0 6px 6px;
  background-color: #fff;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease;
}

.desplegable-container.abierto {
  max-height: 300px;
  overflow-y: auto;
}

.toggle-desplegable {
  background-color: white;
  color: #2c3e50;
  border: none;
  padding: 6px 12px;
  border-radius: 6px 6px 0 0;
  cursor: pointer;
  font-size: 14px;
  width: 100%;
  text-align: left;
}

.badge-notificacion {
  position: absolute;
  top: -10px;
  right: -10px;
  background-color: red;
  color: white;
  font-size: 12px;
  font-weight: bold;
  padding: 6px 9px;
  border-radius: 50%;
  z-index: 10;
}

a {
  color: black; /* hereda el color del padre */
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .content-wrapper {
    flex-direction: column;
  }

  .modal-content {
    padding: 20px;
    width: 95%;
  }

  #modal-body {
    grid-template-columns: 1fr;
  }
}

.back-button {
  position: absolute;
  left: 30px;
  top: 50%;
  transform: translateY(-50%);
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.back-button:hover {
  background-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-50%) scale(1.05);
}

.back-button i {
  font-size: 18px;
}

a{
  text-decoration: none;
}

/* üåü Mejora visual para campos del modal de ver empleado */
#modal-body p {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  border-left: 5px solid #2980b9;
  border-radius: 10px;
  padding: 12px 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  font-size: 14px;
  transition: transform 0.2s ease;
}

#modal-body p:hover {
  transform: scale(1.02);
}

#modal-body strong {
  color: #34495e;
  font-size: 14px;
}

.modal-content h2::after {
  content: "üë§";
  margin-left: 8px;
}

/* Estilo exclusivo para el modal de ver empleado */
#modal .modal-content {
  max-width: 1000px; /* Aumenta el ancho */
  max-height: 85vh;  /* Limita altura si es demasiado largo */
  overflow-y: auto;  /* Agrega scroll interno si se excede */
  padding: 30px 40px;
  border-left: 8px solid #2c3e50;
}

/* Mejora visual para que el modal no sature la vista */
#modal .modal-content::-webkit-scrollbar {
  width: 8px;
}

#modal .modal-content::-webkit-scrollbar-thumb {
  background-color: #aaa;
  border-radius: 4px;
}

.no-scroll {
  overflow: hidden;
}


  </style>
  <body>
    <header>
      <div class="header-container">
        <a href="#" class="back-button" onclick="logout()">
        <i class="bi bi-arrow-left"></i>
        Cerrar Sesi√≥n
      </a>
        <img src="Media/logo.png" alt="Logo" class="logo" />
        <h1>Portal De Recursos Humanos</h1>
      </div>
    </header>

    <div class="welcome-section">
      <div class="welcome-message">
        ¬°Hola <span id="employee-name">Juan P√©rez</span>!
      </div>
      <p>¬øQu√© deseas hacer hoy?</p>
    </div>

    <div class="content-wrapper">
      <div class="employee-table-container">
        <h2>
          Empleados Registrados
          <button class="add-employee-btn" onclick="abrirModalAltaEmpleado()">
            Agregar empleado +
          </button>

          <button
            class="add-employee-btn"
            onclick="abrirModalExportarExcel()"
            style="margin-left: 2px"
          >
            Exportar Excel +
          </button>
        </h2>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
          "
        >

        <select
            id="filtro-estado"
            style="
              padding: 8px 12px;
              border-radius: 6px;
              font-family: Arial, sans-serif;
              font-size: 1rem;
              border: 1.5px solid #bbb;
              background-color: #fff;
              cursor: pointer;
              outline: none;
              transition: border-color 0.3s ease;
              margin-right: 450px;
            "
          >
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
            <option value="todos">Todos</option>
          </select>
          <input
            type="text"
            id="busquedaEmpleado"
            oninput="buscarEmpleado()"
            placeholder="Buscar por ID o nombre"
            style="
              padding: 8px;
              width: 250px;
              margin-right: 8px;
              border-radius: 4px;
              border: 1px solid #ccc;
            "
          />
          <button
            onclick="buscarEmpleado()"
            style="
              background-color: #2c3e50;
              color: white;
              padding: 8px 12px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            <i class="bi bi-search"></i>
          </button>
        </div>

        <table class="employee-table">
          <thead>
            <tr>
              <th>N√∫mero</th>
              <th>Nombre</th>
              <th>Puesto</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="empleados-body"></tbody>
        </table>
      </div>
      <div class="options-container">
        <a
          href="permiso.html"
          class="option-button"
          onclick="localStorage.setItem('rolUsuario', 'rh')"
        >
          <i class="bi bi-clipboard-check"></i>
          <h2>Solicitar Permiso</h2>
          <p>Solicita un permiso por horas o d√≠as espec√≠ficos</p>
        </a>

        <a href="evaluarSoli.html" class="option-button">
          <span id="notificacion-solicitudes" class="badge-notificacion"
            >0</span
          >
          <i class="bi bi-search" style="font-size: 24px"></i>
          <h2>Solicitudes</h2>
          <p>Eval√∫a las solicitudes de tus empleados</p>
        </a>

        <a href="verSolicitudes.html" class="option-button">
          <i class="bi bi-search" style="font-size: 24px"></i>
          <h2>Ver Solicitudes</h2>
          <p>Mira el historial de las solicitudes evaluadas.</p>
        </a>

        <a href="incapacidad.html" class="option-button">
          <i class="bi bi-hospital" style="font-size: 24px"></i>
          <h2>Incapacidades</h2>
          <p>Autorizaciones</p>
        </a>

        <a href="verIncapacidades.html" class="option-button">
          <i class="bi bi-hospital" style="font-size: 24px"></i>
          <h2>Ver Incapacidades</h2>
          <p>Consulta que empleados est√°n en una incapacidad</p>
        </a>

        

        <a href="reporte.html" class="option-button">
          <i class="bi bi-bar-chart-line" style="font-size: 24px"></i>
          <h2>Reportes</h2>
          <p>Generar</p>
        </a>

        <a href="verReportes.html" class="option-button">
          <i class="bi bi-bar-chart-line" style="font-size: 24px"></i>
          <h2>Ver reportes</h2>
          <p>Visualiza los reportes generados</p>
        </a>

        <a href="vacante.html" class="option-button">
          <i class="bi bi-pin-map" style="font-size: 24px"></i>
          <h2>Vacante</h2>
          <p>Postula vacantes necesarias</p>
        </a>

        <a href="verVacantes.html" class="option-button">
          <i class="bi bi-pencil" style="font-size: 24px"></i>
          <h2>Ver Vacantes</h2>
          <p>Administra las vacantes solicitadas por tus compa√±eros</p>
        </a>
      </div>
    </div>

    <!-- Modal para ver detalles del empleado -->
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2>Detalle del Empleado</h2>
        <div id="modal-body"></div>
      </div>
    </div>

    <!-- Modal para dar de alta empleado -->
    <div id="add-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAltaEmpleado()">&times;</span>
        <h2>Dar de alta nuevo empleado</h2>
        <form id="employee-form" class="add-employee-form">
          <!-- Campo 1 -->
          <div class="form-group">
            <label for="idUsuario">ID Usuario:</label>
            <input type="number" id="idUsuario" name="idUsuario" required />
          </div>

          <!-- Campo 2 (Combobox) -->
          <div class="form-group">
            <label for="tipoRol">Tipo de Rol:</label>
            <select id="tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <div class="form-group">
            <label>√Åreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="toggle-areas"
              onclick="toggleAreas()"
            >
              Mostrar √Åreas ‚ñº
            </button>

            <div id="checkbox-areas" class="desplegable-container">
              <!-- Checkboxes se cargar√°n aqu√≠ -->
            </div>
            <small>Puedes seleccionar una o m√°s √°reas.</small>
          </div>

          <!-- Campo 4 -->
          <div class="form-group">
            <label for="nombres">Nombres:</label>
            <input type="text" id="nombres" name="nombres" required />
          </div>

          <!-- Campo 5 -->
          <div class="form-group">
            <label for="paterno">Apellido Paterno:</label>
            <input type="text" id="paterno" name="paterno" required />
          </div>

          <!-- Campo 6 -->
          <div class="form-group">
            <label for="materno">Apellido Materno:</label>
            <input type="text" id="materno" name="materno" />
          </div>

          <!-- Campo 7 -->
          <div class="form-group">
            <label for="fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Campo 8 -->
          <div class="form-group">
            <label for="direccion">Direcci√≥n:</label>
            <input type="text" id="direccion" name="direccion" required />
          </div>

          <!-- Campo 9 -->
          <div class="form-group">
            <label for="codigoPostal">C√≥digo Postal:</label>
            <input type="text" id="codigoPostal" name="codigoPostal" required />
          </div>

          <!-- Campo 10 -->
          <div class="form-group">
            <label for="correo">Correo Electr√≥nico:</label>
            <input type="email" id="correo" name="correo" required />
          </div>

          <!-- Campo 11 -->
          <div class="form-group">
            <label for="nss">N√∫mero de Seguro Social (NSS):</label>
            <input type="text" id="nss" name="nss" required />
          </div>

          <!-- Campo 12 -->
          <div class="form-group">
            <label for="telefono">Tel√©fono:</label>
            <input type="tel" id="telefono" name="telefono" required />
          </div>

          <!-- Campo 13 -->
          <div class="form-group">
            <label for="fechaIngreso">Fecha de Ingreso:</label>
            <input type="date" id="fechaIngreso" name="fechaIngreso" required />
          </div>

          <!-- Campo 14 -->
          <div class="form-group">
            <label for="rfc">RFC:</label>
            <input type="text" id="rfc" name="rfc" required />
          </div>

          <!-- Campo 15 -->
          <div class="form-group">
            <label for="curp">CURP:</label>
            <input type="text" id="curp" name="curp" required />
          </div>

          <!-- Campo 16 -->
          <div class="form-group">
            <label for="puesto">Puesto:</label>
            <input type="text" id="puesto" name="puesto" required />
          </div>

          <!-- Campo 17 -->
          <div class="form-group">
            <label for="nombreContactoEmergencia"
              >Beneficiario/Contacto Emergencia:</label
            >
            <input
              type="text"
              id="nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Campo 18 -->
          <div class="form-group">
            <label for="telefonoEmergencia">Tel√©fono Emergencia:</label>
            <input
              type="tel"
              id="telefonoEmergencia"
              name="telefonoEmergencia"
              required
            />
          </div>

          <!-- Campo 19 -->
          <div class="form-group">
            <label for="parentesco">Parentesco:</label>
            <input type="text" id="parentesco" name="parentesco" required />
          </div>

          <!-- Campo 20 -->
          <div class="form-group">
            <label for="contrase√±a">Contrase√±a:</label>
            <input type="password" id="contrase√±a" name="contrase√±a" required />
          </div>

          <!-- Campo 21 -->
          <div class="form-group">
            <label for="confirmarContrase√±a">Confirmar Contrase√±a:</label>
            <input
              type="password"
              id="confirmarContrase√±a"
              name="confirmarContrase√±a"
              required
            />
          </div>

          <!-- Campo Sueldo Diario -->
          <div class="form-group">
            <label for="sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="sueldoDiario"
              name="SueldoDiario"
              required
            />
          </div>

          <!-- Campo Sueldo Semanal -->
          <div class="form-group">
            <label for="sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="sueldoSemanal"
              name="SueldoSemanal"
              required
            />
          </div>

          <!-- Campo Bono Semanal -->
          <div class="form-group">
            <label for="bonoSemanal">Bono Semanal:</label>
            <input type="number" id="bonoSemanal" name="BonoSemanal" required />
          </div>

          <!-- Campo Vacaciones Disponibles -->
          <div class="form-group">
            <label for="vacacionesDisponibles">Vacaciones Disponibles:</label>
            <input
              type="number"
              id="diasDisponibles"
              name="diasDisponibles"
              required
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAltaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para editar empleado -->
    <div id="edit-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalEditarEmpleado()">&times;</span>
        <h2>Editar Empleado</h2>
        <form id="edit-employee-form" class="add-employee-form">
          <!-- ID -->
          <div class="form-group">
            <label for="edit-idUsuario">ID Usuario:</label>
            <input
              type="number"
              id="edit-idUsuario"
              name="idUsuario"
              readonly
            />
          </div>

          <!-- Rol -->
          <div class="form-group">
            <label for="edit-tipoRol">Tipo de Rol:</label>
            <select id="edit-tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <!-- √Åreas con toggle -->
          <div class="form-group">
            <label>√Åreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="edit-toggle-areas"
              onclick="toggleAreas('edit')"
            >
              Mostrar √Åreas ‚ñº
            </button>
            <div id="edit-checkbox-areas" class="desplegable-container">
              <!-- checkboxes se insertan din√°micamente -->
            </div>
            <small>Puedes seleccionar una o m√°s √°reas.</small>
          </div>

          <!-- Nombres -->
          <div class="form-group">
            <label for="edit-nombres">Nombres:</label>
            <input type="text" id="edit-nombres" name="nombres" required />
          </div>

          <!-- Paterno -->
          <div class="form-group">
            <label for="edit-paterno">Apellido Paterno:</label>
            <input type="text" id="edit-paterno" name="paterno" required />
          </div>

          <!-- Materno -->
          <div class="form-group">
            <label for="edit-materno">Apellido Materno:</label>
            <input type="text" id="edit-materno" name="materno" />
          </div>

          <!-- Fecha de Nacimiento -->
          <div class="form-group">
            <label for="edit-fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="edit-fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Direcci√≥n -->
          <div class="form-group">
            <label for="edit-direccion">Direcci√≥n:</label>
            <input type="text" id="edit-direccion" name="direccion" required />
          </div>

          <!-- C√≥digo Postal -->
          <div class="form-group">
            <label for="edit-codigoPostal">C√≥digo Postal:</label>
            <input
              type="text"
              id="edit-codigoPostal"
              name="codigoPostal"
              required
            />
          </div>

          <!-- Correo -->
          <div class="form-group">
            <label for="edit-correo">Correo Electr√≥nico:</label>
            <input type="email" id="edit-correo" name="correo" required />
          </div>

          <!-- NSS -->
          <div class="form-group">
            <label for="edit-nss">N√∫mero de Seguro Social (NSS):</label>
            <input type="text" id="edit-nss" name="nss" required />
          </div>

          <!-- Tel√©fono -->
          <div class="form-group">
            <label for="edit-telefono">Tel√©fono:</label>
            <input type="tel" id="edit-telefono" name="telefono" required />
          </div>

          <!-- Fecha de Ingreso -->
          <div class="form-group">
            <label for="edit-fechaIngreso">Fecha de Ingreso:</label>
            <input
              type="date"
              id="edit-fechaIngreso"
              name="fechaIngreso"
              required
            />
          </div>

          <!-- RFC -->
          <div class="form-group">
            <label for="edit-rfc">RFC:</label>
            <input type="text" id="edit-rfc" name="rfc" required />
          </div>

          <!-- CURP -->
          <div class="form-group">
            <label for="edit-curp">CURP:</label>
            <input type="text" id="edit-curp" name="curp" required />
          </div>

          <!-- Puesto -->
          <div class="form-group">
            <label for="edit-puesto">Puesto:</label>
            <input type="text" id="edit-puesto" name="puesto" required />
          </div>

          <!-- Contacto de Emergencia -->
          <div class="form-group">
            <label for="edit-nombreContactoEmergencia"
              >Nombre Contacto Emergencia:</label
            >
            <input
              type="text"
              id="edit-nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Tel√©fono Emergencia -->
          <div class="form-group">
            <label for="edit-telefonoEmergencia">Tel√©fono Emergencia:</label>
            <input
              type="tel"
              id="edit-telefonoEmergencia"
              name="telefonoEmergencia"
              required
            />
          </div>

          <!-- Parentesco -->
          <div class="form-group">
            <label for="edit-parentesco">Parentesco:</label>
            <input
              type="text"
              id="edit-parentesco"
              name="parentesco"
              required
            />
          </div>

          <!-- Contrase√±a -->
          <div class="form-group">
            <label for="edit-contrase√±a">Contrase√±a:</label>
            <input
              type="password"
              id="edit-contrase√±a"
              name="contrase√±a"
              required
            />
          </div>

          <!-- Confirmar Contrase√±a -->
          <div class="form-group">
            <label for="edit-confirmarContrase√±a">Confirmar Contrase√±a:</label>
            <input
              type="password"
              id="edit-confirmarContrase√±a"
              name="confirmarContrase√±a"
              required
            />
          </div>

          <!-- Sueldo Diario -->
          <div class="form-group">
            <label for="edit-sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="edit-sueldoDiario"
              name="SueldoDiario"
              required
            />
          </div>

          <!-- Sueldo Semanal -->
          <div class="form-group">
            <label for="edit-sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="edit-sueldoSemanal"
              name="SueldoSemanal"
              required
            />
          </div>

          <!-- Bono Semanal -->
          <div class="form-group">
            <label for="edit-bonoSemanal">Bono Semanal:</label>
            <input
              type="number"
              id="edit-bonoSemanal"
              name="BonoSemanal"
              required
            />
          </div>

          <!-- Fecha de Baja -->
          <div class="form-group">
            <label for="edit-fechaBaja">Fecha de Baja:</label>
            <input type="date" id="edit-fechaBaja" name="fechaBaja" />
          </div>

          <!-- Comentario de Salida -->
          <div class="form-group">
            <label for="edit-comentarioSalida">Comentario de Salida:</label>
            <input
              type="text"
              id="edit-comentarioSalida"
              name="comentarioSalida"
            />
          </div>

          <!-- Vacaciones -->
          <div class="form-group">
            <label for="edit-vacaciones">Vacaciones:</label>
            <input type="number" id="edit-vacaciones" name="Vacaciones" />
          </div>

          <!-- Vacaciones Disponibles -->
          <div class="form-group">
            <label for="edit-diasDisponibles">Vacaciones disponibles:</label>
            <input
              type="text"
              id="edit-diasDisponibles"
              name="diasDisponibles"
            />
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalEditarEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Actualizar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar d√≠a festivo -->
    <div id="add-holiday-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarFestivo()">&times;</span>
        <h2>Agregar D√≠a Festivo</h2>
        <form id="holiday-form" class="add-employee-form">
          <!-- Campo Fecha -->
          <div class="form-group">
            <label for="fechaFestivo">Fecha:</label>
            <input type="date" id="fechaFestivo" name="fechaFestivo" required />
          </div>

          <!-- Campo Descripci√≥n -->
          <div class="form-group">
            <label for="descripcionFestivo">Descripci√≥n:</label>
            <input
              type="text"
              id="descripcionFestivo"
              name="descripcionFestivo"
              required
              placeholder="Ej. D√≠a de la Independencia"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarFestivo()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Agregar Festivo
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para exportar a Excel (actualizado) -->
    <div id="export-excel-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalExportarExcel()">&times;</span>

        <!-- Paso 1: Selecci√≥n de campos -->
        <div id="paso-campos">
          <h2>Exportar datos (1/2)</h2>
          <p>Selecciona los campos que deseas incluir en el reporte:</p>
          <div id="export-fields-container" class="fields-grid"></div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalExportarExcel()"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="mostrarPasoEmpleados()"
            >
              Siguiente
            </button>
          </div>
        </div>

        <!-- Paso 2: Selecci√≥n de empleados -->
        <div id="paso-empleados" class="hidden">
          <h2>Exportar datos (2/2)</h2>
          <p>Selecciona los empleados a incluir en el reporte:</p>
          <div style="margin-bottom: 10px">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="toggleSeleccionarTodos()"
            >
              <i class="bi bi-check-all"></i> Seleccionar todos
            </button>
          </div>
          <div id="export-employees-container" class="fields-grid"></div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="mostrarPasoCampos()"
            >
              Anterior
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportarExcel()"
            >
              Generar Excel
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-confirmacion" class="modal-confirmacion hidden">
      <div class="modal-contenido">
        <p id="modal-texto">¬øQuieres eliminar este empleado?</p>
        <div class="modal-botones">
          <button id="modal-cancelar" class="btn">Cancelar</button>
          <button id="modal-confirmar" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </div>

    <div id="modal-exito" class="modal-exito hidden">
      <div class="modal-contenido-exito">
        <p>Actualizaci√≥n correcta</p>
        <button id="btn-cerrar-exito" class="btn btn-primary">Aceptar</button>
      </div>
    </div>

    <div id="modal-baja-empleado" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModalBajaEmpleado()">&times;</span>
        <h2>Dar de Baja Empleado</h2>

        <div style="margin-bottom: 15px">
          <p>
            Empleado: <strong id="nombre-empleado-baja"></strong> <br /><br />
          </p>
          <p>ID: <strong id="id-empleado-baja"></strong></p>
        </div>

        <form id="form-baja-empleado">
          <input type="hidden" id="baja-idUsuario" />

          <div class="form-group">
            <label for="baja-fecha">Fecha de Baja:</label>
            <input type="date" id="baja-fecha" name="fechaBaja" required />
          </div>

          <div class="form-group">
            <label for="baja-comentario">Motivo de la baja:</label>
            <textarea
              id="baja-comentario"
              name="comentarioSalida"
              rows="4"
              required
              class="estilo-textarea"
            ></textarea>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalBajaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-danger">Confirmar Baja</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      function toggleAreas(context = "") {
  const prefix = context ? context + "-" : "";

  const contenedor = document.getElementById(`${prefix}checkbox-areas`);
  const boton = document.getElementById(`${prefix}toggle-areas`);

  if (!contenedor || !boton) return;

  if (contenedor.classList.contains("abierto")) {
    contenedor.classList.remove("abierto");
    boton.textContent = "Mostrar √Åreas ‚ñº";
  } else {
    contenedor.classList.add("abierto");
    boton.textContent = "Ocultar √Åreas ‚ñ≤";
  }
}

// Verificar si el usuario est√° logueado
function verificarSesion() {
  const idUsuario = localStorage.getItem("idUsuario");
  if (!idUsuario) {
    window.location.href = "index.html"; // Redirigir al login si no hay sesi√≥n
  }
  return idUsuario;
}

// Funci√≥n para cargar notificaciones
async function cargarNotificaciones() {
  try {
    const idUsuario = localStorage.getItem("idUsuario");

    if (!idUsuario) {
      console.error("No se encontr√≥ idUsuario en localStorage");
      return;
    }

    const response = await fetch(`/api/totalSolicitudes/${idUsuario}`);

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    console.log("Datos de notificaciones:", data); // Debug visible

    const badge = document.getElementById("notificacion-solicitudes");
    if (!badge) {
      console.warn("Elemento badge no encontrado");
      return;
    }

    if (data.total > 0) {
      badge.textContent = data.total;
      badge.style.display = "inline-block";
    } else {
      badge.style.display = "none";
    }
  } catch (error) {
    console.error("Error al cargar notificaciones:", error);
    // Opcional: mostrar mensaje al usuario
  }
}

// Uso en tu p√°gina:
document.addEventListener("DOMContentLoaded", function () {
  // Verificar sesi√≥n y obtener ID de usuario
  // Verificar si el usuario NO est√° logueado
if (!localStorage.getItem('idUsuario')) {
    window.location.href = 'index.html';
}
  const idUsuario = verificarSesion();

  cargarNotificaciones();
  setInterval(cargarNotificaciones, 1200000);

  // Cargar datos del usuario
  if (idUsuario) {
    cargarNombreUsuario(idUsuario);

    // Cargar lista de empleados
    fetch("/api/empleados")
      .then((response) => response.json())
      .then((data) => {
        const tbody = document.getElementById("empleados-body");
        tbody.innerHTML = "";
        data.forEach((emp) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                        <td>${emp.id}</td>
                        <td>${emp.nombre}</td>
                        <td>${emp.puesto}</td>
                        <td>
                            <button class="action-btn" onclick="verEmpleado(${emp.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="action-btn" onclick="editarEmpleado(${emp.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            
                        </td>
                    `;
          tbody.appendChild(row);
        });
      })
      .catch((error) => {
        console.error("Error al cargar empleados:", error);
      });
  }
});

function cargarNombreUsuario(idUsuario) {
  fetch("/api/usuario/nombre", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ idUsuario: idUsuario }),
  })
    .then((response) => {
      if (!response.ok) {
        throw new Error("Error al obtener el nombre del usuario");
      }
      return response.json();
    })
    .then((data) => {
      if (data.error) {
        console.error(data.error);
        document.getElementById("employee-name").textContent = "Administrador";
      } else {
        // Formatear el nombre completo manejando casos donde falte materno
        let nombreCompleto = data.nombres || "";
        if (data.paterno) nombreCompleto += ` ${data.paterno}`;
        if (data.materno) nombreCompleto += ` ${data.materno}`;

        document.getElementById("employee-name").textContent =
          nombreCompleto.trim() || "Administrador";
      }
    })
    .catch((error) => {
      console.error("Error al cargar nombre:", error);
      document.getElementById("employee-name").textContent = "Administrador";
    });
}

// Cargar lista de empleados
fetch("/api/empleados")
  .then((response) => response.json())
  .then((data) => {
    const tbody = document.getElementById("empleados-body");
    tbody.innerHTML = "";
    data.forEach((emp) => {
      const row = document.createElement("tr");
      row.innerHTML = `
          <td>${emp.id}</td>
          <td>${emp.nombre}</td>
          <td>${emp.puesto}</td>
          <td>
            <button class="action-btn" onclick="verEmpleado(${emp.id})">
  <i class="bi bi-eye"></i>
</button>
<button class="action-btn" onclick="editarEmpleado(${emp.id})">
  <i class="bi bi-pencil"></i>
</button>
<button class="action-btn" onclick="abrirModalBajaEmpleado(${emp.id})">
  <i class="bi bi-trash"></i>
</button>

          </td>
        `;
      tbody.appendChild(row);
    });
  })
  .catch((error) => {
    console.error("Error al cargar empleados:", error);
  });

function verEmpleado(id) {
  document.body.classList.add("no-scroll");
  fetch(`/api/empleado/${id}`)
    .then((res) => {
      if (!res.ok) throw new Error("Error al cargar datos del empleado");
      return res.json();
    })
    .then((data) => {
      const modalBody = document.getElementById("modal-body");

      const renderField = (label, value) => {
        const texto =
          value === null ||
          value === undefined ||
          value === "" ||
          value === "null"
            ? "Sin informaci√≥n"
            : value;
        return `<p><strong>${label}:</strong> ${texto}</p>`;
      };

      // Construir una cadena de texto con todas las √°reas
      const areasTexto =
        data.Areas && data.Areas.length > 0
          ? data.Areas.map((area) => area.NombreArea).join(", ")
          : "Sin informaci√≥n";

      modalBody.innerHTML = `
        ${renderField("ID", data.idUsuario)}
        ${renderField("Rol", data.TipoRol)}
        ${renderField("√Åreas", areasTexto)}
        ${renderField(
          "Nombre Completo",
          `${data.Nombres} ${data.Paterno} ${data.Materno}`
        )}
        ${renderField("Fecha Nacimiento", data.FechaNacimiento)}
        ${renderField("Direcci√≥n", data.Direccion)}
        ${renderField("C√≥digo Postal", data.CodigoPostal)}
        ${renderField("Correo", data.Correo)}
        ${renderField("NSS", data.NSS)}
        ${renderField("Tel√©fono", data.Telefono)}
        ${renderField("Fecha Ingreso", data.FechaIngreso)}
        ${renderField("RFC", data.RFC)}
        ${renderField("CURP", data.Curp)}
        ${renderField("Puesto", data.Puesto)}
        ${renderField("Contacto Emergencia", data.NombreContactoEmergencia)}
        ${renderField("Tel√©fono Emergencia", data.TelefonoEmergencia)}
        ${renderField("Parentesco", data.Parentesco)}
        ${renderField("Fecha Baja", data.FechaBaja)}
        ${renderField("Comentario Salida", data.ComentarioSalida)}
        ${renderField("Clave", data.clave)}
        ${renderField("Estado", data.Estado)}
        ${renderField("Sueldo Diario", data.SueldoDiario)}
        ${renderField("Sueldo Semanal", data.SueldoSemanal)}
        ${renderField("Bono Semanal", data.BonoSemanal)}
        ${renderField("Vacaciones", data.Vacaciones)}
        ${renderField("Vacaciones disponibles", data.DiasDisponibles)}
      `;

      document.getElementById("modal").classList.remove("hidden");
    })
    .catch((error) => {
      console.error("Error:", error);
      alert("Error al cargar los datos del empleado");
    });
}

function cerrarModal() {
  document.getElementById("modal").classList.add("hidden");
  document.body.classList.remove("no-scroll");
}

function abrirModalAltaEmpleado() {
  // Mostrar el modal
  document.getElementById("add-employee-modal").classList.remove("hidden");
  document.body.classList.add("no-scroll");

  // Llenar roles
  fetch("/api/roles")
    .then((res) => res.json())
    .then((data) => {
      const selectRol = document.getElementById("tipoRol");
      selectRol.innerHTML = '<option value="">Seleccione un rol</option>';
      data.forEach((rol) => {
        const option = document.createElement("option");
        option.value = rol.idRol;
        option.textContent = rol.TipoRol;
        selectRol.appendChild(option);
      });
    });

  // Llenar √°reas como checkboxes
  fetch("/api/areas")
    .then((res) => res.json())
    .then((data) => {
      const container = document.getElementById("checkbox-areas");
      container.innerHTML = "";

      data.forEach((area) => {
        const item = document.createElement("div");
        item.className = "area-item";

        const label = document.createElement("label");
        label.textContent = area.NombreArea;
        label.className = "area-label";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "areas";
        checkbox.value = area.idArea;
        checkbox.className = "area-checkbox";

        item.appendChild(label);
        item.appendChild(checkbox);
        container.appendChild(item);
      });
    });
}

function cargarAreasParaEditar(idUsuario, areasSeleccionadas) {
  fetch("/api/areas")
    .then((res) => res.json())
    .then((areas) => {
      const container = document.getElementById("edit-checkbox-areas");
      container.innerHTML = "";

      areas.forEach((area) => {
        const wrapper = document.createElement("div");
        wrapper.className = "area-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "areas";
        checkbox.value = area.idArea;
        checkbox.id = `area-${area.idArea}`;
        checkbox.checked = areasSeleccionadas.includes(area.idArea);
        checkbox.className = "area-checkbox";

        const label = document.createElement("label");
        label.htmlFor = checkbox.id;
        label.className = "area-label";
        label.textContent = area.NombreArea;

        wrapper.appendChild(label);
        wrapper.appendChild(checkbox);

        container.appendChild(wrapper);
      });
    });
}

function cerrarModalAltaEmpleado() {
  document.getElementById("add-employee-modal").classList.add("hidden");
  document.body.classList.remove("no-scroll");
}

//Dar de alta a empleado
document
  .getElementById("employee-form")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    const fechaIngreso = document.getElementById("fechaIngreso").value;
    const diasVacaciones = calcularDiasVacaciones(fechaIngreso);

    const contrase√±a = document.getElementById("contrase√±a").value;
    const confirmarContrase√±a = document.getElementById(
      "confirmarContrase√±a"
    ).value;

    if (contrase√±a !== confirmarContrase√±a) {
      alert("Las contrase√±as no coinciden");
      return;
    }

    const formData = new FormData(this);
    const empleadoData = {};

    formData.forEach((value, key) => {
      empleadoData[key] = value;
    });

    // Obtener las √°reas seleccionadas (checkboxes)
    const areasSeleccionadas = Array.from(
      document.querySelectorAll('input[name="areas"]:checked')
    ).map((cb) => parseInt(cb.value));

    if (areasSeleccionadas.length === 0) {
      alert("Debes seleccionar al menos un √°rea.");
      return;
    }

    empleadoData.areas = areasSeleccionadas;

    // Mapear y limpiar campos adicionales
    empleadoData.rol_id = empleadoData.tipoRol;
    delete empleadoData.tipoRol;
    delete empleadoData.nombreArea; // ‚Üê ya no se usa

    // Agregar d√≠as de vacaciones
    empleadoData.Vacaciones = diasVacaciones;

    // Convertir a n√∫mero
    empleadoData.idUsuario = Number(empleadoData.idUsuario);
    empleadoData.nss = Number(empleadoData.nss);
    empleadoData.telefono = Number(empleadoData.telefono);
    empleadoData.telefonoEmergencia = Number(empleadoData.telefonoEmergencia);
    empleadoData.SueldoDiario = Number(empleadoData.SueldoDiario);
    empleadoData.SueldoSemanal = Number(empleadoData.SueldoSemanal);
    empleadoData.BonoSemanal = Number(empleadoData.BonoSemanal);
    empleadoData.Vacaciones = Number(empleadoData.Vacaciones);
    empleadoData.diasDisponibles = Number(empleadoData.diasDisponibles);

    // Validaciones finales
    if (
      isNaN(empleadoData.idUsuario) ||
      isNaN(empleadoData.nss) ||
      isNaN(empleadoData.telefono) ||
      isNaN(empleadoData.telefonoEmergencia) ||
      isNaN(empleadoData.SueldoDiario) ||
      isNaN(empleadoData.SueldoSemanal) ||
      isNaN(empleadoData.BonoSemanal)
    ) {
      alert(
        "Por favor, ingresa valores num√©ricos v√°lidos en los campos requeridos."
      );
      return;
    }

    // Enviar al backend
    fetch("/api/empleado", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(empleadoData),
    })
      .then((res) => {
        if (!res.ok)
          return res.json().then((data) => {
            throw new Error(data.error || "Error al guardar el empleado");
          });
        return res.json();
      })
      .then((data) => {
        alert(data.mensaje);
        cerrarModalAltaEmpleado();
        location.reload(); // o actualiza tabla sin recargar
      })
      .catch((error) => {
        console.error("Error al insertar:", error);
        alert("Hubo un error al guardar el empleado: " + error.message);
      });
  });

// Alternativa para manejar zona horaria
function formatoFechaParaInput(fecha) {
  if (!fecha) return "";

  // Si ya est√° en formato YYYY-MM-DD
  if (typeof fecha === "string" && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return fecha;
  }

  // Parsear fecha y ajustar por zona horaria
  const date = new Date(fecha);
  const offset = date.getTimezoneOffset();
  date.setMinutes(date.getMinutes() + offset);

  return date.toISOString().split("T")[0];
}

function editarEmpleado(id) {
  document.body.classList.add("no-scroll");
  document.getElementById("edit-employee-modal").classList.remove("hidden");

  fetch(`/api/empleado/${id}`)
    .then((res) => {
      if (!res.ok) throw new Error("Error al obtener datos del empleado");
      return res.json();
    })
    .then((data) => {
      Promise.all([
        fetch("/api/roles").then((res) => res.json()),
        fetch("/api/areas").then((res) => res.json()),
      ]).then(([roles, areas]) => {
        const selectRol = document.getElementById("edit-tipoRol");

        // Llenar roles
        selectRol.innerHTML = '<option value="">Seleccione un rol</option>';
        roles.forEach((rol) => {
          const option = document.createElement("option");
          option.value = rol.idRol;
          option.textContent = rol.TipoRol;
          selectRol.appendChild(option);
        });

        // Llenar campos del formulario
        document.getElementById("edit-idUsuario").value = data.idUsuario || "";
        document.getElementById("edit-tipoRol").value = data.Rol_idRol || "";
        document.getElementById("edit-nombres").value = data.Nombres || "";
        document.getElementById("edit-paterno").value = data.Paterno || "";
        document.getElementById("edit-materno").value = data.Materno || "";
        document.getElementById("edit-fechaNacimiento").value =
          formatoFechaParaInput(data.FechaNacimiento);
        document.getElementById("edit-direccion").value = data.Direccion || "";
        document.getElementById("edit-codigoPostal").value =
          data.CodigoPostal || "";
        document.getElementById("edit-correo").value = data.Correo || "";
        document.getElementById("edit-nss").value = data.NSS || "";
        document.getElementById("edit-telefono").value = data.Telefono || "";
        document.getElementById("edit-rfc").value = data.RFC || "";
        document.getElementById("edit-curp").value = data.Curp || "";
        document.getElementById("edit-puesto").value = data.Puesto || "";
        document.getElementById("edit-nombreContactoEmergencia").value =
          data.NombreContactoEmergencia || "";
        document.getElementById("edit-telefonoEmergencia").value =
          data.TelefonoEmergencia || "";
        document.getElementById("edit-parentesco").value =
          data.Parentesco || "";
        document.getElementById("edit-contrase√±a").value = data.clave || "";
        document.getElementById("edit-confirmarContrase√±a").value =
          data.clave || "";
        document.getElementById("edit-sueldoDiario").value =
          data.SueldoDiario || "";
        document.getElementById("edit-sueldoSemanal").value =
          data.SueldoSemanal || "";
        document.getElementById("edit-bonoSemanal").value =
          data.BonoSemanal || "";
        document.getElementById("edit-fechaBaja").value = formatoFechaParaInput(
          data.FechaBaja
        );
        document.getElementById("edit-comentarioSalida").value =
          data.ComentarioSalida || "";

        const fechaIngresoInput = document.getElementById("edit-fechaIngreso");
        fechaIngresoInput.value = formatoFechaParaInput(data.FechaIngreso);

        const campoVacaciones = document.getElementById("edit-vacaciones");
        campoVacaciones.value =
          data.Vacaciones != null
            ? data.Vacaciones
            : calcularDiasVacaciones(fechaIngresoInput.value);

        document.getElementById("edit-diasDisponibles").value =
          data.DiasDisponibles || 0;

        // ‚úÖ Cargar √°reas como checkboxes
        const idsDeAreas = (data.Areas || []).map((area) => area.idArea);
        cargarAreasParaEditar(data.idUsuario, idsDeAreas);

        // Recalcular vacaciones si cambia la fecha de ingreso
        fechaIngresoInput.addEventListener("change", function () {
          const nuevaFecha = this.value;
          const dias = calcularDiasVacaciones(nuevaFecha);
          document.getElementById("edit-vacaciones").value = dias;
        });
      });
    })
    .catch((error) => {
      console.error("Error al cargar datos del empleado:", error);
      alert("No se pudieron cargar los datos del empleado.");
    });
}

function cerrarModalEditarEmpleado() {
  document.getElementById("edit-employee-modal").classList.add("hidden");
  document.body.classList.remove("no-scroll");
}

function buscarEmpleado() {
  const termino = document
    .getElementById("busquedaEmpleado")
    .value.toLowerCase();

  fetch("/api/empleados")
    .then((res) => res.json())
    .then((empleados) => {
      const resultados = empleados.filter(
        (emp) =>
          emp.id.toString().includes(termino) ||
          emp.nombre.toLowerCase().includes(termino)
      );

      const tbody = document.getElementById("empleados-body");
      tbody.innerHTML = "";

      if (resultados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">No se encontraron empleados</td></tr>`;
      } else {
        resultados.forEach((emp) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${emp.id}</td>
            <td>${emp.nombre}</td>
            <td>${emp.puesto}</td>
            <td>
              <button class="action-btn" onclick="verEmpleado(${emp.id})">
                <i class="bi bi-eye"></i>
              </button>
              <button class="action-btn" onclick="editarEmpleado(${emp.id})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="action-btn" onclick="abrirModalBajaEmpleado(${emp.id})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    })
    .catch((error) => {
      console.error("Error en b√∫squeda:", error);
    });
}

document
  .getElementById("edit-employee-form")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    const contrase√±a = document.getElementById("edit-contrase√±a").value;
    const confirmar = document.getElementById("edit-confirmarContrase√±a").value;

    if (contrase√±a !== confirmar) {
      alert("Las contrase√±as no coinciden");
      return;
    }

    const empleadoData = {
      idUsuario: Number(document.getElementById("edit-idUsuario").value),
      rol_id: document.getElementById("edit-tipoRol").value,
      nombres: document.getElementById("edit-nombres").value,
      paterno: document.getElementById("edit-paterno").value,
      materno: document.getElementById("edit-materno").value,
      fechaNacimiento: document.getElementById("edit-fechaNacimiento").value,
      direccion: document.getElementById("edit-direccion").value,
      codigoPostal: document.getElementById("edit-codigoPostal").value,
      correo: document.getElementById("edit-correo").value,
      nss: Number(document.getElementById("edit-nss").value),
      telefono: Number(document.getElementById("edit-telefono").value),
      fechaIngreso: document.getElementById("edit-fechaIngreso").value,
      rfc: document.getElementById("edit-rfc").value,
      curp: document.getElementById("edit-curp").value,
      puesto: document.getElementById("edit-puesto").value,
      nombreContactoEmergencia: document.getElementById(
        "edit-nombreContactoEmergencia"
      ).value,
      telefonoEmergencia: Number(
        document.getElementById("edit-telefonoEmergencia").value
      ),
      parentesco: document.getElementById("edit-parentesco").value,
      contrase√±a: contrase√±a,
      SueldoDiario: Number(document.getElementById("edit-sueldoDiario").value),
      SueldoSemanal: Number(
        document.getElementById("edit-sueldoSemanal").value
      ),
      BonoSemanal: Number(document.getElementById("edit-bonoSemanal").value),
      fechaBaja: document.getElementById("edit-fechaBaja").value || null,
      comentarioSalida:
        document.getElementById("edit-comentarioSalida").value || null,
      Vacaciones: Number(document.getElementById("edit-vacaciones").value) || 0,
      diasDisponibles:
        Number(document.getElementById("edit-diasDisponibles").value) || 0,
    };

    // ‚úÖ Agregar √°reas seleccionadas
    const checkboxes = document.querySelectorAll(
      "#edit-checkbox-areas input[name='areas']:checked"
    );
    const areasSeleccionadas = Array.from(checkboxes).map((cb) =>
      parseInt(cb.value)
    );
    empleadoData.areas = areasSeleccionadas;

    fetch(`/api/empleado/${empleadoData.idUsuario}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(empleadoData),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Error al actualizar el empleado");
        return res.json();
      })
      .then((data) => {
        alert(data.mensaje);
        cerrarModalEditarEmpleado();
        location.reload();
      })
      .catch((err) => {
        console.error("Error:", err);
        alert("Hubo un error al actualizar: " + err.message);
      });
  });

// Campos disponibles para exportaci√≥n
const camposExportacion = [
  { id: "idUsuario", nombre: "ID Usuario" },
  { id: "TipoRol", nombre: "Tipo de Rol" },
  { id: "Areas", nombre: "√Årea" },
  { id: "Nombres", nombre: "Nombres" },
  { id: "Paterno", nombre: "Apellido Paterno" },
  { id: "Materno", nombre: "Apellido Materno" },
  { id: "FechaNacimiento", nombre: "Fecha Nacimiento" },
  { id: "Direccion", nombre: "Direcci√≥n" },
  { id: "CodigoPostal", nombre: "C√≥digo Postal" },
  { id: "Correo", nombre: "Correo Electr√≥nico" },
  { id: "NSS", nombre: "N√∫mero de Seguro Social" },
  { id: "Telefono", nombre: "Tel√©fono" },
  { id: "FechaIngreso", nombre: "Fecha Ingreso" },
  { id: "RFC", nombre: "RFC" },
  { id: "Curp", nombre: "CURP" },
  { id: "Puesto", nombre: "Puesto" },
  { id: "NombreContactoEmergencia", nombre: "Contacto Emergencia" },
  { id: "TelefonoEmergencia", nombre: "Tel√©fono Emergencia" },
  { id: "Parentesco", nombre: "Parentesco" },
  { id: "FechaBaja", nombre: "Fecha Baja" },
  { id: "ComentarioSalida", nombre: "Comentario Salida" },
  { id: "Estado", nombre: "Estado" },
  { id: "SueldoDiario", nombre: "Sueldo Diario" },
  { id: "SueldoSemanal", nombre: "Sueldo Semanal" },
  { id: "BonoSemanal", nombre: "Bono Semanal" },
  { id: "Vacaciones", nombre: "Vacaciones" },
  { id: "DiasDisponibles", nombre: "Dias Disponibles" },
];

let camposSeleccionados = [];
let empleadosSeleccionados = [];

function abrirModalExportarExcel() {
  document.getElementById("export-excel-modal").classList.remove("hidden");
  mostrarPasoCampos();
  document.body.classList.add("no-scroll");
}

function mostrarPasoCampos() {
  document.getElementById("paso-empleados").classList.remove("visible");
  document.getElementById("paso-campos").classList.remove("oculto");

  const container = document.getElementById("export-fields-container");
  container.innerHTML = "";

  camposExportacion.forEach((campo) => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "8px";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = `export-${campo.id}`;
    checkbox.value = campo.id;
    checkbox.checked = true;

    const label = document.createElement("label");
    label.htmlFor = `export-${campo.id}`;
    label.textContent = campo.nombre;

    div.appendChild(checkbox);
    div.appendChild(label);
    container.appendChild(div);
  });
}

function mostrarPasoEmpleados() {
  // Guardar los campos seleccionados
  const checkboxes = document.querySelectorAll(
    '#export-fields-container input[type="checkbox"]:checked'
  );
  camposSeleccionados = Array.from(checkboxes).map((cb) => cb.value);

  if (camposSeleccionados.length === 0) {
    alert("Por favor selecciona al menos un campo para exportar");
    return;
  }

  document.getElementById("paso-campos").classList.add("oculto");
  document.getElementById("paso-empleados").classList.add("visible");

  // Cargar lista de empleados
  fetch("/api/empleados")
    .then((response) => response.json())
    .then((empleados) => {
      const container = document.getElementById("export-employees-container");
      container.innerHTML = "";

      empleados.forEach((emp) => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.gap = "8px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `emp-${emp.id}`;
        checkbox.value = emp.id;
        checkbox.checked = false;

        const label = document.createElement("label");
        label.htmlFor = `emp-${emp.id}`;
        label.textContent = `${emp.id} - ${emp.nombre}`;

        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    })
    .catch((error) => {
      console.error("Error al cargar empleados:", error);
      alert("Error al cargar la lista de empleados");
    });
}

function toggleSeleccionarTodos() {
  const checkboxes = document.querySelectorAll(
    '#export-employees-container input[type="checkbox"]'
  );
  const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

  checkboxes.forEach((checkbox) => {
    checkbox.checked = !allChecked;
  });
}

function exportarExcel() {
  // Obtener campos seleccionados correctamente al inicio
  const camposSeleccionados = Array.from(
    document.querySelectorAll(
      '#export-fields-container input[type="checkbox"]:checked'
    )
  ).map((cb) => cb.value);

  // Obtener empleados seleccionados
  const checkboxes = document.querySelectorAll(
    '#export-employees-container input[type="checkbox"]:checked'
  );
  const empleadosSeleccionados = Array.from(checkboxes).map((cb) => cb.value);

  if (empleadosSeleccionados.length === 0 || camposSeleccionados.length === 0) {
    alert(
      "Por favor selecciona al menos un empleado y al menos un campo para exportar"
    );
    return;
  }

  const exportBtn = document.querySelector("#paso-empleados .btn-primary");
  const originalText = exportBtn.textContent;
  exportBtn.textContent = "Generando...";
  exportBtn.disabled = true;

  const promises = empleadosSeleccionados.map((id) =>
    fetch(`/api/empleado/${id}`).then((res) => res.json())
  );

  Promise.all(promises)
    .then((empleadosCompletos) => {
      const datosExcel = empleadosCompletos.map((empleado) => {
        const fila = {};

        camposSeleccionados.forEach((campo) => {
          if (campo === "Areas" && Array.isArray(empleado.Areas)) {
            fila[campo] = empleado.Areas.map((a) => a.NombreArea).join(", ");
          } else {
            fila[campo] = empleado[campo] !== undefined ? empleado[campo] : "";
          }
        });

        return fila;
      });

      // Crear hoja Excel
      const worksheet = XLSX.utils.json_to_sheet(datosExcel, {
        header: camposSeleccionados,
      });

      // Aplicar estilo al encabezado
      const range = XLSX.utils.decode_range(worksheet["!ref"]);
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell_address = XLSX.utils.encode_cell({ r: 0, c: C });
        if (!worksheet[cell_address]) continue;

        worksheet[cell_address].s = {
          fill: {
            patternType: "solid",
            fgColor: { rgb: "FFFF00" }, // Amarillo
          },
          font: {
            bold: true,
          },
          alignment: {
            horizontal: "center",
          },
        };
      }

      // Ajustar ancho de columnas autom√°ticamente
      worksheet["!cols"] = camposSeleccionados.map((campo) => {
        const maxLength = Math.max(
          campo.length,
          ...datosExcel.map((row) =>
            row[campo] ? row[campo].toString().length : 0
          )
        );
        return { wch: maxLength + 2 };
      });

      // Crear libro y descargar
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Empleados");

      XLSX.writeFile(workbook, "empleados_exportados.xlsx");
    })
    .catch((error) => {
      console.error("Error al exportar a Excel:", error);
      alert("Ocurri√≥ un error al generar el archivo Excel: " + error.message);
    })
    .finally(() => {
      exportBtn.textContent = originalText;
      exportBtn.disabled = false;
      cerrarModalExportarExcel();
    });
}

function cerrarModalExportarExcel() {
  document.getElementById("export-excel-modal").classList.add("hidden");
  camposSeleccionados = [];
  empleadosSeleccionados = [];
  document.body.classList.remove("no-scroll");
}

function mostrarModalConfirmacion({
  texto,
  textoBotonConfirmar = "Confirmar",
  claseBotonConfirmar = "btn-danger",
  onConfirmar,
  onCancelar,
}) {
  const modal = document.getElementById("modal-confirmacion");
  const modalTexto = document.getElementById("modal-texto");
  const btnConfirmar = document.getElementById("modal-confirmar");
  const btnCancelar = document.getElementById("modal-cancelar");

  modalTexto.textContent = texto;

  // Cambiar texto y clases del bot√≥n confirmar
  btnConfirmar.textContent = textoBotonConfirmar;
  btnConfirmar.className = "btn " + claseBotonConfirmar;

  modal.classList.remove("hidden");

  // Remover listeners previos
  btnConfirmar.onclick = null;
  btnCancelar.onclick = null;

  btnConfirmar.onclick = () => {
    if (typeof onConfirmar === "function") onConfirmar();
    modal.classList.add("hidden");
  };

  btnCancelar.onclick = () => {
    if (typeof onCancelar === "function") onCancelar();
    modal.classList.add("hidden");
  };
}

function mostrarModalExito() {
  const modal = document.getElementById("modal-exito");
  const btnCerrar = document.getElementById("btn-cerrar-exito");

  modal.classList.remove("hidden");

  btnCerrar.onclick = () => {
    modal.classList.add("hidden");
  };
}
function calcularDiasVacaciones(fechaIngreso) {
  const hoy = new Date();
  const ingreso = new Date(fechaIngreso);

  let a√±os = hoy.getFullYear() - ingreso.getFullYear();
  let meses = hoy.getMonth() - ingreso.getMonth();
  let dias = hoy.getDate() - ingreso.getDate();

  // Ajuste si a√∫n no ha cumplido el a√±o, mes y d√≠a exacto
  if (meses < 0 || (meses === 0 && dias < 0)) {
    a√±os--;
  }

  console.log("Antig√ºedad exacta:", a√±os, "a√±os");

  // Tabla oficial LFT 2023
  let diasVacaciones = 0;
  if (a√±os < 1) diasVacaciones = 0;
  else if (a√±os === 1) diasVacaciones = 12;
  else if (a√±os === 2) diasVacaciones = 14;
  else if (a√±os === 3) diasVacaciones = 16;
  else if (a√±os === 4) diasVacaciones = 18;
  else if (a√±os === 5) diasVacaciones = 20;
  else if (a√±os >= 6 && a√±os <= 10) diasVacaciones = 22;
  else if (a√±os >= 11 && a√±os <= 15) diasVacaciones = 24;
  else if (a√±os >= 16 && a√±os <= 20) diasVacaciones = 26;
  else if (a√±os >= 21 && a√±os <= 25) diasVacaciones = 28;
  else if (a√±os >= 26) diasVacaciones = 30;

  return diasVacaciones;
}

// Funci√≥n para abrir el modal de d√≠as festivos
function abrirModalAgregarFestivo() {
  document.getElementById("add-holiday-modal").classList.remove("hidden");
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("fechaFestivo").value = today;
  document.body.classList.add("no-scroll");
}

// Funci√≥n para cerrar el modal de d√≠as festivos
function cerrarModalAgregarFestivo() {
  document.getElementById("add-holiday-modal").classList.add("hidden");
  document.body.classList.remove("no-scroll");
}

// Funci√≥n para abrir el modal de baja
function abrirModalBajaEmpleado(idUsuario) {
  document.body.classList.add("no-scroll");
  fetch(`/api/empleado/${idUsuario}`)
    .then((res) => {
      if (!res.ok) throw new Error("No se encontr√≥ el empleado");
      return res.json();
    })
    .then((empleado) => {
      document.getElementById(
        "nombre-empleado-baja"
      ).textContent = `${empleado.Nombres} ${empleado.Paterno} ${empleado.Materno}`;
      document.getElementById("id-empleado-baja").textContent = idUsuario;
      document.getElementById("baja-idUsuario").value = idUsuario;

      document.getElementById("modal-baja-empleado").classList.remove("hidden");
    })
    .catch((err) => {
      console.error("Error al cargar empleado:", err);
      alert("No se pudo abrir el modal de baja.");
    });
}

function cerrarModalBajaEmpleado() {
  document.getElementById("modal-baja-empleado").classList.add("hidden");
  document.body.classList.remove("no-scroll");
}

// Enviar solicitud de baja
document
  .getElementById("form-baja-empleado")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    const idUsuario = document.getElementById("baja-idUsuario").value;
    const fechaBaja = document.getElementById("baja-fecha").value;
    const comentarioSalida = document.getElementById("baja-comentario").value;

    if (!fechaBaja || !comentarioSalida) {
      alert("Todos los campos son obligatorios");
      return;
    }

    const body = {
      fechaBaja,
      comentarioSalida,
    };

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Procesando...";

    fetch(`/api/empleado/baja/${idUsuario}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    })
      .then(async (res) => {
        let data = null;
        try {
          data = await res.json();
        } catch (_) {}

        if (!res.ok || !data) {
          throw new Error(data?.error || "Error al dar de baja al empleado");
        }
        return data;
      })
      .then((data) => {
        alert("Empleado dado de baja correctamente.");
        cerrarModalBajaEmpleado();
        setTimeout(() => location.reload(), 1000);
      })
      .catch((err) => {
        console.error("Error al dar de baja:", err);
        alert("Hubo un error al procesar la baja: " + err.message);
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
  });

// Enviar d√≠a festivo
document
  .getElementById("holiday-form")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    const fecha = document.getElementById("fechaFestivo").value;
    const descripcion = document.getElementById("descripcionFestivo").value;
    const anio = new Date(fecha).getFullYear();

    fetch("/api/diafestivo", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        fecha: fecha,
        descripcion: descripcion,
        anio: anio,
      }),
    })
      .then((response) => {
        if (!response.ok) throw new Error("Error al guardar el d√≠a festivo");
        return response.json();
      })
      .then((data) => {
        alert("D√≠a festivo agregado correctamente");
        cerrarModalAgregarFestivo();
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error al guardar el d√≠a festivo: " + error.message);
      });
  });

    </script>
  </body>
</html>
