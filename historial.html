<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADM - Historial Inteligente</title>
    <link rel="stylesheet" href="css/liderHistorial.css" />
    <link rel="icon" href="Media/favicon.ico" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
    <header>
        <button class="back-button" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i> Regresar
        </button>
        <div class="header-container">
            <img src="Media/logo.png" alt="Logo" class="logo" />
            <h1>Historial Inteligente</h1>
        </div>
    </header>

    <div class="main-container">

        <!--  Filtro de fechas global para exportaci贸n -->
        <div class="filtro-exportacion-global" style="background-color:#f8f9fa; padding:15px; margin-bottom:20px; border-radius:8px; border:1px solid #dee2e6;">
            <h3 style="margin:0 0 10px 0; color:#495057; font-size:16px;">
                <i class="fas fa-filter"></i> Filtro Global para Exportaci贸n
            </h3>
            <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                <div>
                    <label for="fecha-global-inicio" style="display:block; margin-bottom:5px; font-weight:500;">Desde:</label>
                    <input type="date" id="fecha-global-inicio" class="filtro-fecha" style="padding:8px; border:1px solid #ced4da; border-radius:4px;">
                </div>
                <div>
                    <label for="fecha-global-fin" style="display:block; margin-bottom:5px; font-weight:500;">Hasta:</label>
                    <input type="date" id="fecha-global-fin" class="filtro-fecha" style="padding:8px; border:1px solid #ced4da; border-radius:4px;">
                </div>
                <div style="align-self:end;">
                    <button onclick="cargarTodasLasPestanasYExportar()" 
                        class="btn-exportar-todo" 
                        style="background-color:#28a745; color:white; padding:12px 20px; 
                               border:none; border-radius:6px; cursor:pointer; 
                               font-size:15px; display:flex; align-items:center; gap:8px; font-weight:500;">
                        <i class="fas fa-download"></i> Descargar TODO
                    </button>
                </div>
                <div style="align-self:end;">
                    <button onclick="limpiarFiltroGlobal()" 
                        class="btn-limpiar-global" 
                        style="background-color:#6c757d; color:white; padding:12px 16px; 
                               border:none; border-radius:6px; cursor:pointer; 
                               font-size:14px; display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
            <div style="margin-top:10px; font-size:13px; color:#6c757d;">
                <i class="fas fa-info-circle"></i> El filtro de fechas se aplicar谩 a todos los datos antes de la exportaci贸n. Deja vac铆o para exportar todos los registros.
            </div>
        </div>

        <!-- Tabs/Pesta帽as -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('reportes')">Reportes</button>
            <button class="tab-button" onclick="openTab('vacaciones')">Vacaciones</button>
            <button class="tab-button" onclick="openTab('permisos')">Permisos</button>
            <button class="tab-button" onclick="openTab('actas')">Actas Administrativas</button>
            <button class="tab-button" onclick="openTab('incapacidades')">Incapacidades</button>
        </div>

        <!-- Contenido de las pesta帽as -->
        <div id="reportes" class="tab-content active">
            <h2>Reportes Registrados</h2>
            <div class="filtro-fechas">
                <label for="fecha-inicio-reportes">Desde:</label>
                <input type="date" id="fecha-inicio-reportes" class="filtro-fecha">
                
                <label for="fecha-fin-reportes">Hasta:</label>
                <input type="date" id="fecha-fin-reportes" class="filtro-fecha">
                
                <button onclick="filtrarPorFechas('reportes')" class="btn-filtrar">Filtrar</button>
                <button onclick="limpiarFiltroFechas('reportes')" class="btn-limpiar">Limpiar</button>
            </div>
            <div class="table-container">
                <table id="reportes-table" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Observaciones</th>
                            <th>Tipo Asunto</th>
                            <th>Fecha Reporte</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="vacaciones" class="tab-content">
            <h2>Solicitudes de Vacaciones</h2>
            <div class="filtro-fechas">
                <label for="fecha-inicio-vacaciones">Desde:</label>
                <input type="date" id="fecha-inicio-vacaciones" class="filtro-fecha">
                
                <label for="fecha-fin-vacaciones">Hasta:</label>
                <input type="date" id="fecha-fin-vacaciones" class="filtro-fecha">
                
                <button onclick="filtrarPorFechas('vacaciones')" class="btn-filtrar">Filtrar</button>
                <button onclick="limpiarFiltroFechas('vacaciones')" class="btn-limpiar">Limpiar</button>
            </div>
            <div class="table-container">
                <table id="vacaciones-table" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>D铆as Solicitados</th>
                            <th>Fecha Salida</th>
                            <th>Fecha Regreso</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="permisos" class="tab-content">
            <h2>Solicitudes de Permisos</h2>
            <div class="filtro-fechas">
                <label for="fecha-inicio-permisos">Desde:</label>
                <input type="date" id="fecha-inicio-permisos" class="filtro-fecha">
                
                <label for="fecha-fin-permisos">Hasta:</label>
                <input type="date" id="fecha-fin-permisos" class="filtro-fecha">
                
                <button onclick="filtrarPorFechas('permisos')" class="btn-filtrar">Filtrar</button>
                <button onclick="limpiarFiltroFechas('permisos')" class="btn-limpiar">Limpiar</button>
            </div>
            <div class="table-container">
                <table id="permisos-table" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>D铆a Solicitado</th>
                            <th>Horario</th>
                            <th>Raz贸n</th>
                            <th>Tipo Compensaci贸n</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- NUEVA PESTAA: ACTAS ADMINISTRATIVAS -->
        <div id="actas" class="tab-content">
            <h2>Actas Administrativas</h2>
            <div class="filtro-fechas">
                <label for="fecha-inicio-actas">Desde:</label>
                <input type="date" id="fecha-inicio-actas" class="filtro-fecha">
                
                <label for="fecha-fin-actas">Hasta:</label>
                <input type="date" id="fecha-fin-actas" class="filtro-fecha">
                
                <button onclick="filtrarPorFechas('actas')" class="btn-filtrar">Filtrar</button>
                <button onclick="limpiarFiltroFechas('actas')" class="btn-limpiar">Limpiar</button>
            </div>
            <div class="table-container">
                <table id="actas-table" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Tipo Asunto</th>
                            <th>Fecha Acta</th>
                            <th>Comentario</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- NUEVA PESTAA: INCAPACIDADES -->
        <div id="incapacidades" class="tab-content">
            <h2>Historial de Incapacidades</h2>
            <div class="filtro-fechas">
                <label for="fecha-inicio-incapacidades">Desde:</label>
                <input type="date" id="fecha-inicio-incapacidades" class="filtro-fecha">
                
                <label for="fecha-fin-incapacidades">Hasta:</label>
                <input type="date" id="fecha-fin-incapacidades" class="filtro-fecha">
                
                <button onclick="filtrarPorFechas('incapacidades')" class="btn-filtrar">Filtrar</button>
                <button onclick="limpiarFiltroFechas('incapacidades')" class="btn-limpiar">Limpiar</button>
            </div>
            <div class="table-container">
                <table id="incapacidades-table" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Tipo de Incapacidad</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Final</th>
                            <th>D铆as</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // Obtener el idUsuario desde localStorage
    window.currentUserId = getCurrentUserId();
    
    if (!window.currentUserId) {
        mostrarError('No se encontr贸 informaci贸n de usuario. Por favor, inicia sesi贸n nuevamente.');
        return;
    }
    
    // Verificar si el usuario es admin antes de inicializar las tablas
    verificarAdmin().then(esAdmin => {
        window.esAdmin = esAdmin;
        
        // Inicializar las tablas con o sin botones de eliminar
        initReportesTable();
        initVacacionesTable();
        initPermisosTable();
        initActasTable();
        initIncapacidadesTable();
        
        // Cargar datos iniciales
        loadReportes();
    });
});

// Funci贸n para verificar si el usuario es administrador
async function verificarAdmin() {
    try {
        const response = await fetch(`/api/es_admin/${window.currentUserId}`);
        const data = await response.json();
        return data.esAdmin || false;
    } catch (error) {
        console.error('Error al verificar admin:', error);
        return false;
    }
}

// Funci贸n para obtener el ID del usuario desde localStorage
function getCurrentUserId() {
    return localStorage.getItem('idUsuario');
}

// Funci贸n para mostrar errores al usuario
function mostrarError(mensaje) {
    console.error(mensaje);
    alert(mensaje);
}

// Funci贸n para limpiar el filtro global
function limpiarFiltroGlobal() {
    document.getElementById('fecha-global-inicio').value = '';
    document.getElementById('fecha-global-fin').value = '';
    
    Swal.fire({
        icon: 'success',
        title: 'Filtro limpiado',
        text: 'El filtro global de fechas ha sido limpiado',
        timer: 1500,
        showConfirmButton: false
    });
}

// Funci贸n mejorada para aplicar filtro de fechas global en exportaci贸n
function aplicarFiltroFechasGlobal(datos, camposFecha) {
    const fechaGlobalInicio = document.getElementById('fecha-global-inicio').value;
    const fechaGlobalFin = document.getElementById('fecha-global-fin').value;
    
    // Si no hay filtro global, retornar todos los datos
    if (!fechaGlobalInicio && !fechaGlobalFin) {
        return datos;
    }
    
    console.log(`Aplicando filtro global: ${fechaGlobalInicio} - ${fechaGlobalFin}`);
    
    return datos.filter(row => {
        // Buscar una fecha v谩lida en los campos especificados
        for (let campo of camposFecha) {
            const fechaValor = row[campo];
            if (!fechaValor) continue;
            
            const fechaFila = parsearFecha(fechaValor);
            if (!fechaFila) continue;
            
            // Aplicar filtro
            const inicio = fechaGlobalInicio ? parsearFecha(fechaGlobalInicio) : null;
            const fin = fechaGlobalFin ? parsearFecha(fechaGlobalFin) : null;
            
            let cumpleFiltro = true;
            
            if (inicio && fin) {
                cumpleFiltro = fechaFila >= inicio && fechaFila <= fin;
            } else if (inicio) {
                cumpleFiltro = fechaFila >= inicio;
            } else if (fin) {
                cumpleFiltro = fechaFila <= fin;
            }
            
            if (cumpleFiltro) {
                return true; // Si al menos un campo de fecha cumple el filtro
            }
        }
        
        return false; // Ning煤n campo de fecha cumple el filtro
    });
}

// Confirmaci贸n 煤nica con SweetAlert2
function confirmarEliminacion(tipo, id, callback) {
  Swal.fire({
    icon: 'warning',
    html: `
      <div style="font-size:20px;font-weight:700;margin:0 0 6px 0;">驴Eliminar ${tipo}?</div>
      <div style="font-size:14px;opacity:.9;">Esta acci贸n no se puede deshacer.</div>
    `,
    showCancelButton: true,
    confirmButtonText: 'S铆, eliminar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6'
  }).then((result) => {
    if (result.isConfirmed) callback(id);
  });
}

// Helpers
function swalOk(titulo, detalle) {
  Swal.fire({
    icon: 'success',
    html: `
      <div style="font-size:20px;font-weight:700;margin:0 0 6px 0;">${titulo}</div>
      <div style="font-size:14px;opacity:.9;">${detalle}</div>
    `,
    timer: 1800,
    showConfirmButton: false
  });
}

function swalErr(titulo, detalle) {
  Swal.fire({
    icon: 'error',
    html: `
      <div style="font-size:20px;font-weight:700;margin:0 0 6px 0;">${titulo}</div>
      <div style="font-size:14px;opacity:.9;">${detalle}</div>
    `
  });
}

//  Eliminar Reporte
function eliminarReporte(id) {
  fetch(`/api/reportes/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        swalOk('Eliminado', 'Reporte eliminado correctamente');
        loadReportes();
      } else {
        swalErr('Error', 'Error al eliminar el reporte: ' + (data.error || 'Error desconocido'));
      }
    })
    .catch(() => swalErr('Error', 'Error al eliminar el reporte'));
}

//  Eliminar Vacaci贸n
function eliminarVacacion(id) {
  fetch(`/api/vacaciones/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        swalOk('Eliminado', 'Vacaci贸n eliminada correctamente');
        loadVacaciones();
      } else {
        swalErr('Error', 'Error al eliminar la vacaci贸n: ' + (data.error || 'Error desconocido'));
      }
    })
    .catch(() => swalErr('Error', 'Error al eliminar la vacaci贸n'));
}

//  Eliminar Permiso
function eliminarPermiso(id) {
  fetch(`/api/permisos/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        swalOk('Eliminado', 'Permiso eliminado correctamente');
        loadPermisos();
      } else {
        swalErr('Error', 'Error al eliminar el permiso: ' + (data.error || 'Error desconocido'));
      }
    })
    .catch(() => swalErr('Error', 'Error al eliminar el permiso'));
}

//  Eliminar Acta
function eliminarActa(id) {
  fetch(`/api/actas/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        swalOk('Eliminado', 'Acta eliminada correctamente');
        loadActas();
      } else {
        swalErr('Error', 'Error al eliminar el acta: ' + (data.error || 'Error desconocido'));
      }
    })
    .catch(() => swalErr('Error', 'Error al eliminar el acta'));
}

//  Eliminar Incapacidad
function eliminarIncapacidad(id) {
  fetch(`/api/incapacidades/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        swalOk('Eliminado', 'Incapacidad eliminada correctamente');
        loadIncapacidades();
      } else {
        swalErr('Error', 'Error al eliminar la incapacidad: ' + (data.error || 'Error desconocido'));
      }
    })
    .catch(() => swalErr('Error', 'Error al eliminar la incapacidad'));
}

// Funci贸n mejorada para parsear fechas correctamente
function parsearFecha(fechaString) {
    if (!fechaString) return null;
    
    // Si es formato dd/mm/yyyy (como lo renderiza DataTables)
    if (fechaString.includes('/')) {
        const [dia, mes, a帽o] = fechaString.split('/');
        return new Date(a帽o, mes - 1, dia);
    }
    
    // Si es formato yyyy-mm-dd (como lo del input)
    if (fechaString.includes('-')) {
        return new Date(fechaString + 'T00:00:00');
    }
    
    // Si es un objeto Date
    if (fechaString instanceof Date) {
        return fechaString;
    }
    
    // Intentar parsearlo directamente
    const fecha = new Date(fechaString);
    return isNaN(fecha.getTime()) ? null : fecha;
}

// Funci贸n mejorada para comparar solo fechas (sin hora)
function compararFechas(fecha1, fecha2) {
    if (!fecha1 || !fecha2) return false;
    
    const f1 = new Date(fecha1.getFullYear(), fecha1.getMonth(), fecha1.getDate());
    const f2 = new Date(fecha2.getFullYear(), fecha2.getMonth(), fecha2.getDate());
    
    return f1.getTime() === f2.getTime();
}

function openTab(tabId) {
    // Ocultar todos los contenidos de pesta帽as
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Desactivar todos los botones de pesta帽as
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Mostrar el contenido de la pesta帽a seleccionada
    document.getElementById(tabId).classList.add('active');
    
    // Activar el bot贸n de la pesta帽a seleccionada
    event.currentTarget.classList.add('active');
    
    // Cargar datos si es necesario
    if (tabId === 'reportes' && !window.reportesLoaded) {
        loadReportes();
    } else if (tabId === 'vacaciones' && !window.vacacionesLoaded) {
        loadVacaciones();
    } else if (tabId === 'permisos' && !window.permisosLoaded) {
        loadPermisos();
    } else if (tabId === 'actas' && !window.actasLoaded) {
        loadActas();
    } else if (tabId === 'incapacidades' && !window.incapacidadesLoaded) {
        loadIncapacidades();
    }
}

// Funci贸n mejorada para filtrar por fechas
function filtrarPorFechas(tabla) {
    let fechaInicio, fechaFin, table;
    
    switch(tabla) {
        case 'reportes':
            fechaInicio = document.getElementById('fecha-inicio-reportes').value;
            fechaFin = document.getElementById('fecha-fin-reportes').value;
            table = window.reportesTable;
            break;
        case 'vacaciones':
            fechaInicio = document.getElementById('fecha-inicio-vacaciones').value;
            fechaFin = document.getElementById('fecha-fin-vacaciones').value;
            table = window.vacacionesTable;
            break;
        case 'permisos':
            fechaInicio = document.getElementById('fecha-inicio-permisos').value;
            fechaFin = document.getElementById('fecha-fin-permisos').value;
            table = window.permisosTable;
            break;
        case 'actas':
            fechaInicio = document.getElementById('fecha-inicio-actas').value;
            fechaFin = document.getElementById('fecha-fin-actas').value;
            table = window.actasTable;
            break;
        case 'incapacidades':
            fechaInicio = document.getElementById('fecha-inicio-incapacidades').value;
            fechaFin = document.getElementById('fecha-fin-incapacidades').value;
            table = window.incapacidadesTable;
            break;
    }
    
    if (!fechaInicio && !fechaFin) {
        alert('Por favor, selecciona al menos una fecha');
        return;
    }
    
    // Redibujar la tabla para aplicar filtros
    table.draw();
}

// Funci贸n para limpiar el filtro de fechas
function limpiarFiltroFechas(tabla) {
    switch(tabla) {
        case 'reportes':
            document.getElementById('fecha-inicio-reportes').value = '';
            document.getElementById('fecha-fin-reportes').value = '';
            window.reportesTable.draw();
            break;
        case 'vacaciones':
            document.getElementById('fecha-inicio-vacaciones').value = '';
            document.getElementById('fecha-fin-vacaciones').value = '';
            window.vacacionesTable.draw();
            break;
        case 'permisos':
            document.getElementById('fecha-inicio-permisos').value = '';
            document.getElementById('fecha-fin-permisos').value = '';
            window.permisosTable.draw();
            break;
        case 'actas':
            document.getElementById('fecha-inicio-actas').value = '';
            document.getElementById('fecha-fin-actas').value = '';
            window.actasTable.draw();
            break;
        case 'incapacidades':
            document.getElementById('fecha-inicio-incapacidades').value = '';
            document.getElementById('fecha-fin-incapacidades').value = '';
            window.incapacidadesTable.draw();
            break;
    }
}

function initReportesTable() {
    const columns = [
        { data: 'idReporte' },
        { 
            data: null,
            render: function(data) {
                return `${data.Nombres} ${data.Paterno} ${data.Materno}`;
            }
        },
        { data: 'Observaciones' },
        { data: 'TipoAsunto' },
        { 
            data: 'FechaReporte',
            render: function(data) {
                return new Date(data).toLocaleDateString('es-ES');
            },
            type: 'date'
        }
    ];

    // Agregar columna de acciones solo si es admin
    if (window.esAdmin) {
        columns.push({
            data: null,
            render: function(data) {
                return `<button onclick="confirmarEliminacion('reporte', ${data.idReporte}, eliminarReporte)" 
                        class="btn-eliminar" style="background-color:#dc3545; color:white; border:none; 
                        padding:5px 10px; border-radius:4px; cursor:pointer;">
                        <i class="fas fa-trash"></i> Eliminar
                        </button>`;
            },
            orderable: false,
            searchable: false,
            className: 'no-export'
        });
    }

    window.reportesTable = $('#reportes-table').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'csv',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'excel',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            }
        ],
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        columns: columns
    });
}

function initVacacionesTable() {
    const columns = [
        { data: 'idVacaciones' },
        { 
            data: null,
            render: function(data) {
                return `${data.Nombres} ${data.Paterno} ${data.Materno}`;
            }
        },
        { data: 'EstadoSolicitud' },
        { data: 'DiasSolicitados' },
        { 
            data: 'FechaSalida',
            render: function(data) {
                return new Date(data).toLocaleDateString('es-ES');
            },
            type: 'date'
        },
        { 
            data: 'FechaRegreso',
            render: function(data) {
                return new Date(data).toLocaleDateString('es-ES');
            },
            type: 'date'
        }
    ];

    // Agregar columna de acciones solo si es admin
    if (window.esAdmin) {
        columns.push({
            data: null,
            render: function(data) {
                return `<button onclick="confirmarEliminacion('vacaci贸n', ${data.idVacaciones}, eliminarVacacion)" 
                        class="btn-eliminar" style="background-color:#dc3545; color:white; border:none; 
                        padding:5px 10px; border-radius:4px; cursor:pointer;">
                        <i class="fas fa-trash"></i> Eliminar
                        </button>`;
            },
            orderable: false,
            searchable: false,
            className: 'no-export'
        });
    }

    window.vacacionesTable = $('#vacaciones-table').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'csv',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'excel',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            }
        ],
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        columns: columns
    });
}

function initPermisosTable() {
    const columns = [
        { data: 'idPermiso' },
        { 
            data: null,
            render: function(data) {
                return `${data.Nombres} ${data.Paterno} ${data.Materno}`;
            }
        },
        { data: 'EstadoSolicitud' },
        { 
            data: 'DiaSolicitado',
            render: function(data) {
                return new Date(data).toLocaleDateString('es-ES');
            },
            type: 'date'
        },
        { 
            data: null,
            render: function(data) {
                return `${data.HoraInicio} - ${data.HoraFin}`;
            }
        },
        { data: 'Razon' },
        { data: 'TipoCompensacion' }
    ];

    // Agregar columna de acciones solo si es admin
    if (window.esAdmin) {
        columns.push({
            data: null,
            render: function(data) {
                return `<button onclick="confirmarEliminacion('permiso', ${data.idPermiso}, eliminarPermiso)" 
                        class="btn-eliminar" style="background-color:#dc3545; color:white; border:none; 
                        padding:5px 10px; border-radius:4px; cursor:pointer;">
                        <i class="fas fa-trash"></i> Eliminar
                        </button>`;
            },
            orderable: false,
            searchable: false,
            className: 'no-export'
        });
    }

    window.permisosTable = $('#permisos-table').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'csv',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'excel',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            }
        ],
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        columns: columns
    });
}

function initActasTable() {
    const columns = [
        { 
            data: null,
            render: function(data) {
                return `${data.nombres} ${data.paterno} ${data.materno}`;
            }
        },
        { data: 'TipoAsunto' },
        { 
            data: 'FechaActa',
            render: function(data) {
                return new Date(data).toLocaleDateString('es-ES');
            },
            type: 'date'
        },
        { 
            data: 'Comentario',
            render: function(data) {
                // Limitar la longitud del comentario para mejor visualizaci贸n
                if (data && data.length > 50) {
                    return data.substring(0, 50) + '...';
                }
                return data || '';
            }
        }
    ];

    // Agregar columna de acciones solo si es admin (necesitar谩s el ID en los datos)
    if (window.esAdmin) {
        columns.push({
            data: null,
            render: function(data) {
                return `<button onclick="confirmarEliminacion('acta', ${data.idActa || data.id}, eliminarActa)" 
                        class="btn-eliminar" style="background-color:#dc3545; color:white; border:none; 
                        padding:5px 10px; border-radius:4px; cursor:pointer;">
                        <i class="fas fa-trash"></i> Eliminar
                        </button>`;
            },
            orderable: false,
            searchable: false,
            className: 'no-export'
        });
    }

    window.actasTable = $('#actas-table').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'csv',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'excel',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            }
        ],
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        columns: columns
    });
}

function initIncapacidadesTable() {
    const columns = [
        { data: 'idIncapacidad' },
        { 
            data: null,
            render: function(data) {
                return `${data.nombres} ${data.paterno} ${data.materno}`;
            }
        },
        { data: 'tipo' },
        { 
            data: 'fechaInicio',
            render: function(data) {
                return data ? new Date(data).toLocaleDateString('es-ES') : '';
            },
            type: 'date'
        },
        { 
            data: 'fechaFinal',
            render: function(data) {
                return data ? new Date(data).toLocaleDateString('es-ES') : '';
            },
            type: 'date'
        },
        {
            data: null,
            render: function(data) {
                if (data.fechaInicio && data.fechaFinal) {
                    const inicio = new Date(data.fechaInicio);
                    const final = new Date(data.fechaFinal);
                    const diferencia = Math.ceil((final - inicio) / (1000 * 60 * 60 * 24)) + 1;
                    return diferencia + ' d铆as';
                }
                return '';
            }
        },
        { 
            data: 'observaciones',
            render: function(data) {
                if (data && data.length > 50) {
                    return data.substring(0, 50) + '...';
                }
                return data || '';
            }
        }
    ];

    // Agregar columna de acciones solo si es admin
    if (window.esAdmin) {
        columns.push({
            data: null,
            render: function(data) {
                return `<button onclick="confirmarEliminacion('incapacidad', ${data.idIncapacidad}, eliminarIncapacidad)" 
                        class="btn-eliminar" style="background-color:#dc3545; color:white; border:none; 
                        padding:5px 10px; border-radius:4px; cursor:pointer;">
                        <i class="fas fa-trash"></i> Eliminar
                        </button>`;
            },
            orderable: false,
            searchable: false,
            className: 'no-export'
        });
    }

    window.incapacidadesTable = $('#incapacidades-table').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'csv',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'excel',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            }
        ],
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        columns: columns
    });
}

// FILTRO GLOBAL NICO - Se ejecuta despu茅s de inicializar todas las tablas
$(document).ready(function() {
    // Limpiar filtros existentes para evitar duplicados
    $.fn.dataTable.ext.search.length = 0;
    
    // Agregar un solo filtro global que maneje todas las tablas
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        const tableId = settings.nTable.id;
        
        // Determinar qu茅 inputs de fecha usar seg煤n la tabla
        let fechaInicio, fechaFin, columnaFecha;
        
        if (tableId === 'reportes-table') {
            fechaInicio = document.getElementById('fecha-inicio-reportes').value;
            fechaFin = document.getElementById('fecha-fin-reportes').value;
            columnaFecha = 4; // Columna de FechaReporte
        } else if (tableId === 'vacaciones-table') {
            fechaInicio = document.getElementById('fecha-inicio-vacaciones').value;
            fechaFin = document.getElementById('fecha-fin-vacaciones').value;
            columnaFecha = 4; // Columna de FechaSalida
        } else if (tableId === 'permisos-table') {
            fechaInicio = document.getElementById('fecha-inicio-permisos').value;
            fechaFin = document.getElementById('fecha-fin-permisos').value;
            columnaFecha = 3; // Columna de DiaSolicitado
        } else if (tableId === 'actas-table') {
            fechaInicio = document.getElementById('fecha-inicio-actas').value;
            fechaFin = document.getElementById('fecha-fin-actas').value;
            columnaFecha = 2; // Columna de FechaActa
        } else if (tableId === 'incapacidades-table') {
            fechaInicio = document.getElementById('fecha-inicio-incapacidades').value;
            fechaFin = document.getElementById('fecha-fin-incapacidades').value;
            columnaFecha = 3; // Columna de Fecha Inicio
        } else {
            return true; // Si no es una tabla conocida, mostrar todo
        }
        
        // Si no hay fechas de filtro, mostrar todo
        if (!fechaInicio && !fechaFin) {
            return true;
        }
        
        // Obtener la fecha de la fila actual
        const fechaFila = parsearFecha(data[columnaFecha]);
        if (!fechaFila) return false;
        
        // Parsear fechas de filtro
        const inicio = fechaInicio ? parsearFecha(fechaInicio) : null;
        const fin = fechaFin ? parsearFecha(fechaFin) : null;
        
        // Aplicar filtro
        if (inicio && fin) {
            return fechaFila >= inicio && fechaFila <= fin;
        } else if (inicio) {
            return fechaFila >= inicio;
        } else if (fin) {
            return fechaFila <= fin;
        }
        
        return true;
    });
});

// Funciones de carga de datos con autenticaci贸n
function loadReportes() {
    const userId = window.currentUserId;
    if (!userId) {
        mostrarError('No se pudo obtener el ID del usuario. Por favor, inicia sesi贸n nuevamente.');
        return;
    }

    fetch(`/api/reportes-historial?idUsuario=${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                mostrarError(data.error);
                return;
            }
            window.reportesTable.clear().rows.add(data).draw();
            window.reportesLoaded = true;
        })
        .catch(error => {
            console.error('Error al cargar reportes:', error);
            mostrarError('Error al cargar los reportes: ' + error.message);
        });
}

function loadVacaciones() {
    const userId = window.currentUserId;
    if (!userId) {
        mostrarError('No se pudo obtener el ID del usuario. Por favor, inicia sesi贸n nuevamente.');
        return;
    }

    fetch(`/api/vacaciones-historial?idUsuario=${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                mostrarError(data.error);
                return;
            }
            window.vacacionesTable.clear().rows.add(data).draw();
            window.vacacionesLoaded = true;
        })
        .catch(error => {
            console.error('Error al cargar vacaciones:', error);
            mostrarError('Error al cargar las vacaciones: ' + error.message);
        });
}

function loadPermisos() {
    const userId = window.currentUserId;
    if (!userId) {
        mostrarError('No se pudo obtener el ID del usuario. Por favor, inicia sesi贸n nuevamente.');
        return;
    }

    fetch(`/api/permisos-historial?idUsuario=${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                mostrarError(data.error);
                return;
            }
            window.permisosTable.clear().rows.add(data).draw();
            window.permisosLoaded = true;
        })
        .catch(error => {
            console.error('Error al cargar permisos:', error);
            mostrarError('Error al cargar los permisos: ' + error.message);
        });
}

function loadActas() {
    const userId = window.currentUserId;
    if (!userId) {
        mostrarError('No se pudo obtener el ID del usuario. Por favor, inicia sesi贸n nuevamente.');
        return;
    }

    fetch(`/api/actas?idUsuario=${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                mostrarError(data.error);
                return;
            }
            window.actasTable.clear().rows.add(data).draw();
            window.actasLoaded = true;
        })
        .catch(error => {
            console.error('Error al cargar actas:', error);
            mostrarError('Error al cargar las actas: ' + error.message);
        });
}

function loadIncapacidades() {
    const userId = window.currentUserId;
    if (!userId) {
        mostrarError('No se pudo obtener el ID del usuario. Por favor, inicia sesi贸n nuevamente.');
        return;
    }

    fetch(`/api/incapacidades-historial?idUsuario=${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                mostrarError(data.error);
                return;
            }
            window.incapacidadesTable.clear().rows.add(data).draw();
            window.incapacidadesLoaded = true;
        })
        .catch(error => {
            console.error('Error al cargar incapacidades:', error);
            mostrarError('Error al cargar las incapacidades: ' + error.message);
        });
}

// Funci贸n mejorada de exportaci贸n con filtro de fechas global
// Funci贸n mejorada de exportaci贸n con orden correcto y dise帽o atractivo
function exportarTodo() {
    console.log('Iniciando exportaci贸n completa con filtro de fechas...');
    
    const fechaGlobalInicio = document.getElementById('fecha-global-inicio').value;
    const fechaGlobalFin = document.getElementById('fecha-global-fin').value;
    
    // Mostrar informaci贸n del filtro aplicado
    if (fechaGlobalInicio || fechaGlobalFin) {
        const rangoTexto = fechaGlobalInicio && fechaGlobalFin 
            ? `${fechaGlobalInicio} al ${fechaGlobalFin}`
            : fechaGlobalInicio 
                ? `desde ${fechaGlobalInicio}`
                : `hasta ${fechaGlobalFin}`;
        
        console.log(`Aplicando filtro de fechas: ${rangoTexto}`);
        
        Swal.fire({
            icon: 'info',
            title: 'Aplicando filtro de fechas',
            text: `Exportando datos ${rangoTexto}`,
            timer: 2000,
            showConfirmButton: false
        });
    }
    
    // Crear un nuevo libro
    let wb = XLSX.utils.book_new();
    let totalHojas = 0;
    let totalRegistrosFiltrados = 0;

    // Configuraciones de columnas para cada tabla (orden correcto y nombres legibles)
    const configuracionesTablas = {
        reportes: {
            columnas: [
                { key: 'idReporte', header: 'ID Reporte', width: 12 },
                { key: 'Nombres', header: 'Nombres', width: 20 },
                { key: 'Paterno', header: 'Apellido Paterno', width: 20 },
                { key: 'Materno', header: 'Apellido Materno', width: 20 },
                { key: 'TipoAsunto', header: 'Tipo de Asunto', width: 25 },
                { key: 'Observaciones', header: 'Observaciones', width: 40 },
                { key: 'FechaReporte', header: 'Fecha del Reporte', width: 18 }
            ],
            camposFecha: ['FechaReporte']
        },
        vacaciones: {
            columnas: [
                { key: 'idVacaciones', header: 'ID Vacaci贸n', width: 12 },
                { key: 'Nombres', header: 'Nombres', width: 20 },
                { key: 'Paterno', header: 'Apellido Paterno', width: 20 },
                { key: 'Materno', header: 'Apellido Materno', width: 20 },
                { key: 'EstadoSolicitud', header: 'Estado', width: 15 },
                { key: 'DiasSolicitados', header: 'D铆as Solicitados', width: 15 },
                { key: 'FechaSalida', header: 'Fecha de Salida', width: 18 },
                { key: 'FechaRegreso', header: 'Fecha de Regreso', width: 18 }
            ],
            camposFecha: ['FechaSalida', 'FechaRegreso']
        },
        permisos: {
            columnas: [
                { key: 'idPermiso', header: 'ID Permiso', width: 12 },
                { key: 'Nombres', header: 'Nombres', width: 20 },
                { key: 'Paterno', header: 'Apellido Paterno', width: 20 },
                { key: 'Materno', header: 'Apellido Materno', width: 20 },
                { key: 'EstadoSolicitud', header: 'Estado', width: 15 },
                { key: 'DiaSolicitado', header: 'D铆a Solicitado', width: 18 },
                { key: 'HoraInicio', header: 'Hora Inicio', width: 12 },
                { key: 'HoraFin', header: 'Hora Fin', width: 12 },
                { key: 'Razon', header: 'Raz贸n', width: 30 },
                { key: 'TipoCompensacion', header: 'Tipo Compensaci贸n', width: 20 }
            ],
            camposFecha: ['DiaSolicitado']
        },
        actas: {
            columnas: [
                { key: 'nombres', header: 'Nombres', width: 20 },
                { key: 'paterno', header: 'Apellido Paterno', width: 20 },
                { key: 'materno', header: 'Apellido Materno', width: 20 },
                { key: 'TipoAsunto', header: 'Tipo de Asunto', width: 25 },
                { key: 'FechaActa', header: 'Fecha del Acta', width: 18 },
                { key: 'Comentario', header: 'Comentario', width: 40 }
            ],
            camposFecha: ['FechaActa']
        },
        incapacidades: {
            columnas: [
                { key: 'idIncapacidad', header: 'ID Incapacidad', width: 15 },
                { key: 'nombres', header: 'Nombres', width: 20 },
                { key: 'paterno', header: 'Apellido Paterno', width: 20 },
                { key: 'materno', header: 'Apellido Materno', width: 20 },
                { key: 'tipo', header: 'Tipo de Incapacidad', width: 25 },
                { key: 'fechaInicio', header: 'Fecha Inicio', width: 18 },
                { key: 'fechaFinal', header: 'Fecha Final', width: 18 },
                { key: 'diasCalculados', header: 'D铆as Totales', width: 15 },
                { key: 'observaciones', header: 'Observaciones', width: 40 }
            ],
            camposFecha: ['fechaInicio', 'fechaFinal']
        }
    };

    // Funci贸n auxiliar para procesar cada tabla con orden correcto
    function procesarTablaConFiltroOrdenado(tabla, nombreHoja, nombreTabla, configuracion) {
        try {
            console.log(`Procesando ${nombreTabla}...`);
            
            if (!tabla) {
                console.warn(`La tabla ${nombreTabla} no est谩 inicializada`);
                return false;
            }

            let datos = tabla.rows().data().toArray();
            console.log(`${nombreTabla} - Total de filas encontradas:`, datos.length);

            // Aplicar filtro de fechas global
            if (fechaGlobalInicio || fechaGlobalFin) {
                datos = aplicarFiltroFechasGlobal(datos, configuracion.camposFecha);
                console.log(`${nombreTabla} - Despu茅s del filtro de fechas:`, datos.length);
            }

            if (datos.length > 0) {
                // Procesar y ordenar los datos seg煤n la configuraci贸n
                const datosOrdenados = datos.map(row => {
                    const filaOrdenada = {};
                    
                    // Agregar campos en el orden especificado
                    configuracion.columnas.forEach(col => {
                        let valor = row[col.key];
                        
                        // Formatear fechas
                        if (col.key.toLowerCase().includes('fecha') && valor) {
                            try {
                                const fecha = new Date(valor);
                                if (!isNaN(fecha.getTime())) {
                                    valor = fecha.toLocaleDateString('es-ES');
                                }
                            } catch (e) {
                                console.warn(`Error al formatear fecha en ${col.key}:`, valor);
                            }
                        }
                        
                        // Calcular d铆as para incapacidades
                        if (col.key === 'diasCalculados' && row.fechaInicio && row.fechaFinal) {
                            try {
                                const inicio = new Date(row.fechaInicio);
                                const final = new Date(row.fechaFinal);
                                const diferencia = Math.ceil((final - inicio) / (1000 * 60 * 60 * 24)) + 1;
                                valor = diferencia;
                            } catch (e) {
                                valor = '';
                            }
                        }
                        
                        // Limpiar valores null o undefined
                        if (valor === null || valor === undefined) {
                            valor = '';
                        }
                        
                        filaOrdenada[col.header] = valor;
                    });
                    
                    return filaOrdenada;
                });

                // Crear la hoja con el orden correcto
                const headers = configuracion.columnas.map(col => col.header);
                const ws = XLSX.utils.json_to_sheet(datosOrdenados, { header: headers });
                
                // Aplicar dise帽o atractivo
                aplicarDisenoAtractivo(ws, configuracion, datosOrdenados.length);
                
                XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
                totalHojas++;
                totalRegistrosFiltrados += datos.length;
                console.log(` ${nombreTabla} exportada correctamente con ${datos.length} filas`);
                return true;
            } else {
                console.warn(`${nombreTabla} no tiene datos para exportar despu茅s del filtro`);
                return false;
            }
        } catch (error) {
            console.error(`Error al procesar ${nombreTabla}:`, error);
            return false;
        }
    }

    // Procesar cada tabla con su configuraci贸n espec铆fica
    procesarTablaConFiltroOrdenado(window.reportesTable, "Reportes", "Reportes", configuracionesTablas.reportes);
    procesarTablaConFiltroOrdenado(window.vacacionesTable, "Vacaciones", "Vacaciones", configuracionesTablas.vacaciones);
    procesarTablaConFiltroOrdenado(window.permisosTable, "Permisos", "Permisos", configuracionesTablas.permisos);
    procesarTablaConFiltroOrdenado(window.actasTable, "Actas_Administrativas", "Actas Administrativas", configuracionesTablas.actas);
    procesarTablaConFiltroOrdenado(window.incapacidadesTable, "Incapacidades", "Incapacidades", configuracionesTablas.incapacidades);

    console.log(`Total de hojas creadas: ${totalHojas}, Total de registros: ${totalRegistrosFiltrados}`);

    // Verificar si se crearon hojas
    if (totalHojas === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin datos para exportar',
            text: 'No hay datos que coincidan con el filtro de fechas aplicado o las pesta帽as no tienen informaci贸n cargada.',
            confirmButtonText: 'Entendido'
        });
        console.error("No se encontraron datos en ninguna tabla despu茅s del filtro");
        return;
    }

    try {
        // Generar nombre de archivo con fecha y hora
        const ahora = new Date();
        const timestamp = ahora.toISOString().slice(0, 19).replace(/:/g, '-');
        
        let sufijo = '';
        if (fechaGlobalInicio || fechaGlobalFin) {
            sufijo = '_Filtrado';
            if (fechaGlobalInicio && fechaGlobalFin) {
                sufijo += `_${fechaGlobalInicio}_${fechaGlobalFin}`;
            } else if (fechaGlobalInicio) {
                sufijo += `_desde_${fechaGlobalInicio}`;
            } else if (fechaGlobalFin) {
                sufijo += `_hasta_${fechaGlobalFin}`;
            }
        }
        
        const nombreArchivo = `Historial_Completo${sufijo}_${timestamp}.xlsx`;
        
        // Descargar Excel
        XLSX.writeFile(wb, nombreArchivo);
        console.log(` Archivo exportado correctamente: ${nombreArchivo}`);
        
        // Mostrar confirmaci贸n
        Swal.fire({
            icon: 'success',
            title: 'Exportaci贸n completada',
            html: `
                <div style="text-align: left; margin-top: 15px;">
                    <strong>Archivo:</strong> ${nombreArchivo}<br>
                    <strong>Hojas creadas:</strong> ${totalHojas}<br>
                    <strong>Total registros:</strong> ${totalRegistrosFiltrados}
                    ${(fechaGlobalInicio || fechaGlobalFin) ? '<br><strong>Filtro aplicado:</strong> S铆' : ''}
                </div>
            `,
            confirmButtonText: 'Perfecto'
        });
        
    } catch (error) {
        console.error("Error al generar el archivo Excel:", error);
        Swal.fire({
            icon: 'error',
            title: 'Error en la exportaci贸n',
            text: 'Error al generar el archivo Excel. Revisa la consola para m谩s detalles.',
            confirmButtonText: 'Entendido'
        });
    }
}

// Funci贸n para aplicar dise帽o atractivo a la hoja de Excel
function aplicarDisenoAtractivo(ws, configuracion, totalFilas) {
    try {
        // Configurar anchos de columna
        ws['!cols'] = configuracion.columnas.map(col => ({ wch: col.width }));
        
        // Obtener el rango de la hoja
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // Crear estilos para las celdas (esto es limitado en xlsx, pero podemos hacer algunos ajustes)
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                if (!ws[cellAddress]) continue;
                
                const cell = ws[cellAddress];
                
                // Configurar formato para encabezados (primera fila)
                if (R === 0) {
                    cell.s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "366092" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                }
                // Configurar formato para filas de datos
                else {
                    // Alternar colores de fila para mejor legibilidad
                    const fillColor = R % 2 === 0 ? "F8F9FA" : "FFFFFF";
                    
                    cell.s = {
                        fill: { fgColor: { rgb: fillColor } },
                        alignment: { horizontal: "left", vertical: "top", wrapText: true },
                        border: {
                            top: { style: "thin", color: { rgb: "E0E0E0" } },
                            bottom: { style: "thin", color: { rgb: "E0E0E0" } },
                            left: { style: "thin", color: { rgb: "E0E0E0" } },
                            right: { style: "thin", color: { rgb: "E0E0E0" } }
                        }
                    };
                    
                    // Formato especial para n煤meros
                    if (typeof cell.v === 'number' && !cellAddress.includes('Fecha')) {
                        cell.s.alignment.horizontal = "center";
                    }
                    
                    // Formato especial para fechas
                    if (cellAddress.includes('Fecha') || cell.v?.toString().includes('/')) {
                        cell.s.alignment.horizontal = "center";
                        cell.s.numFmt = "dd/mm/yyyy";
                    }
                }
            }
        }
        
        // Configurar propiedades de la hoja
        ws['!margins'] = { left: 0.5, right: 0.5, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3 };
        ws['!autofilter'] = { ref: ws['!ref'] }; // Agregar filtros autom谩ticos
        
        // Congelar la primera fila (encabezados)
        ws['!freeze'] = { xSplit: 0, ySplit: 1 };
        
    } catch (error) {
        console.warn("Error al aplicar dise帽o atractivo:", error);
        // Si hay error en el dise帽o, al menos configurar anchos b谩sicos
        ws['!cols'] = configuracion.columnas.map(col => ({ wch: Math.min(col.width, 50) }));
    }
}

// Funci贸n mejorada para ajustar columnas
function ajustarColumnas(ws, data) {
    if (!data || data.length === 0) return;
    
    try {
        const objectMaxLength = [];
        const keys = Object.keys(data[0]);

        keys.forEach(key => {
            let max = key.length;
            data.forEach(row => {
                if (row[key] != null) {
                    const len = row[key].toString().length;
                    if (len > max) max = len;
                }
            });
            // Limitar el ancho m谩ximo para evitar columnas excesivamente anchas
            const ancho = Math.min(max + 2, 50);
            objectMaxLength.push({ wch: ancho });
        });

        ws['!cols'] = objectMaxLength;
    } catch (error) {
        console.warn("Error al ajustar columnas:", error);
    }
}

// Funci贸n adicional para forzar la carga de todas las pesta帽as antes de exportar
function cargarTodasLasPestanasYExportar() {
    console.log('Cargando todas las pesta帽as antes de exportar...');
    
    // Mostrar loading
    Swal.fire({
        title: 'Preparando exportaci贸n...',
        text: 'Cargando datos de todas las pesta帽as',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    const promesas = [];
    
    // Cargar datos de todas las pesta帽as si no est谩n cargados
    if (!window.reportesLoaded) {
        promesas.push(new Promise(resolve => {
            loadReportes();
            setTimeout(resolve, 1000);
        }));
    }
    
    if (!window.vacacionesLoaded) {
        promesas.push(new Promise(resolve => {
            loadVacaciones();
            setTimeout(resolve, 1000);
        }));
    }
    
    if (!window.permisosLoaded) {
        promesas.push(new Promise(resolve => {
            loadPermisos();
            setTimeout(resolve, 1000);
        }));
    }
    
    if (!window.actasLoaded) {
        promesas.push(new Promise(resolve => {
            loadActas();
            setTimeout(resolve, 1000);
        }));
    }
    
    if (!window.incapacidadesLoaded) {
        promesas.push(new Promise(resolve => {
            loadIncapacidades();
            setTimeout(resolve, 1000);
        }));
    }
    
    // Si no hay promesas, exportar directamente
    if (promesas.length === 0) {
        Swal.close();
        exportarTodo();
        return;
    }
    
    // Esperar a que se carguen todos los datos
    Promise.all(promesas).then(() => {
        console.log('Todas las pesta帽as cargadas, iniciando exportaci贸n...');
        Swal.close();
        setTimeout(() => {
            exportarTodo();
        }, 500);
    }).catch(error => {
        console.error('Error al cargar las pesta帽as:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al cargar los datos. Int茅ntalo nuevamente.',
            confirmButtonText: 'Entendido'
        });
    });
}
    </script>
    
</body>
</html>