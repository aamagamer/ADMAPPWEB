<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Administrador</title>
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="css/index.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <link rel="icon" href="Media/favicon.ico" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="js/utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <a href="#" class="back-button" onclick="logout()">
        <i class="bi bi-arrow-left"></i>
        Cerrar Sesión
      </a>
      <img src="Media/logo.png" alt="Logo" class="logo" />
      <h1>Portal De Administrador</h1>
    </div>
  </header>

  <div class="welcome-section">
    <div class="welcome-message">
      ¡Hola <span id="employee-name">Juan Pérez</span>!
    </div>
    <p>¿Qué deseas hacer hoy?</p>
  </div>

  <div class="content-wrapper">
    <div class="employee-table-container">
      <h2>
        Empleados Registrados
        <button class="add-employee-btn" onclick="abrirModalAltaEmpleado()">
          Agregar empleado +
        </button>

        <button
          class="add-employee-btn"
          onclick="abrirModalExportarExcel()"
          style="margin-left: 2px"
        >
          Exportar Excel +
        </button>
      </h2>

      <div
        style="
          display: flex;
          justify-content: flex-end;
          align-items: center;
          margin-bottom: 10px;
        "
      >
        <select
          id="filtro-estado"
          style="
            padding: 8px 12px;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-size: 1rem;
            border: 1.5px solid #bbb;
            background-color: #fff;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease;
            margin-right: 450px;
          "
        >
          <option value="activos">Activos</option>
          <option value="inactivos">Inactivos</option>
          <option value="todos">Todos</option>
        </select>
        <input
          type="text"
          id="busquedaEmpleado"
          oninput="buscarEmpleado()"
          placeholder="Buscar por ID o nombre"
          style="
            padding: 8px;
            width: 250px;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
          "
        />
        <button
          onclick="buscarEmpleado()"
          style="
            background-color: #2c3e50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          "
        >
          <i class="bi bi-search"></i>
        </button>
      </div>

      <table class="employee-table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Nombre</th>
            <th>Puesto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="empleados-body"></tbody>
      </table>
    </div>

    <!-- Botón dropdown movido más arriba -->
    <div class="options-container">
      <div class="dropdown-container">
        <button class="dropdown-button" onclick="toggleDropdown()">
          <span>Mostrar opciones</span>
          <i class="bi bi-chevron-down dropdown-arrow"></i>
        </button>
        <div class="dropdown-content" id="dropdownContent">
          <div
            class="dropdown-item"
            onclick="navigateToOption('evaluarSoli.html')"
          >
            <i class="bi bi-search dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">
                Solicitudes
                <span
                  id="dropdown-notificacion-solicitudes"
                  class="notification-badge"
                  style="display: none"
                  >0</span
                >
              </div>
              <div class="dropdown-item-description">
                Evalúa las solicitudes de tus empleados
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verSolicitudes.html')"
          >
            <i class="bi bi-eye dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Solicitudes</div>
              <div class="dropdown-item-description">
                Mira el historial de las solicitudes evaluadas
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('incapacidad.html')"
          >
            <i class="bi bi-hospital dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Incapacidades</div>
              <div class="dropdown-item-description">Autorizaciones</div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verIncapacidades.html')"
          >
            <i class="bi bi-hospital dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Incapacidades</div>
              <div class="dropdown-item-description">
                Consulta que empleados están en una incapacidad
              </div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalAgregarArea()">
            <i class="bi bi-building dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Área</div>
              <div class="dropdown-item-description">Agregar</div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalAgregarFestivo()">
            <i class="bi bi-calendar-plus dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Día Festivo</div>
              <div class="dropdown-item-description">
                Agregar un nuevo día festivo
              </div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalVerDiasFestivos()">
            <i class="bi bi-calendar dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Asuetos</div>
              <div class="dropdown-item-description">
                Ve los días festivos previamente agregados
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('reporte.html')"
          >
            <i class="bi bi-bar-chart-line dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Reportes</div>
              <div class="dropdown-item-description">Genera un reporte</div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verReportes.html')"
          >
            <i class="bi bi-bar-chart-line dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Reportes</div>
              <div class="dropdown-item-description">
                Visualiza los reportes generados
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('vacante.html')"
          >
            <i class="bi bi-pin-map dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Vacante</div>
              <div class="dropdown-item-description">Administra</div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verVacantes.html')"
          >
            <i class="bi bi-pencil dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Vacantes</div>
              <div class="dropdown-item-description">
                Administra las vacantes solicitadas por tus compañeros
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Todos los modales existentes se mantienen igual -->
    <!-- Modal para ver detalles del empleado -->
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2>Detalle del Empleado</h2>
        <div id="modal-body"></div>
      </div>
    </div>

    <!-- Modal de datos generales (usa las mismas clases e ID de estilo) -->
<div id="modal-generales" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalGenerales()">&times;</span>
    <h2>Datos Generales del Empleado</h2>
    <div id="modal-generales-body" class="modal-body-estilo"></div>
  </div>
</div>



    <!-- Modal para dar de alta empleado -->
    <div id="add-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAltaEmpleado()">&times;</span>
        <h2>Dar de alta nuevo empleado</h2>
        <form id="employee-form" class="add-employee-form">
          <!-- Campo 1 -->
          <div class="form-group">
            <label for="idUsuario">ID Usuario:</label>
            <input type="number" id="idUsuario" name="idUsuario" required />
          </div>

          <!-- Campo 2 (Combobox) -->
          <div class="form-group">
            <label for="tipoRol">Tipo de Rol:</label>
            <select id="tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <div class="form-group">
            <label>Áreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="toggle-areas"
              onclick="toggleAreas()"
            >
              Mostrar Áreas ▼
            </button>

            <div id="checkbox-areas" class="desplegable-container">
              <!-- Checkboxes se cargarán aquí -->
            </div>
            <small>Puedes seleccionar una o más áreas.</small>
          </div>

          <!-- Campo 4 -->
          <div class="form-group">
            <label for="nombres">Nombres:</label>
            <input type="text" id="nombres" name="nombres" required />
          </div>

          <!-- Campo 5 -->
          <div class="form-group">
            <label for="paterno">Apellido Paterno:</label>
            <input type="text" id="paterno" name="paterno" required />
          </div>

          <!-- Campo 6 -->
          <div class="form-group">
            <label for="materno">Apellido Materno:</label>
            <input type="text" id="materno" name="materno" />
          </div>

          <!-- Campo 7 -->
          <div class="form-group">
            <label for="fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Campo 8 -->
          <div class="form-group">
            <label for="direccion">Dirección:</label>
            <input type="text" id="direccion" name="direccion" required />
          </div>

          <!-- Campo 9 -->
          <div class="form-group">
  <label for="codigoPostal">Código Postal:</label>
  <input
    type="text"
    id="codigoPostal"
    placeholder="Ej. 12345"
    name="codigoPostal"
    maxlength="5"
    title="Por favor ingrese exactamente 5 dígitos numéricos"
    required
  />
</div>

          <!-- Campo 10 -->
          <div class="form-group">
            <label for="correo">Correo Electrónico:</label>
            <input type="email" id="correo" name="correo" required />
          </div>

          <!-- Campo 11 -->
          <div class="form-group">
            <label for="nss">Número de Seguro Social (NSS):</label>
            <input
              type="text"
              id="nss"
              name="nss"
              placeholder="Ej. 54-14-96-2319-8"
              required
            />
          </div>

          <!-- Campo 12 -->
          <div class="form-group">
            <label for="telefono">Teléfono:</label>
            <input
              type="tel"
              id="telefono"
              name="telefono"
              placeholder="Ej. 8441234567"
              title="Por favor ingrese 10 dígitos seguidos."
              required
            />
            
          </div>

          <!-- Campo 13 -->
          <div class="form-group">
            <label for="fechaIngreso">Fecha de Ingreso:</label>
            <input
              type="date"
              id="fechaIngreso"
              name="fechaIngreso"
              required
            />
          </div>

          <!-- Campo 14 -->
          <div class="form-group">
            <label for="rfc">RFC:</label>
            <input
              type="text"
              id="rfc"
              name="rfc"
              placeholder="Ej. OACD123456789"
              maxlength="13"
              required
            />
          </div>

          <!-- Campo 15 -->
          <div class="form-group">
            <label for="curp">CURP:</label>
            <input
              type="text"
              id="curp"
              name="curp"
              placeholder="Ej. GARC850701HDFRNS09"
              title="Por favor ingrese 18 caracteres alfanuméricos"
              maxlength="18"
              
              required
            />
          
          </div>

          <!-- Campo 16 -->
          <div class="form-group">
            <label for="puesto">Puesto:</label>
            <input type="text" id="puesto" name="puesto" required />
          </div>

          <!-- Campo 17 -->
          <div class="form-group">
            <label for="nombreContactoEmergencia"
              >Beneficiario/Contacto Emergencia:</label
            >
            <input
              type="text"
              id="nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Campo 18 -->
          <div class="form-group">
            <label for="telefonoEmergencia">Teléfono Emergencia:</label>
            <input
              type="tel"
              id="telefonoEmergencia"
              name="telefonoEmergencia"
              title="Por favor ingrese 1o dígitos sin espacios."
              required
            />
          </div>

          <!-- Campo 19 -->
          <div class="form-group">
            <label for="parentesco">Parentesco:</label>
            <input type="text" id="parentesco" name="parentesco" required />
          </div>

          <!-- Campo 20 -->
          <div class="form-group">
            <label for="contraseña">Contraseña:</label>
            <input
              type="password"
              id="contraseña"
              name="contraseña"
              required
            />
          </div>

          <!-- Campo 21 -->
          <div class="form-group">
            <label for="confirmarContraseña">Confirmar Contraseña:</label>
            <input
              type="password"
              id="confirmarContraseña"
              name="confirmarContraseña"
              required
            />
          </div>

          <!-- Campo Sueldo Diario -->
          <div class="form-group">
            <label for="sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="sueldoDiario"
              name="SueldoDiario"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Sueldo Semanal -->
          <div class="form-group">
            <label for="sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="sueldoSemanal"
              name="SueldoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Bono Semanal -->
          <div class="form-group">
            <label for="bonoSemanal">Bono Semanal:</label>
            <input
              type="number"
              id="bonoSemanal"
              name="BonoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Vacaciones Disponibles -->
          <div class="form-group">
            <label for="vacacionesDisponibles">Vacaciones Disponibles:</label>
            <input
              type="number"
              id="diasDisponibles"
              name="diasDisponibles"
              required
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAltaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para editar empleado -->
    <div id="edit-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalEditarEmpleado()">&times;</span>
        <h2>Editar Empleado</h2>
        <form id="edit-employee-form" class="add-employee-form">
          <!-- ID -->
          <div class="form-group">
            <label for="edit-idUsuario">ID Usuario:</label>
            <input
              type="number"
              id="edit-idUsuario"
              name="idUsuario"
              readonly
            />
          </div>

          <!-- Rol -->
          <div class="form-group">
            <label for="edit-tipoRol">Tipo de Rol:</label>
            <select id="edit-tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <!-- Áreas con toggle -->
          <div class="form-group">
            <label>Áreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="edit-toggle-areas"
              onclick="toggleAreas('edit')"
            >
              Mostrar Áreas ▼
            </button>
            <div id="edit-checkbox-areas" class="desplegable-container">
              <!-- checkboxes se insertan dinámicamente -->
            </div>
            <small>Puedes seleccionar una o más áreas.</small>
          </div>

          <!-- Nombres -->
          <div class="form-group">
            <label for="edit-nombres">Nombres:</label>
            <input type="text" id="edit-nombres" name="nombres" required />
          </div>

          <!-- Paterno -->
          <div class="form-group">
            <label for="edit-paterno">Apellido Paterno:</label>
            <input type="text" id="edit-paterno" name="paterno" required />
          </div>

          <!-- Materno -->
          <div class="form-group">
            <label for="edit-materno">Apellido Materno:</label>
            <input type="text" id="edit-materno" name="materno" />
          </div>

          <!-- Fecha de Nacimiento -->
          <div class="form-group">
            <label for="edit-fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="edit-fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Dirección -->
          <div class="form-group">
            <label for="edit-direccion">Dirección:</label>
            <input type="text" id="edit-direccion" name="direccion" required />
          </div>

          <!-- Código Postal -->
          <div class="form-group">
            <label for="edit-codigoPostal">Código Postal:</label>
            <input
              type="text"
              id="edit-codigoPostal"
              name="codigoPostal"
              required
            />
          </div>

          <!-- Correo -->
          <div class="form-group">
            <label for="edit-correo">Correo Electrónico:</label>
            <input type="email" id="edit-correo" name="correo" required />
          </div>

          <!-- NSS -->
          <div class="form-group">
            <label for="edit-nss">Número de Seguro Social (NSS):</label>
            <input type="text" id="edit-nss" name="nss" required />
          </div>

          <!-- Teléfono -->
          <div class="form-group">
            <label for="edit-telefono">Teléfono:</label>
            <input type="tel" id="edit-telefono" name="telefono" required />
          </div>

          <!-- Fecha de Ingreso -->
          <div class="form-group">
            <label for="edit-fechaIngreso">Fecha de Ingreso:</label>
            <input
              type="date"
              id="edit-fechaIngreso"
              name="fechaIngreso"
              required
            />
          </div>

          <!-- RFC -->
          <div class="form-group">
            <label for="edit-rfc">RFC:</label>
            <input type="text" id="edit-rfc" name="rfc" required />
          </div>

          <!-- CURP -->
          <div class="form-group">
            <label for="edit-curp">CURP:</label>
            <input type="text" id="edit-curp" name="curp" required />
          </div>

          <!-- Puesto -->
          <div class="form-group">
            <label for="edit-puesto">Puesto:</label>
            <input type="text" id="edit-puesto" name="puesto" required />
          </div>

          <!-- Contacto de Emergencia -->
          <div class="form-group">
            <label for="edit-nombreContactoEmergencia"
              >Nombre Contacto Emergencia:</label
            >
            <input
              type="text"
              id="edit-nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Teléfono Emergencia -->
          <div class="form-group">
            <label for="edit-telefonoEmergencia">Teléfono Emergencia:</label>
            <input
              type="tel"
              id="edit-telefonoEmergencia"
              name="telefonoEmergencia"
              required
            />
          </div>

          <!-- Parentesco -->
          <div class="form-group">
            <label for="edit-parentesco">Parentesco:</label>
            <input
              type="text"
              id="edit-parentesco"
              name="parentesco"
              required
            />
          </div>

          <!-- Contraseña -->
          <div class="form-group">
            <label for="edit-contraseña">Contraseña:</label>
            <input
              type="password"
              id="edit-contraseña"
              name="contraseña"
              required
            />
          </div>

          <!-- Confirmar Contraseña -->
          <div class="form-group">
            <label for="edit-confirmarContraseña">Confirmar Contraseña:</label>
            <input
              type="password"
              id="edit-confirmarContraseña"
              name="confirmarContraseña"
              required
            />
          </div>

          <!-- Sueldo Diario -->
          <div class="form-group">
            <label for="edit-sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="edit-sueldoDiario"
              name="SueldoDiario"
              step="0.01"
              required
            />
          </div>

          <!-- Sueldo Semanal -->
          <div class="form-group">
            <label for="edit-sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="edit-sueldoSemanal"
              name="SueldoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Bono Semanal -->
          <div class="form-group">
            <label for="edit-bonoSemanal">Bono Semanal:</label>
            <input
              type="number"
              id="edit-bonoSemanal"
              name="BonoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Fecha de Baja -->
          <div class="form-group">
            <label for="edit-fechaBaja">Fecha de Baja:</label>
            <input type="date" id="edit-fechaBaja" name="fechaBaja" />
          </div>

          <!-- Comentario de Salida -->
          <div class="form-group">
            <label for="edit-comentarioSalida">Comentario de Salida:</label>
            <input
              type="text"
              id="edit-comentarioSalida"
              name="comentarioSalida"
            />
          </div>

          <!-- Vacaciones -->
          <div class="form-group">
            <label for="edit-vacaciones">Vacaciones:</label>
            <input type="number" id="edit-vacaciones" name="Vacaciones" />
          </div>

          <!-- Vacaciones Disponibles -->
          <div class="form-group">
            <label for="edit-diasDisponibles">Vacaciones disponibles:</label>
            <input
              type="text"
              id="edit-diasDisponibles"
              name="diasDisponibles"
            />
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalEditarEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Actualizar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar día festivo -->
    <div id="add-holiday-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarFestivo()">&times;</span>
        <h2>Agregar Día Festivo</h2>
        <form id="holiday-form" class="add-employee-form">
          <!-- Campo Fecha -->
          <div class="form-group">
            <label for="fechaFestivo">Fecha:</label>
            <input type="date" id="fechaFestivo" name="fechaFestivo" required />
          </div>

          <!-- Campo Descripción -->
          <div class="form-group">
            <label for="descripcionFestivo">Descripción:</label>
            <input
              type="text"
              id="descripcionFestivo"
              name="descripcionFestivo"
              required
              placeholder="Ej. Día de la Independencia"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarFestivo()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Agregar Festivo
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para ver días festivos -->
<div id="ver-dias-festivos-modal" class="modal hidden">
<div class="modal-content add-employee-modal">
  <span class="close" onclick="cerrarModalVerDiasFestivos()">&times;</span>
  <h2>Días Festivos</h2>

  <!-- Selector de año -->
  <div class="form-group">
    <label for="anioFestivo">Selecciona un año:</label>
    <select id="anioFestivo" onchange="cargarDiasFestivos()">
      <!-- Se llenará dinámicamente -->
    </select>
  </div>

  <!-- Lista de días festivos -->
  <div id="listaDiasFestivos" class="dias-festivos-lista">
    <!-- Aquí se mostrarán los días -->
  </div>

  <div class="form-actions">
    <button
      type="button"
      class="btn btn-secondary"
      onclick="cerrarModalVerDiasFestivos()"
    >
      Cerrar
    </button>
  </div>
</div>
</div>


    <!-- Modal para agregar área -->
    <div id="add-area-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarArea()">&times;</span>
        <h2>Agregar Área</h2>
        <form id="area-form" class="add-employee-form">
          <!-- Campo Nombre del Área -->
          <div class="form-group">
            <label for="nombreArea">Nombre del Área:</label>
            <input
              type="text"
              id="nombreArea"
              name="nombreArea"
              required
              placeholder="Ej. Recursos Humanos"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarArea()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Agregar Área</button>
          </div>
        </form>
      </div>
    </div>

    
    <!-- Modal para exportar a Excel (actualizado) -->
<div id="export-excel-modal" class="modal hidden">
  <div class="modal-content add-employee-modal">
    <span class="close" onclick="cerrarModalExportarExcel()">&times;</span>

    <!-- Paso 1: Selección de campos -->
    <div id="paso-campos">
      <h2>Exportar datos (1/2)</h2>
      <p>Selecciona los campos que deseas incluir en el reporte:</p>

      <!-- Botones debajo del texto -->
      <div class="export-nav-buttons" style="display: flex; gap: 10px; margin: 10px 0;">
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('generales', this)">Datos generales</button>
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('baja', this)">Baja</button>
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('sueldo', this)">Sueldo</button>
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('vacaciones', this)">Vacaciones</button>
</div>



      <div id="export-fields-container" class="fields-grid"></div>
      <div class="form-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="cerrarModalExportarExcel()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="mostrarPasoEmpleados()"
        >
          Siguiente
        </button>
      </div>
    </div>

    <!-- Paso 2: Selección de empleados -->
    <div id="paso-empleados" class="hidden">
      <h2>Exportar datos (2/2)</h2>
      <p>Selecciona los empleados a incluir en el reporte:</p>
      <div style="margin-bottom: 10px"></div>
      <div id="export-employees-container" class="fields-grid"></div>
      <div class="form-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="mostrarPasoCampos()"
        >
          Anterior
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="exportarExcel()"
        >
          Generar Excel
        </button>
      </div>
    </div>
  </div>
</div>


    <div id="modal-confirmacion" class="modal-confirmacion hidden">
      <div class="modal-contenido">
        <p id="modal-texto">¿Quieres eliminar este empleado?</p>
        <div class="modal-botones">
          <button id="modal-cancelar" class="btn">Cancelar</button>
          <button id="modal-confirmar" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </div>

    <div id="modal-exito" class="modal-exito hidden">
      <div class="modal-contenido-exito">
        <p>Actualización correcta</p>
        <button id="btn-cerrar-exito" class="btn btn-primary">Aceptar</button>
      </div>
    </div>

    <div id="modal-baja-empleado" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModalBajaEmpleado()">&times;</span>
        <h2>Dar de Baja Empleado</h2>

        <div style="margin-bottom: 15px">
          <p>
            Empleado: <strong id="nombre-empleado-baja"></strong> <br /><br />
          </p>
          <p>ID: <strong id="id-empleado-baja"></strong></p>
        </div>

        <form id="form-baja-empleado">
          <input type="hidden" id="baja-idUsuario" />

          <div class="form-group">
            <label for="baja-fecha">Fecha de Baja:</label>
            <input type="date" id="baja-fecha" name="fechaBaja" required />
          </div>

          <div class="form-group">
            <label for="baja-comentario">Motivo de la baja:</label>
            <textarea
              id="baja-comentario"
              name="comentarioSalida"
              rows="4"
              required
              class="estilo-textarea"
            ></textarea>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalBajaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-danger">Confirmar Baja</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Mover estas funciones ANTES del DOMContentLoaded
function abrirModalVerDiasFestivos() {
  document.getElementById('ver-dias-festivos-modal').classList.remove('hidden');
  llenarAniosFestivos();
}

function cerrarModalVerDiasFestivos() {
  document.getElementById('ver-dias-festivos-modal').classList.add('hidden');
  document.getElementById('listaDiasFestivos').innerHTML = '';
}

function llenarAniosFestivos() {
  const select = document.getElementById('anioFestivo');
  const anioActual = new Date().getFullYear();
  select.innerHTML = "";

  for (let i = anioActual; i >= anioActual - 10; i--) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i;
    select.appendChild(option);
  }

  cargarDiasFestivos();
}

function cargarDiasFestivos() {
  const anio = document.getElementById("anioFestivo").value;
  const lista = document.getElementById("listaDiasFestivos");
  lista.innerHTML = "Cargando...";

  fetch(`/api/diasfestivos?anio=${anio}`)
    .then((res) => {
      if (!res.ok) throw new Error("Error al obtener días festivos");
      return res.json();
    })
    .then((data) => {
      if (!data || data.length === 0) {
        lista.innerHTML =
          "<p>No hay días festivos registrados para este año.</p>";
        return;
      }

      lista.innerHTML = "";

      const formatter = new Intl.DateTimeFormat("es-MX", {
        weekday: "long", // lunes, martes...
        day: "numeric",
        month: "long",   // enero, febrero...
        year: "numeric",
      });

      data.forEach((festivo) => {
        // Descomponer la fecha en partes
        const [anio, mes, dia] = festivo.fecha.split("-").map(Number);
        // Crear la fecha en horario local (evita problemas de zona horaria)
        const fechaObj = new Date(anio, mes - 1, dia);
        const fechaFormateada = formatter.format(fechaObj);

        const item = document.createElement("div");
        item.classList.add("festivo-item");
        item.innerHTML = `<strong>${fechaFormateada}</strong>: ${festivo.descripcion}`;
        lista.appendChild(item);
      });
    })
    .catch((error) => {
      console.error("Error al cargar días festivos:", error);
      lista.innerHTML =
        "<p>Error al cargar los días festivos. Intenta nuevamente más tarde.</p>";
    });
}



      // ===== VARIABLES GLOBALES =====
      let empleadosVisibles = [];
      let camposSeleccionados = [];
      let empleadosSeleccionados = [];

      // Campos disponibles para exportación
      const camposExportacion = [
        { id: "idUsuario", nombre: "ID Usuario" },
        { id: "TipoRol", nombre: "Tipo de Rol" },
        { id: "Areas", nombre: "Área" },
        { id: "Nombres", nombre: "Nombres" },
        { id: "Paterno", nombre: "Apellido Paterno" },
        { id: "Materno", nombre: "Apellido Materno" },
        { id: "FechaNacimiento", nombre: "Fecha Nacimiento" },
        { id: "Direccion", nombre: "Dirección" },
        { id: "CodigoPostal", nombre: "Código Postal" },
        { id: "Correo", nombre: "Correo Electrónico" },
        { id: "NSS", nombre: "Número de Seguro Social" },
        { id: "Telefono", nombre: "Teléfono" },
        { id: "FechaIngreso", nombre: "Fecha Ingreso" },
        { id: "RFC", nombre: "RFC" },
        { id: "Curp", nombre: "CURP" },
        { id: "Puesto", nombre: "Puesto" },
        { id: "NombreContactoEmergencia", nombre: "Contacto Emergencia" },
        { id: "TelefonoEmergencia", nombre: "Teléfono Emergencia" },
        { id: "Parentesco", nombre: "Parentesco" },
        { id: "FechaBaja", nombre: "Fecha Baja" },
        { id: "ComentarioSalida", nombre: "Comentario Salida" },
        { id: "Estado", nombre: "Estado" },
        { id: "SueldoDiario", nombre: "Sueldo Diario" },
        { id: "SueldoSemanal", nombre: "Sueldo Semanal" },
        { id: "BonoSemanal", nombre: "Bono Semanal" },
        { id: "Vacaciones", nombre: "Vacaciones" },
        { id: "DiasDisponibles", nombre: "Dias Disponibles" },
      ];

      // ===== FUNCIONES PARA EL DROPDOWN =====
      function toggleDropdown() {
        const dropdown = document.getElementById("dropdownContent");
        const button = document.querySelector(".dropdown-button");

        dropdown.classList.toggle("show");
        button.classList.toggle("active");
      }

      function navigateToOption(url) {
        window.location.href = url;
      }

      // Cerrar dropdown si se hace clic fuera
      window.onclick = function (event) {
        if (
          !event.target.matches(".dropdown-button") &&
          !event.target.closest(".dropdown-button")
        ) {
          const dropdowns = document.getElementsByClassName("dropdown-content");
          for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains("show")) {
              openDropdown.classList.remove("show");
              document
                .querySelector(".dropdown-button")
                .classList.remove("active");
            }
          }
        }
      };

      // ===== FUNCIONES DE UTILIDAD =====
      function toggleAreas(context = "") {
        const prefix = context ? context + "-" : "";
        const contenedor = document.getElementById(`${prefix}checkbox-areas`);
        const boton = document.getElementById(`${prefix}toggle-areas`);

        if (!contenedor || !boton) return;

        if (contenedor.classList.contains("abierto")) {
          contenedor.classList.remove("abierto");
          boton.textContent = "Mostrar Áreas ▼";
        } else {
          contenedor.classList.add("abierto");
          boton.textContent = "Ocultar Áreas ▲";
        }
      }

      // Verificar si el usuario está logueado
      function verificarSesion() {
        const idUsuario = localStorage.getItem("idUsuario");
        if (!idUsuario) {
          window.location.href = "index.html";
        }
        return idUsuario;
      }

      // Función para cargar notificaciones
      async function cargarNotificaciones() {
        try {
          const idUsuario = localStorage.getItem("idUsuario");
          if (!idUsuario) {
            console.error("No se encontró idUsuario en localStorage");
            return;
          }

          const response = await fetch(`/api/totalSolicitudes/${idUsuario}`);
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }

          const data = await response.json();
          console.log("Datos de notificaciones:", data);

          // Actualizar badge original
          const badge = document.getElementById("notificacion-solicitudes");
          if (badge) {
            if (data.total > 0) {
              badge.textContent = data.total;
              badge.style.display = "inline-block";
            } else {
              badge.style.display = "none";
            }
          }

          // Actualizar badge del dropdown
          const dropdownBadge = document.getElementById(
            "dropdown-notificacion-solicitudes"
          );
          if (dropdownBadge) {
            if (data.total > 0) {
              dropdownBadge.textContent = data.total;
              dropdownBadge.style.display = "inline-flex";
            } else {
              dropdownBadge.style.display = "none";
            }
          }
        } catch (error) {
          console.error("Error al cargar notificaciones:", error);
        }
      }

      function cargarNombreUsuario(idUsuario) {
        fetch("/api/usuario/nombre", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ idUsuario: idUsuario }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error al obtener el nombre del usuario");
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error(data.error);
              document.getElementById("employee-name").textContent =
                "Administrador";
            } else {
              let nombreCompleto = data.nombres || "";
              if (data.paterno) nombreCompleto += ` ${data.paterno}`;
              if (data.materno) nombreCompleto += ` ${data.materno}`;

              document.getElementById("employee-name").textContent =
                nombreCompleto.trim() || "Administrador";
            }
          })
          .catch((error) => {
            console.error("Error al cargar nombre:", error);
            document.getElementById("employee-name").textContent =
              "Administrador";
          });
      }

      function cargarEmpleadosPorEstado() {
        const estadoSeleccionado =
          document.getElementById("filtro-estado").value;
        const termino = document
          .getElementById("busquedaEmpleado")
          .value.toLowerCase();

        fetch(`/api/empleados?estado=${estadoSeleccionado}`)
          .then((response) => response.json())
          .then((data) => {
            const empleadosFiltrados = data.filter(
              (emp) =>
                emp.id.toString().includes(termino) ||
                emp.nombre.toLowerCase().includes(termino)
            );

            empleadosVisibles = empleadosFiltrados;

            const tbody = document.getElementById("empleados-body");
            tbody.innerHTML = "";

            if (empleadosFiltrados.length === 0) {
              tbody.innerHTML = `<tr><td colspan="4">No se encontraron empleados</td></tr>`;
              return;
            }

            empleadosFiltrados.forEach((emp) => {
              const row = document.createElement("tr");
              row.innerHTML = `
        <td>${emp.id}</td>
        <td>
  <button onclick="verEmpleadoGenerales(${emp.id})" style="all: unset; cursor: pointer;">
    ${emp.nombre}
  </button>
</td>

        <td>${emp.puesto}</td>
        <td>
          <button class="action-btn" onclick="verEmpleado(${emp.id})">
            <i class="bi bi-eye"></i>
          </button>
          <button class="action-btn" onclick="editarEmpleado(${emp.id})">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="action-btn" onclick="abrirModalBajaEmpleado(${emp.id})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
              tbody.appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Error al cargar empleados:", error);
          });
      }

      function buscarEmpleado() {
        cargarEmpleadosPorEstado();
      }

      function verEmpleado(id) {
        document.body.classList.add("no-scroll");
        fetch(`/api/empleado/${id}`)
          .then((res) => {
            if (!res.ok) throw new Error("Error al cargar datos del empleado");
            return res.json();
          })
          .then((data) => {
            const modalBody = document.getElementById("modal-body");

            const renderField = (label, value) => {
              const texto =
                value === null ||
                value === undefined ||
                value === "" ||
                value === "null"
                  ? "Sin información"
                  : value;
              return `<p><strong>${label}:</strong> ${texto}</p>`;
            };

            const areasTexto =
              data.Areas && data.Areas.length > 0
                ? data.Areas.map((area) => area.NombreArea).join(", ")
                : "Sin información";

            modalBody.innerHTML = `
      ${renderField("ID", data.idUsuario)}
      ${renderField("Rol", data.TipoRol)}
      ${renderField("Áreas", areasTexto)}
      ${renderField(
        "Nombre Completo",
        `${data.Nombres} ${data.Paterno} ${data.Materno}`
      )}
      ${renderField("Fecha Nacimiento", data.FechaNacimiento)}
      ${renderField("Dirección", data.Direccion)}
      ${renderField("Código Postal", data.CodigoPostal)}
      ${renderField("Correo", data.Correo)}
      ${renderField("NSS", data.NSS)}
      ${renderField("Teléfono", data.Telefono)}
      ${renderField("Fecha Ingreso", data.FechaIngreso)}
      ${renderField("RFC", data.RFC)}
      ${renderField("CURP", data.Curp)}
      ${renderField("Puesto", data.Puesto)}
      ${renderField("Contacto Emergencia", data.NombreContactoEmergencia)}
      ${renderField("Teléfono Emergencia", data.TelefonoEmergencia)}
      ${renderField("Parentesco", data.Parentesco)}
      ${renderField("Fecha Baja", data.FechaBaja)}
      ${renderField("Comentario Salida", data.ComentarioSalida)}
      ${renderField("Clave", data.clave)}
      ${renderField("Estado", data.Estado)}
      ${renderField("Sueldo Diario", data.SueldoDiario)}
      ${renderField("Sueldo Semanal", data.SueldoSemanal)}
      ${renderField("Bono Semanal", data.BonoSemanal)}
      ${renderField("Vacaciones", data.Vacaciones)}
      ${renderField("Vacaciones disponibles", data.DiasDisponibles)}
    `;

            document.getElementById("modal").classList.remove("hidden");
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al cargar los datos del empleado");
          });
      }

      function verEmpleadoGenerales(id) {
  document.body.classList.add("no-scroll");

  fetch(`/api/empleado/${id}`)
    .then((res) => {
      if (!res.ok) throw new Error("Error al cargar datos del empleado");
      return res.json();
    })
    .then((data) => {
      const modalBody = document.getElementById("modal-generales-body");

      const renderField = (label, value) => {
        const texto =
          value === null || value === undefined || value === "" || value === "null"
            ? "Sin información"
            : value;
        return `<p><strong>${label}:</strong> ${texto}</p>`;
      };

      const areasTexto =
        data.Areas && data.Areas.length > 0
          ? data.Areas.map((area) => area.NombreArea).join(", ")
          : "Sin información";

      modalBody.innerHTML = `
        ${renderField("ID", data.idUsuario)}
        ${renderField("Rol", data.TipoRol)}
        ${renderField("Áreas", areasTexto)}
        ${renderField("Nombre", data.Nombres)}
        ${renderField("Paterno", data.Paterno)}
        ${renderField("Materno", data.Materno)}
        ${renderField("Fecha nacimiento", data.FechaNacimiento)}
        ${renderField("Dirección", data.Direccion)}
        ${renderField("Código postal", data.CodigoPostal)}
        ${renderField("Correo electrónico", data.Correo)}
        ${renderField("Teléfono", data.Telefono)}
        ${renderField("Fecha ingreso", data.FechaIngreso)}
        ${renderField("CURP", data.Curp)}
        ${renderField("Puesto", data.Puesto)}
      `;

      document.getElementById("modal-generales").classList.remove("hidden");
    })
    .catch((error) => {
      console.error("Error:", error);
      alert("Error al cargar los datos generales del empleado");
    });
}

function cerrarModalGenerales() {
  document.getElementById("modal-generales").classList.add("hidden");
  document.body.classList.remove("no-scroll");
}




      function cerrarModal() {
        document.getElementById("modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      function abrirModalAltaEmpleado() {
        document
          .getElementById("add-employee-modal")
          .classList.remove("hidden");
        document.body.classList.add("no-scroll");

        // Llenar roles
        fetch("/api/roles")
          .then((res) => res.json())
          .then((data) => {
            const selectRol = document.getElementById("tipoRol");
            selectRol.innerHTML = '<option value="">Seleccione un rol</option>';
            data.forEach((rol) => {
              const option = document.createElement("option");
              option.value = rol.idRol;
              option.textContent = rol.TipoRol;
              selectRol.appendChild(option);
            });
          });

        // Llenar áreas como checkboxes
        fetch("/api/areas")
          .then((res) => res.json())
          .then((data) => {
            const container = document.getElementById("checkbox-areas");
            container.innerHTML = "";

            data.forEach((area) => {
              const item = document.createElement("div");
              item.className = "area-item";

              const label = document.createElement("label");
              label.textContent = area.NombreArea;
              label.className = "area-label";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "areas";
              checkbox.value = area.idArea;
              checkbox.className = "area-checkbox";

              item.appendChild(label);
              item.appendChild(checkbox);

              container.appendChild(item);
            });
          });
      }

      function cargarAreasParaEditar(idUsuario, areasSeleccionadas) {
        fetch("/api/areas")
          .then((res) => res.json())
          .then((areas) => {
            const container = document.getElementById("edit-checkbox-areas");
            container.innerHTML = "";

            areas.forEach((area) => {
              const wrapper = document.createElement("div");
              wrapper.className = "area-item";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "areas";
              checkbox.value = area.idArea;
              checkbox.id = `area-${area.idArea}`;
              checkbox.checked = areasSeleccionadas.includes(area.idArea);
              checkbox.className = "area-checkbox";

              const label = document.createElement("label");
              label.htmlFor = checkbox.id;
              label.className = "area-label";
              label.textContent = area.NombreArea;

              wrapper.appendChild(label);
              wrapper.appendChild(checkbox);

              container.appendChild(wrapper);
            });
          });
      }

      function cerrarModalAltaEmpleado() {
        document.getElementById("add-employee-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      function formatoFechaParaInput(fecha) {
        if (!fecha) return "";

        if (typeof fecha === "string" && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
          return fecha;
        }

        const date = new Date(fecha);
        const offset = date.getTimezoneOffset();
        date.setMinutes(date.getMinutes() + offset);

        return date.toISOString().split("T")[0];
      }

      // Función de validación para el formulario de EDICIÓN
function validarCamposEdicion() {
    // Obtener valores de los campos de edición
    const codigoPostal = document.getElementById('edit-codigoPostal').value.trim();
    const telefono = document.getElementById('edit-telefono').value.trim();
    const telefonoEmergencia = document.getElementById('edit-telefonoEmergencia').value.trim();
    const curp = document.getElementById('edit-curp').value.trim();
    const rfc = document.getElementById('edit-rfc').value.trim();
    const nss = document.getElementById('edit-nss').value.trim();
    
    // Expresiones regulares para validación
    const regexCP = /^\d{5}$/; // 5 dígitos exactos
    const regexTelefono = /^(?:\d\s*){10}$/; // 10 dígitos exactos
    const regexCURP = /^[A-Z0-9]{18}$/i; // 18 alfanuméricos (case insensitive)
    const regexRFC = /^[A-Z0-9]{13}$/i; // 13 alfanuméricos (case insensitive)
    const regexNSS = /^(?:\d{11}|\d{2}-\d{2}-\d{2}-\d{4}-\d{1}|\d{2}-\d{2}-\d{2}-\d{2}-\d{2}-\d{1})$/;

    // Validar cada campo
    if (!regexCP.test(codigoPostal)) {
        Swal.fire({
          icon: "warning",
          title: "Campo incorrecto",
          text: "El código postal debe tener 5 dígitos.",
          confirmButtonColor:"#3085d6",
          confirmButtonText: "Aceptar",
        });
        return false;
    }

    if (!regexTelefono.test(telefono)) {
        Swal.fire({
            icon: "warning",
            title: "Campo incorrecto",
            text: "El número telefónico debe de tener 10 dígitos.",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
        });
        return false;
    }
    
    if (!regexTelefono.test(telefonoEmergencia)) {
        Swal.fire({
            icon: "warning",
            title: "Campo incorrecto",
            text: "El número telefónico de emergencia debe de tener 10 dígitos.",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
        }); 
        return false;
    }

    if (!regexCURP.test(curp)) {
        Swal.fire({
            icon: "warning",
            title: "Campo incorrecto",
            text: "La CURP debe tener 18 caracteres alfanúmericos.",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
          });
        return false;
    }

    if (!regexRFC.test(rfc)) {
        Swal.fire({
          icon: "warning",
          title: "Campo incorrecto",
          text: "El RFC debe tener 13 caracteres alfánumericos.",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        });
        return false;
    }

    if(!regexNSS.test(nss)){
      Swal.fire({
        icon: "warning",
        title: "Campo incorrecto",
        text: "El NSS debe de contener 11 dígitos, puede contener guión o no.",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      });
      return false;
    }

    // Si todo es válido
    return true;
}

      function editarEmpleado(id) {
        document
          .getElementById("edit-employee-modal")
          .classList.remove("hidden");
        document.body.classList.add("no-scroll");

        fetch(`/api/empleado/${id}`)
          .then((res) => {
            if (!res.ok) throw new Error("Error al obtener datos del empleado");
            return res.json();
          })
          .then((data) => {
            Promise.all([
              fetch("/api/roles").then((res) => res.json()),
              fetch("/api/areas").then((res) => res.json()),
            ]).then(([roles, areas]) => {
              const selectRol = document.getElementById("edit-tipoRol");

              selectRol.innerHTML =
                '<option value="">Seleccione un rol</option>';
              roles.forEach((rol) => {
                const option = document.createElement("option");
                option.value = rol.idRol;
                option.textContent = rol.TipoRol;
                selectRol.appendChild(option);
              });

              // Llenar campos del formulario
              document.getElementById("edit-idUsuario").value =
                data.idUsuario || "";
              document.getElementById("edit-tipoRol").value =
                data.Rol_idRol || "";
              document.getElementById("edit-nombres").value =
                data.Nombres || "";
              document.getElementById("edit-paterno").value =
                data.Paterno || "";
              document.getElementById("edit-materno").value =
                data.Materno || "";
              document.getElementById("edit-fechaNacimiento").value =
                formatoFechaParaInput(data.FechaNacimiento);
              document.getElementById("edit-direccion").value =
                data.Direccion || "";
              document.getElementById("edit-codigoPostal").value =
                data.CodigoPostal || "";
              document.getElementById("edit-correo").value = data.Correo || "";
              document.getElementById("edit-nss").value = data.NSS || "";
              document.getElementById("edit-telefono").value =
                data.Telefono || "";
              document.getElementById("edit-rfc").value = data.RFC || "";
              document.getElementById("edit-curp").value = data.Curp || "";
              document.getElementById("edit-puesto").value = data.Puesto || "";
              document.getElementById("edit-nombreContactoEmergencia").value =
                data.NombreContactoEmergencia || "";
              document.getElementById("edit-telefonoEmergencia").value =
                data.TelefonoEmergencia || "";
              document.getElementById("edit-parentesco").value =
                data.Parentesco || "";
              document.getElementById("edit-contraseña").value =
                data.clave || "";
              document.getElementById("edit-confirmarContraseña").value =
                data.clave || "";
              document.getElementById("edit-sueldoDiario").value =
                data.SueldoDiario || "";
              document.getElementById("edit-sueldoSemanal").value =
                data.SueldoSemanal || "";
              document.getElementById("edit-bonoSemanal").value =
                data.BonoSemanal || "";
              document.getElementById("edit-fechaBaja").value =
                formatoFechaParaInput(data.FechaBaja);
              document.getElementById("edit-comentarioSalida").value =
                data.ComentarioSalida || "";

              const fechaIngresoInput =
                document.getElementById("edit-fechaIngreso");
              fechaIngresoInput.value = formatoFechaParaInput(
                data.FechaIngreso
              );

              const campoVacaciones =
                document.getElementById("edit-vacaciones");
              campoVacaciones.value =
                data.Vacaciones != null
                  ? data.Vacaciones
                  : calcularDiasVacaciones(fechaIngresoInput.value);

              document.getElementById("edit-diasDisponibles").value =
                data.DiasDisponibles || 0;

              const idsDeAreas = (data.Areas || []).map((area) => area.idArea);
              cargarAreasParaEditar(data.idUsuario, idsDeAreas);

              fechaIngresoInput.addEventListener("change", function () {
                const nuevaFecha = this.value;
                const dias = calcularDiasVacaciones(nuevaFecha);
                document.getElementById("edit-vacaciones").value = dias;
              });
            });
          })
          .catch((error) => {
            console.error("Error al cargar datos del empleado:", error);
            alert("No se pudieron cargar los datos del empleado.");
          });
      }

      function cerrarModalEditarEmpleado() {
        document.getElementById("edit-employee-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      function abrirModalExportarExcel() {
        document
          .getElementById("export-excel-modal")
          .classList.remove("hidden");
        mostrarPasoCampos();
        document.body.classList.add("no-scroll");
      }

      const camposGenerales = [
    "idUsuario", "Rol", "Areas", "Nombre", "Materno", "Paterno",
    "Fecha nacimiento", "direccion", "codigo postal",
    "correo electronico", "telefono", "fecha ingreso", "curp", "puesto"
  ];

  const camposBaja = [...camposGenerales, "fecha Baja", "comentario salida"];
  const camposSueldo = [...camposGenerales, "Sueldo Diario", "sueldo Semanal", "Bono Semanal"];
  const camposVacaciones = [...camposGenerales, "vacaciones", "dias disponibles"];

 function seleccionarCamposPorCategoria(categoria, botonPresionado) {
  let camposASeleccionar = [];

  switch (categoria) {
    case "generales":
      camposASeleccionar = [
        "idUsuario", "TipoRol", "Areas", "Nombres", "Materno", "Paterno",
        "FechaNacimiento", "Direccion", "CodigoPostal", "Correo",
        "Telefono", "FechaIngreso", "Curp", "Puesto"
      ];
      break;

    case "baja":
      camposASeleccionar = [
        "idUsuario", "TipoRol", "Areas", "Nombres", "Materno", "Paterno",
        "FechaNacimiento", "Direccion", "CodigoPostal", "Correo",
        "Telefono", "FechaIngreso", "Curp", "Puesto",
        "FechaBaja", "ComentarioSalida"
      ];
      break;

    case "sueldo":
      camposASeleccionar = [
        "idUsuario", "TipoRol", "Areas", "Nombres", "Materno", "Paterno",
        "FechaNacimiento", "Direccion", "CodigoPostal", "Correo",
        "Telefono", "FechaIngreso", "Curp", "Puesto",
        "SueldoDiario", "SueldoSemanal", "BonoSemanal"
      ];
      break;

    case "vacaciones":
      camposASeleccionar = [
        "idUsuario", "TipoRol", "Areas", "Nombres", "Materno", "Paterno",
        "FechaNacimiento", "Direccion", "CodigoPostal", "Correo",
        "Telefono", "FechaIngreso", "Curp", "Puesto",
        "Vacaciones", "DiasDisponibles"
      ];
      break;
  }

  // ✅ Seleccionar los checkboxes correspondientes
  const checkboxes = document.querySelectorAll("#export-fields-container input[type='checkbox']");
  checkboxes.forEach((cb) => {
    cb.checked = camposASeleccionar.includes(cb.value);
  });

  // ✅ Actualizar estilo de los botones
  document.querySelectorAll(".export-nav-buttons button").forEach(btn => {
    btn.classList.remove("btn-primary");
    btn.classList.add("btn-outline-primary");
  });

  if (botonPresionado) {
    botonPresionado.classList.remove("btn-outline-primary");
    botonPresionado.classList.add("btn-primary");
  }
}



      function mostrarPasoCampos() {
        document.getElementById("paso-empleados").classList.remove("visible");
        document.getElementById("paso-campos").classList.remove("oculto");

        const container = document.getElementById("export-fields-container");
        container.innerHTML = "";
        container.style.display = "grid";
        container.style.gridTemplateColumns =
          "repeat(auto-fill, minmax(200px, 1fr))";
        container.style.gap = "12px";
        container.style.padding = "12px";

        camposExportacion.forEach((campo) => {
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.gap = "10px";
          div.style.padding = "8px";
          div.style.borderRadius = "6px";
          div.style.backgroundColor = "#f8f9fa";
          div.style.transition = "all 0.2s ease";

          div.onmouseenter = () => {
            div.style.backgroundColor = "#e9ecef";
            div.style.transform = "translateY(-2px)";
          };
          div.onmouseleave = () => {
            div.style.backgroundColor = "#f8f9fa";
            div.style.transform = "none";
          };

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `export-${campo.id}`;
          checkbox.value = campo.id;
          checkbox.checked = true;
          checkbox.style.width = "18px";
          checkbox.style.height = "18px";
          checkbox.style.cursor = "pointer";
          checkbox.style.accentColor = "#4dabf7";

          const label = document.createElement("label");
          label.htmlFor = `export-${campo.id}`;
          label.textContent = campo.nombre;
          label.style.cursor = "pointer";
          label.style.fontSize = "14px";
          label.style.userSelect = "none";
          label.style.color = "#495057";

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      function mostrarPasoEmpleados() {
        const checkboxes = document.querySelectorAll(
          '#export-fields-container input[type="checkbox"]:checked'
        );
        camposSeleccionados = Array.from(checkboxes).map((cb) => cb.value);

        if (camposSeleccionados.length === 0) {
          Swal.fire({
            icon: "warning",
            title: "Campos requeridos",
            text: "Por favor selecciona al menos un campo para exportar",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
          });
          return;
        }

        document.getElementById("paso-campos").classList.add("oculto");
        document.getElementById("paso-empleados").classList.add("visible");

        const container = document.getElementById("export-employees-container");
        container.innerHTML = "";
        container.style.display = "grid";
        container.style.gridTemplateColumns =
          "repeat(auto-fill, minmax(250px, 1fr))";
        container.style.gap = "12px";
        container.style.padding = "16px";
        container.style.maxHeight = "400px";
        container.style.overflowY = "auto";

        if (empleadosVisibles.length === 0) {
          container.innerHTML = `
    <div style="
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-size: 16px;
    ">
      <i class="fas fa-users-slash" style="font-size: 24px; margin-bottom: 8px;"></i>
      <p>No hay empleados para exportar</p>
    </div>
  `;
          return;
        }

        // Añadir select all/none
        const selectAllDiv = document.createElement("div");
        selectAllDiv.style.gridColumn = "1 / -1";
        selectAllDiv.style.display = "flex";
        selectAllDiv.style.gap = "12px";
        selectAllDiv.style.marginBottom = "8px";

        const selectAllBtn = document.createElement("button");
        selectAllBtn.textContent = "Seleccionar todos";
        selectAllBtn.style.padding = "6px 12px";
        selectAllBtn.style.background = "#174da3";
        selectAllBtn.style.color = "white";
        selectAllBtn.style.border = "none";
        selectAllBtn.style.borderRadius = "4px";
        selectAllBtn.style.cursor = "pointer";

        const deselectAllBtn = document.createElement("button");
        deselectAllBtn.textContent = "Quitar todos";
        deselectAllBtn.style.padding = "6px 12px";
        deselectAllBtn.style.background = "#f1f3f5";
        deselectAllBtn.style.color = "#495057";
        deselectAllBtn.style.border = "1px solid #dee2e6";
        deselectAllBtn.style.borderRadius = "4px";
        deselectAllBtn.style.cursor = "pointer";

        selectAllBtn.onclick = () => {
          document
            .querySelectorAll(".empleado-checkbox")
            .forEach((cb) => (cb.checked = true));
          updateEmployeeCounter();
        };

        deselectAllBtn.onclick = () => {
          document
            .querySelectorAll(".empleado-checkbox")
            .forEach((cb) => (cb.checked = false));
          updateEmployeeCounter();
        };

        selectAllDiv.appendChild(selectAllBtn);
        selectAllDiv.appendChild(deselectAllBtn);
        container.appendChild(selectAllDiv);

        empleadosVisibles.forEach((emp) => {
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.gap = "12px";
          div.style.padding = "10px";
          div.style.borderRadius = "6px";
          div.style.backgroundColor = "#f8f9fa";
          div.style.transition = "all 0.2s ease";

          div.onmouseenter = () => {
            div.style.backgroundColor = "#e9ecef";
          };
          div.onmouseleave = () => {
            div.style.backgroundColor = "#f8f9fa";
          };

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "empleado-checkbox";
          checkbox.value = emp.id;
          checkbox.checked = true;
          checkbox.style.width = "18px";
          checkbox.style.height = "18px";
          checkbox.style.cursor = "pointer";
          checkbox.style.accentColor = "#4dabf7";

          const label = document.createElement("label");
          label.textContent = `${emp.id} - ${emp.nombre}`;
          label.style.cursor = "pointer";
          label.style.fontSize = "14px";
          label.style.userSelect = "none";
          label.style.color = "#495057";
          label.style.flex = "1";
          label.style.overflow = "hidden";
          label.style.textOverflow = "ellipsis";
          label.style.whiteSpace = "nowrap";

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });

        // Añadir contador de seleccionados
        const counterDiv = document.createElement("div");
        counterDiv.style.gridColumn = "1 / -1";
        counterDiv.style.textAlign = "right";
        counterDiv.style.fontSize = "14px";
        counterDiv.style.color = "#6c757d";
        counterDiv.id = "employee-counter";
        container.appendChild(counterDiv);
        updateEmployeeCounter();

        // Actualizar contador cuando cambien los checkboxes
        container.addEventListener("change", updateEmployeeCounter);

        function updateEmployeeCounter() {
          const total = empleadosVisibles.length;
          const selected = document.querySelectorAll(
            ".empleado-checkbox:checked"
          ).length;
          const counter = document.getElementById("employee-counter");
          if (counter) {
            counter.textContent = `${selected} de ${total} empleados seleccionados`;
          }
        }
      }

async function exportarExcel() {
  const camposSeleccionados = Array.from(
    document.querySelectorAll('#export-fields-container input[type="checkbox"]:checked')
  ).map((cb) => cb.value);
  
  const checkboxes = document.querySelectorAll(
    '#export-employees-container input[type="checkbox"]:checked'
  );
  
  const empleadosSeleccionados = Array.from(checkboxes).map((cb) => cb.value);

  if (empleadosSeleccionados.length === 0 || camposSeleccionados.length === 0) {
    Swal.fire({
      icon: "warning",
      title: "Selección incompleta",
      text: "Por favor selecciona al menos un empleado y al menos un campo para exportar",
      confirmButtonColor: "#3085d6",
      confirmButtonText: "Aceptar",
    });
    return;
  }

  const exportBtn = document.querySelector("#paso-empleados .btn-primary");
  const originalText = exportBtn.textContent;
  exportBtn.textContent = "Generando...";
  exportBtn.disabled = true;

  try {
    const promises = empleadosSeleccionados.map((id) =>
      fetch(`/api/empleado/${id}`).then((res) => res.json())
    );

    const empleadosCompletos = await Promise.all(promises);

    const datosExcel = empleadosCompletos.map((empleado) => {
      const fila = {};
      camposSeleccionados.forEach((campo) => {
        if (campo === "Areas" && Array.isArray(empleado.Areas)) {
          fila[campo] = empleado.Areas.map((a) => a.NombreArea).join(", ");
        } else {
          fila[campo] = empleado[campo] !== undefined ? empleado[campo] : "";
        }
      });
      return fila;
    });

    // Crear workbook con ExcelJS
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Empleados');

    // Definir las columnas
    worksheet.columns = camposSeleccionados.map(campo => ({
      header: campo,
      key: campo,
      width: Math.max(campo.length + 2, 10)
    }));

    // Agregar los datos
    datosExcel.forEach(empleado => {
      worksheet.addRow(empleado);
    });

    // Aplicar estilos al encabezado (fila 1) - AMARILLO
    const headerRow = worksheet.getRow(1);
    headerRow.eachCell((cell) => {
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' } // Amarillo
      };
      cell.font = {
        bold: true,
        size: 10,
        name: 'Arial'
      };
      cell.alignment = {
        horizontal: 'center',
        vertical: 'middle'
      };
    });

    // Aplicar estilos a las filas de datos
    for (let i = 2; i <= worksheet.rowCount; i++) {
      const row = worksheet.getRow(i);
      const empleado = datosExcel[i - 2];
      
      // Verificar si tiene fecha baja Y comentario baja
      const tieneFechaBaja = empleado['FechaBaja'] && empleado['FechaBaja'].toString().trim() !== '';
      const tieneComentarioBaja = empleado['ComentarioSalida'] && empleado['ComentarioSalida'].toString().trim() !== '';
      
      const esFilaRoja = tieneFechaBaja && tieneComentarioBaja;
      
      row.eachCell((cell) => {
        if (esFilaRoja) {
          // Fila completa en ROJO
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFF0000' } // Rojo
          };
          cell.font = {
            color: { argb: 'FFFFFFFF' }, // Texto blanco para contraste
            size: 10,
            name: 'Arial'
          };
        } else {
          // Fila normal
          cell.font = {
            size: 10,
            name: 'Arial'
          };
        }
        
        cell.alignment = {
          vertical: 'middle'
        };
      });
    }

    // Ajustar ancho de columnas automáticamente
    worksheet.columns.forEach((column, index) => {
      const campo = camposSeleccionados[index];
      let maxLength = campo.length;
      
      // Buscar el valor más largo en esta columna
      datosExcel.forEach(row => {
        const cellValue = row[campo] ? row[campo].toString() : '';
        if (cellValue.length > maxLength) {
          maxLength = cellValue.length;
        }
      });
      
      column.width = Math.min(maxLength + 2, 50); // Máximo 50 caracteres
    });

    // Generar el archivo
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { 
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
    });

    // Descargar el archivo
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `empleados_exportados_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

  } catch (error) {
    console.error("Error al exportar a Excel:", error);
    alert("Ocurrió un error al generar el archivo Excel: " + error.message);
  } finally {
    exportBtn.textContent = originalText;
    exportBtn.disabled = false;
    cerrarModalExportarExcel();
  }
}

      function cerrarModalExportarExcel() {
        document.getElementById("export-excel-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
        camposSeleccionados = [];
        empleadosSeleccionados = [];
      }

      function mostrarModalConfirmacion({
        texto,
        textoBotonConfirmar = "Confirmar",
        claseBotonConfirmar = "btn-danger",
        onConfirmar,
        onCancelar,
      }) {
        const modal = document.getElementById("modal-confirmacion");
        const modalTexto = document.getElementById("modal-texto");
        const btnConfirmar = document.getElementById("modal-confirmar");
        const btnCancelar = document.getElementById("modal-cancelar");

        modalTexto.textContent = texto;

        btnConfirmar.textContent = textoBotonConfirmar;
        btnConfirmar.className = "btn " + claseBotonConfirmar;

        modal.classList.remove("hidden");

        btnConfirmar.onclick = null;
        btnCancelar.onclick = null;

        btnConfirmar.onclick = () => {
          if (typeof onConfirmar === "function") onConfirmar();
          modal.classList.add("hidden");
        };

        btnCancelar.onclick = () => {
          if (typeof onCancelar === "function") onCancelar();
          modal.classList.add("hidden");
        };
      }

      function mostrarModalExito() {
        const modal = document.getElementById("modal-exito");
        const btnCerrar = document.getElementById("btn-cerrar-exito");

        modal.classList.remove("hidden");

        btnCerrar.onclick = () => {
          modal.classList.add("hidden");
        };
      }

      function calcularDiasVacaciones(fechaIngreso) {
        const hoy = new Date();
        const ingreso = new Date(fechaIngreso);

        hoy.setHours(0, 0, 0, 0);
        ingreso.setHours(0, 0, 0, 0);

        let años = hoy.getFullYear() - ingreso.getFullYear();
        const mesActual = hoy.getMonth();
        const diaActual = hoy.getDate();
        const mesIngreso = ingreso.getMonth();
        const diaIngreso = ingreso.getDate();

        if (
          mesActual < mesIngreso ||
          (mesActual === mesIngreso && diaActual < diaIngreso)
        ) {
          años--;
        }

        // Tabla LFT
        if (años < 1) return 0;
        if (años === 1) return 12;
        if (años === 2) return 14;
        if (años === 3) return 16;
        if (años === 4) return 18;
        if (años === 5) return 20;
        if (años >= 6 && años <= 10) return 22;
        if (años >= 11 && años <= 15) return 24;
        if (años >= 16 && años <= 20) return 26;
        if (años >= 21 && años <= 25) return 28;
        return 30;
      }

      function abrirModalAgregarFestivo() {
        document.getElementById("add-holiday-modal").classList.remove("hidden");
        document.body.classList.add("no-scroll");
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fechaFestivo").value = today;
      }

      function cerrarModalAgregarFestivo() {
        document.getElementById("add-holiday-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      function abrirModalBajaEmpleado(idUsuario) {
        document.body.classList.add("no-scroll");
        fetch(`/api/empleado/${idUsuario}`)
          .then((res) => {
            if (!res.ok) throw new Error("No se encontró el empleado");
            return res.json();
          })
          .then((empleado) => {
            document.getElementById(
              "nombre-empleado-baja"
            ).textContent = `${empleado.Nombres} ${empleado.Paterno} ${empleado.Materno}`;
            document.getElementById("id-empleado-baja").textContent = idUsuario;
            document.getElementById("baja-idUsuario").value = idUsuario;

            document
              .getElementById("modal-baja-empleado")
              .classList.remove("hidden");
          })
          .catch((err) => {
            console.error("Error al cargar empleado:", err);
            alert("No se pudo abrir el modal de baja.");
          });
      }

      function cerrarModalBajaEmpleado() {
        document.getElementById("modal-baja-empleado").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      function abrirModalAgregarArea() {
        document.getElementById("add-area-modal").classList.remove("hidden");
        document.body.classList.add("no-scroll");
      }

      function cerrarModalAgregarArea() {
        document.getElementById("add-area-modal").classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }

      // ===== INICIALIZACIÓN =====
      document.addEventListener("DOMContentLoaded", () => {
        const idUsuario = verificarSesion();
        cargarNotificaciones();
        setInterval(cargarNotificaciones, 1200000);

        if (idUsuario) {
          cargarNombreUsuario(idUsuario);
        }

        // Event listeners
        const filtroEstado = document.getElementById("filtro-estado");
        const busquedaEmpleado = document.getElementById("busquedaEmpleado");

        if (filtroEstado) {
          filtroEstado.addEventListener("change", cargarEmpleadosPorEstado);
        }

        if (busquedaEmpleado) {
          busquedaEmpleado.addEventListener("input", buscarEmpleado);
        }

        // Carga inicial
        cargarEmpleadosPorEstado();

        //Validaciones
        function validarCampos() {
    // Obtener valores de los campos
    const codigoPostal = document.getElementById('codigoPostal').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const telefonoEmergencia = document.getElementById('telefonoEmergencia').value.trim();
    const curp = document.getElementById('curp').value.trim();
    const rfc = document.getElementById('rfc').value.trim();
    const nss = document.getElementById('nss').value.trim();
    
    // Expresiones regulares para validación
    const regexCP = /^\d{5}$/; // 5 dígitos exactos
    const regexTelefono = /^(?:\d\s*){10}$/; // 10 dígitos exactos
    const regexCURP = /^[A-Z0-9]{18}$/i; // 18 alfanuméricos (case insensitive)
    const regexRFC = /^[A-Z0-9]{13}$/i; // 13 alfanuméricos (case insensitive)
    const regexNSS = /^(?:\d{11}|\d{2}-\d{2}-\d{2}-\d{4}-\d{1}|\d{2}-\d{2}-\d{2}-\d{2}-\d{2}-\d{1})$/;

    // Validar cada campo
    if (!regexCP.test(codigoPostal)) {
        Swal.fire({
          icon: "warning",
          title: "Campo incorrecto",
          text: "El código postal debe tener 5 dígitos.",
          confirmButtonColor:"#3085d6",
          confirmButtonText: "Aceptar",
        });
        return false;
    }

    if (!regexTelefono.test(telefono)) {
        Swal.fire({
            icon: "warning",
            title: "Campo incorrecto",
            text: "El número telefónico debe de tener 10 dígitos.",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
        });
        return false;
    }
    if (!regexTelefono.test(telefonoEmergencia)) {
        Swal.fire({
            icon: "warning",
            title: "Campo incorrecto",
            text: "El número telefónico de emergencia debe de tener 10 dígitos.",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
        }); 
        return false;
    }

    if (!regexCURP.test(curp)) {
        Swal.fire({
            icon: "warning",
            title: "Campo incorrecto",
            text: "La CURP debe tener 18 caracteres alfanúmericos.",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Aceptar",
          });
        return false;
    }

    if (!regexRFC.test(rfc)) {
        Swal.fire({
          icon: "warning",
          title: "Campo incorrecto",
          text: "El RFC debe tener 13 caracteres alfánumericos.",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        });
        return false;
    }

    if(!regexNSS.test(nss)){
      Swal.fire({
        icon: "warning",
        title: "Campo incorrecto",
        text: "El NSS debe de contener 11 dígitos, puede contener guión o no.",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      });
      return false;
    }

    // Si todo es válido
    return true;
}

        // Event listeners para formularios
        const employeeForm = document.getElementById("employee-form");
        if (employeeForm) {
          employeeForm.addEventListener("submit", function (e) {
            e.preventDefault();

             // Primero validar los campos
        if (!validarCampos()) {
            return; // Detener el envío si hay errores
        }

            const fechaIngreso = document.getElementById("fechaIngreso").value;
            const diasVacaciones = calcularDiasVacaciones(fechaIngreso);

            const contraseña = document.getElementById("contraseña").value;
            const confirmarContraseña = document.getElementById(
              "confirmarContraseña"
            ).value;

            if (contraseña !== confirmarContraseña) {
              Swal.fire({
                icon: "warning",
                title: "Contraseñas no coinciden",
                text: "Por favor, asegúrate de que ambas contraseñas sean iguales.",
                confirmButtonColor: "#3085d6",
                confirmButtonText: "Aceptar",
              });
              return;
            }

            const formData = new FormData(this);
            const empleadoData = {};

            formData.forEach((value, key) => {
              empleadoData[key] = value;
            });

            const areasSeleccionadas = Array.from(
              document.querySelectorAll('input[name="areas"]:checked')
            ).map((cb) => Number.parseInt(cb.value));

            if (areasSeleccionadas.length === 0) {
              Swal.fire({
                icon: "warning",
                title: "Área requerida",
                text: "Debes seleccionar al menos un área.",
                confirmButtonColor: "#3085d6",
                confirmButtonText: "Aceptar",
              });
              return;
            }

            empleadoData.areas = areasSeleccionadas;
            empleadoData.rol_id = empleadoData.tipoRol;
            delete empleadoData.tipoRol;
            delete empleadoData.nombreArea;

            empleadoData.Vacaciones = diasVacaciones;

            // Convertir a número
            empleadoData.idUsuario = Number(empleadoData.idUsuario);
            empleadoData.nss = empleadoData.nss;
            empleadoData.SueldoDiario = Number(empleadoData.SueldoDiario);
            empleadoData.SueldoSemanal = Number(empleadoData.SueldoSemanal);
            empleadoData.BonoSemanal = Number(empleadoData.BonoSemanal);
            empleadoData.Vacaciones = Number(empleadoData.Vacaciones);
            empleadoData.diasDisponibles = Number(empleadoData.diasDisponibles);

            // Validaciones finales
            if (
              isNaN(empleadoData.idUsuario) ||
              isNaN(empleadoData.SueldoDiario) ||
              isNaN(empleadoData.SueldoSemanal) ||
              isNaN(empleadoData.BonoSemanal)
            ) {
              Swal.fire({
                icon: "warning",
                title: "Valores inválidos",
                text: "Por favor, ingresa valores numéricos válidos en los campos requeridos.",
                confirmButtonColor: "#3085d6",
                confirmButtonText: "Aceptar",
              });
              return;
            }

            // Enviar al backend
            fetch("/api/empleado", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(empleadoData),
            })
              .then((res) => {
                if (!res.ok)
                  return res.json().then((data) => {
                    throw new Error(
                      data.error || "Error al guardar el empleado"
                    );
                  });
                return res.json();
              })
              .then((data) => {
                Swal.fire({
                  icon: "success",
                  title: "Empleado dado de alta",
                  text: data.mensaje,
                  confirmButtonColor: "#3085d6",
                  confirmButtonText: "Aceptar",
                }).then(() => {
                  cerrarModalAltaEmpleado();
                  location.reload();
                });
              })
              .catch((error) => {
                console.error("Error al insertar:", error);
                alert("Hubo un error al guardar el empleado: " + error.message);
              });
          });
        }

// Modificar el event listener del formulario de edición
const editEmployeeForm = document.getElementById("edit-employee-form");
if (editEmployeeForm) {
  editEmployeeForm.addEventListener("submit", (e) => {
    e.preventDefault();

    // ⭐ AGREGAR LA VALIDACIÓN AQUÍ
    if (!validarCamposEdicion()) {
        return; // Detener el envío si hay errores
    }

    const contraseña = document.getElementById("edit-contraseña").value;
    const confirmar = document.getElementById("edit-confirmarContraseña").value;

    if (contraseña !== confirmar) {
      Swal.fire({
        icon: "warning",
        title: "Contraseñas no coinciden",
        text: "Por favor, asegúrate de que ambas contraseñas sean iguales.",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      });
      return;
    }

    // Resto del código del formulario...
    const empleadoData = {
      idUsuario: Number(document.getElementById("edit-idUsuario").value),
      rol_id: document.getElementById("edit-tipoRol").value,
      nombres: document.getElementById("edit-nombres").value,
      paterno: document.getElementById("edit-paterno").value,
      materno: document.getElementById("edit-materno").value,
      fechaNacimiento: document.getElementById("edit-fechaNacimiento").value,
      direccion: document.getElementById("edit-direccion").value,
      codigoPostal: document.getElementById("edit-codigoPostal").value,
      correo: document.getElementById("edit-correo").value,
      // ⭐ CAMBIO IMPORTANTE: No convertir NSS a número
      nss: document.getElementById("edit-nss").value, // Mantener como string
      // ⭐ CAMBIO IMPORTANTE: No convertir teléfonos a número
      telefono: document.getElementById("edit-telefono").value, // Mantener como string
      fechaIngreso: document.getElementById("edit-fechaIngreso").value,
      rfc: document.getElementById("edit-rfc").value,
      curp: document.getElementById("edit-curp").value,
      puesto: document.getElementById("edit-puesto").value,
      nombreContactoEmergencia: document.getElementById("edit-nombreContactoEmergencia").value,
      // ⭐ CAMBIO IMPORTANTE: No convertir teléfono emergencia a número
      telefonoEmergencia: document.getElementById("edit-telefonoEmergencia").value, // Mantener como string
      parentesco: document.getElementById("edit-parentesco").value,
      contraseña: contraseña,
      SueldoDiario: Number(document.getElementById("edit-sueldoDiario").value),
      SueldoSemanal: Number(document.getElementById("edit-sueldoSemanal").value),
      BonoSemanal: Number(document.getElementById("edit-bonoSemanal").value),
      fechaBaja: document.getElementById("edit-fechaBaja").value || null,
      comentarioSalida: document.getElementById("edit-comentarioSalida").value || null,
      Vacaciones: Number(document.getElementById("edit-vacaciones").value) || 0,
      diasDisponibles: Number(document.getElementById("edit-diasDisponibles").value) || 0,
    };

    const checkboxes = document.querySelectorAll("#edit-checkbox-areas input[name='areas']:checked");
    const areasSeleccionadas = Array.from(checkboxes).map((cb) => Number.parseInt(cb.value));
    empleadoData.areas = areasSeleccionadas;

    fetch(`/api/empleado/${empleadoData.idUsuario}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(empleadoData),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Error al actualizar el empleado");
        return res.json();
      })
      .then((data) => {
        Swal.fire({
          icon: "success",
          title: "Empleado actualizado",
          text: data.mensaje,
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        }).then(() => {
          cerrarModalEditarEmpleado();
          location.reload();
        });
      })
      .catch((err) => {
        console.error("Error:", err);
        alert("Hubo un error al actualizar: " + err.message);
      });
  });
}

        const formBajaEmpleado = document.getElementById("form-baja-empleado");
        if (formBajaEmpleado) {
          formBajaEmpleado.addEventListener("submit", function (e) {
            e.preventDefault();

            const idUsuario = document.getElementById("baja-idUsuario").value;
            const fechaBaja = document.getElementById("baja-fecha").value;
            const comentarioSalida =
              document.getElementById("baja-comentario").value;

            if (!fechaBaja || !comentarioSalida) {
              alert("Todos los campos son obligatorios");
              return;
            }

            const body = {
              fechaBaja,
              comentarioSalida,
            };

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = "Procesando...";

            fetch(`/api/empleado/baja/${idUsuario}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            })
              .then(async (res) => {
                let data = null;
                try {
                  data = await res.json();
                } catch (_) {}

                if (!res.ok || !data) {
                  throw new Error(
                    data?.error || "Error al dar de baja al empleado"
                  );
                }
                return data;
              })
              .then((data) => {
                Swal.fire({
                  icon: "success",
                  title: "Empleado dado de baja correctamente",
                  confirmButtonColor: "#3085d6",
                  confirmButtonText: "Aceptar",
                }).then(() => {
                  cerrarModalBajaEmpleado();
                  location.reload();
                });
              })
              .catch((err) => {
                console.error("Error al dar de baja:", err);
                alert("Hubo un error al procesar la baja: " + err.message);
              })
              .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
              });
          });
        }

        function validarFormulario() {
          const cp = document.getElementById("cp").value.trim();
          const curp = document.getElementById("curp").value.trim();
          const rfc = document.getElementById("rfc").value.trim();
          const telefono = document.getElementById("telefono").value.trim();
          const nss = document.getElementById("nss").value.trim();
          const telefonoEmergencia = document.getElementById("telefonoEmergencia").value.trim();

          // Código Postal: 5 dígitos numéricos
          if (!/^\d{5}$/.test(cp)) {
            alert("El Código Postal debe tener 5 números.");
            return false;
          }

          // CURP: 18 caracteres alfanuméricos
          if (!/^[A-Z0-9]{18}$/i.test(curp)) {
            alert(
              "La CURP debe tener exactamente 18 caracteres alfanuméricos."
            );
            return false;
          }

          // RFC: 13 caracteres alfanuméricos
          if (!/^[A-Z0-9]{13}$/i.test(rfc)) {
            alert("El RFC debe tener exactamente 13 caracteres alfanuméricos.");
            return false;
          }

          // Teléfono: 10 dígitos
          if (!/^\d{10}$/.test(telefono)) {
            alert("El teléfono debe tener exactamente 10 dígitos.");
            return false;
          }

          // NSS: 11 dígitos, con o sin guiones (ej: 123-45-67890 o 12345678901)
          if (!/^(\d{2}-\d{2}-\d{2}-\d{4}-\d{1}|\d{11})$/.test(nss)) {
            alert(
              "El NSS debe tener 11 dígitos, con o sin guiones (ej: 12-34-56-7890-1."
            );
            return false;
          }

          if (!/^\d{10}$/.test(telefonoEmergencia)) {
            alert("El teléfono debe tener exactamente 10 dígitos.");
            return false;
          }

          return true; // Todo correcto
        }

        const areaForm = document.getElementById("area-form");
        if (areaForm) {
          areaForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const nombreArea = document.getElementById("nombreArea").value;

            fetch("/api/agregarArea", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ Area: nombreArea }),
            })
              .then((response) => {
                if (!response.ok) throw new Error("Error al guardar el área");
                return response.json();
              })
              .then((data) => {
                cerrarModalAgregarArea();
                document.getElementById("area-form").reset();
              })
              .catch((error) => {
                console.error("Error:", error);
                alert("Error al guardar el área: " + error.message);
              });
          });
        }

        const holidayForm = document.getElementById("holiday-form");
        if (holidayForm) {
          holidayForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const fecha = document.getElementById("fechaFestivo").value;
            const descripcion =
              document.getElementById("descripcionFestivo").value;
            const anio = new Date(fecha).getFullYear();

            fetch("/api/diafestivo", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                fecha: fecha,
                descripcion: descripcion,
                anio: anio,
              }),
            })
              .then((response) => {
                if (!response.ok)
                  throw new Error("Error al guardar el día festivo");
                return response.json();
              })
              .then((data) => {
                Swal.fire({
                  icon : "success",
                  title: "Día Festivo agregado al calendario",
                  confirmButtonColor: "#3085d6",
                  confirmButtonText: "Aceptar",
                })
              })
              .catch((error) => {
                console.error("Error:", error);
                alert("Error al guardar el día festivo: " + error.message);
              });
          });
        }
      });
    </script>
  </body>
</html>
