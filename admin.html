<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Administrador</title>
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="css/index.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <link rel="icon" href="Media/favicon.ico" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="js/utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

</head>
<body>
  <header>
    <div class="header-container">
      <a href="#" class="back-button" onclick="logout()">
        <i class="bi bi-arrow-left"></i>
        Cerrar Sesión
      </a>
      <img src="Media/logo.png" alt="Logo" class="logo" />
      <h1>Portal De Administrador</h1>
    </div>
  </header>

 <!-- Saludo nombre empleado llenado dinamicamente -->
  <div class="welcome-section">
    <div class="welcome-message">
      ¡Hola <span id="employee-name"></span>!
    </div>
    <p>¿Qué deseas hacer hoy?</p>
  </div>

  <div class="content-wrapper">
    <div class="employee-table-container">
      <h2>
        Empleados Registrados
        <button class="add-employee-btn" onclick="abrirModalAltaEmpleado()">
          Agregar empleado +
        </button>

        <button
          class="add-employee-btn"
          onclick="abrirModalExportarExcel()"
          style="margin-left: 2px"
        >
          Exportar Excel +
        </button>
      </h2>

      <div
  style="
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
  "
>
  <!-- Filtro por Estado -->
  <select
    id="filtro-estado"
    onchange="aplicarFiltros()"
    style="
      padding: 8px 12px;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      font-size: 1rem;
      border: 1.5px solid #bbb;
      background-color: #fff;
      cursor: pointer;
      outline: none;
      transition: border-color 0.3s ease;
    "
  >
   <!-- Filtros de actividad de empleado -->
    <option value="activos">Activos</option>
    <option value="inactivos">Inactivos</option>
    <option value="todos">Todos</option>
  </select>

  <!-- Filtro por Área -->
  <select
    id="filtro-area"
    onchange="aplicarFiltros()"
    style="
      padding: 8px 12px;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      font-size: 1rem;
      border: 1.5px solid #bbb;
      background-color: #fff;
      cursor: pointer;
      outline: none;
      transition: border-color 0.3s ease;
      margin-right: 350px;
    "
  >
    <option value="">Todas las áreas</option>
    <!-- Las opciones se llenarán dinámicamente -->
  </select>
 <!-- Input de busqueda -->
  <input
    type="text"
    id="busquedaEmpleado"
    oninput="buscarEmpleado()"
    placeholder="Buscar por ID o nombre"
    style="
      padding: 8px;
      width: 250px;
      margin-right: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    "
  />
  <button
    onclick="buscarEmpleado()"
    style="
      background-color: #2c3e50;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    "
  >
    <i class="bi bi-search"></i>
  </button>
</div>
 <!-- Acciones -->
      <table class="employee-table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Nombre</th>
            <th>Puesto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="empleados-body"></tbody>
      </table>
    </div>

    <!-- Botón dropdown con todas las opciones -->
    <div class="options-container">
      <div class="dropdown-container">
        <button class="dropdown-button" onclick="toggleDropdown()">
          <span>Menú</span>
          <span
            id="dropdown-notificacion-solicitudes"
            class="notification-badge"
            style="display: none"
            >0</span>
          <i class="bi bi-chevron-down dropdown-arrow"></i>
        </button>
        <div class="dropdown-content" id="dropdownContent">
          <div
            class="dropdown-item"
            onclick="navigateToOption('evaluarSoli.html')"
          >
            <i class="bi bi-search dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">
                Solicitudes
              </div>
              <div class="dropdown-item-description">
                Evalúa las solicitudes de tus empleados
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verSolicitudes.html')"
          >
            <i class="bi bi-eye dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Solicitudes</div>
              <div class="dropdown-item-description">
                Mira el historial de las solicitudes evaluadas
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('incapacidad.html')"
          >
            <i class="bi bi-hospital dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Incapacidades</div>
              <div class="dropdown-item-description">Autorizaciones</div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verIncapacidades.html')"
          >
            <i class="bi bi-hospital dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Incapacidades</div>
              <div class="dropdown-item-description">
                Consulta que empleados están en una incapacidad
              </div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalAgregarArea()">
            <i class="bi bi-building dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Área</div>
              <div class="dropdown-item-description">Agregar</div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalAgregarFestivo()">
            <i class="bi bi-calendar-plus dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Día Festivo</div>
              <div class="dropdown-item-description">
                Agregar un nuevo día festivo
              </div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalVerDiasFestivos()">
            <i class="bi bi-calendar dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Asuetos</div>
              <div class="dropdown-item-description">
                Ve los días festivos previamente agregados
              </div>
            </div>
          </div>

          <div class="dropdown-item" onclick="abrirModalMes()">
            <i class="bi bi-calendar-plus dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Aniversario Laboral</div>
              <div class="dropdown-item-description">
                Ver aniversarios laborales por mes.
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('reporte.html')"
          >
            <i class="bi bi-bar-chart-line dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Reportes</div>
              <div class="dropdown-item-description">Genera un reporte</div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verReportes.html')"
          >
            <i class="bi bi-bar-chart-line dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Reportes</div>
              <div class="dropdown-item-description">
                Visualiza los reportes generados
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('vacante.html')"
          >
            <i class="bi bi-pin-map dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Vacante</div>
              <div class="dropdown-item-description">Administra</div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('verVacantes.html')"
          >
            <i class="bi bi-pencil dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Vacantes</div>
              <div class="dropdown-item-description">
                Administra las vacantes solicitadas por tus compañeros
              </div>
            </div>
          </div>

          <div
            class="dropdown-item"
            onclick="navigateToOption('historial.html')"
          >
            <i class="bi bi-clock dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Historial</div>
              <div class="dropdown-item-description">
                Consulta todos los reportes, permisos y vacaciones.
              </div>
            </div>
          </div>
          

          <div
            class="dropdown-item"
            onclick="navigateToOption('stats.html')"
          >
            <i class="bi bi-pencil dropdown-item-icon"></i>
            <div class="dropdown-item-content">
              <div class="dropdown-item-title">Ver Gráficas</div>
              <div class="dropdown-item-description">
                Administra las estadísticas
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Todos los modales existentes se mantienen igual -->
    <!-- Modal para ver detalles del empleado -->
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2>Detalle del Empleado</h2>
        <div id="modal-body"></div>
      </div>
    </div>

    <!-- Modal de datos generales  -->
<div id="modal-generales" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalGenerales()">&times;</span>
    <h2>Datos Generales del Empleado</h2>
    <div id="modal-generales-body" class="modal-body-estilo"></div>
  </div>
</div>



    <!-- Modal para dar de alta empleado -->
    <div id="add-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAltaEmpleado()">&times;</span>
        <h2>Dar de alta nuevo empleado</h2>
        <form id="employee-form" class="add-employee-form">
          <!-- Campo 1 -->
          <div class="form-group">
            <label for="idUsuario">ID Usuario:</label>
            <input type="number" id="idUsuario" name="idUsuario" required />
          </div>

          <!-- Campo 2 (Combobox) -->
          <div class="form-group">
            <label for="tipoRol">Tipo de Rol:</label>
            <select id="tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <div class="form-group">
            <label>Áreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="toggle-areas"
              onclick="toggleAreas()"
            >
              Mostrar Áreas ▼
            </button>

            <div id="checkbox-areas" class="desplegable-container">
              <!-- Checkboxes se cargarán aquí -->
            </div>
            <small>Puedes seleccionar una o más áreas.</small>
          </div>

          <!-- Campo 4 -->
          <div class="form-group">
            <label for="nombres">Nombres:</label>
            <input type="text" id="nombres" name="nombres" required />
          </div>

          <!-- Campo 5 -->
          <div class="form-group">
            <label for="paterno">Apellido Paterno:</label>
            <input type="text" id="paterno" name="paterno" required />
          </div>

          <!-- Campo 6 -->
          <div class="form-group">
            <label for="materno">Apellido Materno:</label>
            <input type="text" id="materno" name="materno" />
          </div>

          <!-- Campo 7 -->
          <div class="form-group">
            <label for="fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Campo 8 -->
          <div class="form-group">
            <label for="direccion">Dirección:</label>
            <input type="text" id="direccion" name="direccion" required />
          </div>

          <!-- Campo 9 -->
          <div class="form-group">
  <label for="codigoPostal">Código Postal:</label>
  <input
    type="text"
    id="codigoPostal"
    placeholder="Ej. 12345"
    name="codigoPostal"
    maxlength="5"
    title="Por favor ingrese exactamente 5 dígitos numéricos"
    required
  />
</div>

          <!-- Campo 10 -->
          <div class="form-group">
            <label for="correo">Correo Electrónico:</label>
            <input type="email" id="correo" name="correo" required />
          </div>

          <!-- Campo 11 -->
          <div class="form-group">
            <label for="nss">Número de Seguro Social (NSS):</label>
            <input
              type="text"
              id="nss"
              name="nss"
              placeholder="Ej. 54-14-96-2319-8"
              required
            />
          </div>

          <!-- Campo 12 -->
          <div class="form-group">
            <label for="telefono">Teléfono:</label>
            <input
              type="tel"
              id="telefono"
              name="telefono"
              placeholder="Ej. 8441234567"
              title="Por favor ingrese 10 dígitos seguidos."
              required
            />
            
          </div>

          <!-- Campo 13 -->
          <div class="form-group">
            <label for="fechaIngreso">Fecha de Ingreso:</label>
            <input
              type="date"
              id="fechaIngreso"
              name="fechaIngreso"
              required
            />
          </div>

          <!-- Campo 14 -->
          <div class="form-group">
            <label for="rfc">RFC:</label>
            <input
              type="text"
              id="rfc"
              name="rfc"
              placeholder="Ej. OACD123456789"
              maxlength="13"
              required
            />
          </div>

          <!-- Campo 15 -->
          <div class="form-group">
            <label for="curp">CURP:</label>
            <input
              type="text"
              id="curp"
              name="curp"
              placeholder="Ej. GARC850701HDFRNS09"
              title="Por favor ingrese 18 caracteres alfanuméricos"
              maxlength="18"
              
              required
            />
          
          </div>

          <!-- Campo 16 -->
          <div class="form-group">
            <label for="puesto">Puesto:</label>
            <input type="text" id="puesto" name="puesto" required />
          </div>

          <!-- Campo 17 -->
          <div class="form-group">
            <label for="nombreContactoEmergencia"
              >Beneficiario/Contacto Emergencia:</label
            >
            <input
              type="text"
              id="nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Campo 18 -->
          <div class="form-group">
            <label for="telefonoEmergencia">Teléfono Emergencia:</label>
            <input
              type="tel"
              id="telefonoEmergencia"
              name="telefonoEmergencia"
              title="Por favor ingrese 1o dígitos sin espacios."
              required
            />
          </div>

          <!-- Campo 19 -->
          <div class="form-group">
            <label for="parentesco">Parentesco:</label>
            <input type="text" id="parentesco" name="parentesco" required />
          </div>

          <!-- Campo 20 -->
          <div class="form-group">
            <label for="contraseña">Contraseña:</label>
            <input
              type="password"
              id="contraseña"
              name="contraseña"
              required
            />
          </div>

          <!-- Campo 21 -->
          <div class="form-group">
            <label for="confirmarContraseña">Confirmar Contraseña:</label>
            <input
              type="password"
              id="confirmarContraseña"
              name="confirmarContraseña"
              required
            />
          </div>

          <!-- Campo Sueldo Diario -->
          <div class="form-group">
            <label for="sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="sueldoDiario"
              name="SueldoDiario"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Sueldo Semanal -->
          <div class="form-group">
            <label for="sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="sueldoSemanal"
              name="SueldoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Bono Semanal -->
          <div class="form-group">
            <label for="bonoSemanal">Bono Semanal:</label>
            <input
              type="number"
              id="bonoSemanal"
              name="BonoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Sueldo Mensual -->
          <div class="form-group">
            <label for="Mensual">Sueldo Mensual:</label>
            <input
              type="number"
              id="Mensual"
              name="Mensual"
              step="0.01"
              required
            />
          </div>

          <!-- Campo Vacaciones Disponibles -->
          <div class="form-group">
            <label for="vacacionesDisponibles">Vacaciones Disponibles:</label>
            <input
              type="number"
              id="diasDisponibles"
              name="diasDisponibles"
              required
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAltaEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para editar empleado -->
    <div id="edit-employee-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalEditarEmpleado()">&times;</span>
        <h2>Editar Empleado</h2>
        <form id="edit-employee-form" class="add-employee-form">
          <!-- ID -->
          <div class="form-group">
            <label for="edit-idUsuario">ID Usuario:</label>
            <input
              type="number"
              id="edit-idUsuario"
              name="idUsuario"
              readonly
            />
          </div>

          <!-- Rol -->
          <div class="form-group">
            <label for="edit-tipoRol">Tipo de Rol:</label>
            <select id="edit-tipoRol" name="tipoRol" required>
              <option value="">Cargando roles...</option>
            </select>
          </div>

          <!-- Áreas con toggle -->
          <div class="form-group">
            <label>Áreas:</label>
            <button
              type="button"
              class="toggle-desplegable"
              id="edit-toggle-areas"
              onclick="toggleAreas('edit')"
            >
              Mostrar Áreas ▼
            </button>
            <div id="edit-checkbox-areas" class="desplegable-container">
              <!-- checkboxes se insertan dinámicamente -->
            </div>
            <small>Puedes seleccionar una o más áreas.</small>
          </div>

          <!-- Nombres -->
          <div class="form-group">
            <label for="edit-nombres">Nombres:</label>
            <input type="text" id="edit-nombres" name="nombres" required />
          </div>

          <!-- Paterno -->
          <div class="form-group">
            <label for="edit-paterno">Apellido Paterno:</label>
            <input type="text" id="edit-paterno" name="paterno" required />
          </div>

          <!-- Materno -->
          <div class="form-group">
            <label for="edit-materno">Apellido Materno:</label>
            <input type="text" id="edit-materno" name="materno" />
          </div>

          <!-- Fecha de Nacimiento -->
          <div class="form-group">
            <label for="edit-fechaNacimiento">Fecha de Nacimiento:</label>
            <input
              type="date"
              id="edit-fechaNacimiento"
              name="fechaNacimiento"
              required
            />
          </div>

          <!-- Dirección -->
          <div class="form-group">
            <label for="edit-direccion">Dirección:</label>
            <input type="text" id="edit-direccion" name="direccion" required />
          </div>

          <!-- Código Postal -->
          <div class="form-group">
            <label for="edit-codigoPostal">Código Postal:</label>
            <input
              type="text"
              id="edit-codigoPostal"
              name="codigoPostal"
              required
            />
          </div>

          <!-- Correo -->
          <div class="form-group">
            <label for="edit-correo">Correo Electrónico:</label>
            <input type="email" id="edit-correo" name="correo" required />
          </div>

          <!-- NSS -->
          <div class="form-group">
            <label for="edit-nss">Número de Seguro Social (NSS):</label>
            <input type="text" id="edit-nss" name="nss" required />
          </div>

          <!-- Teléfono -->
          <div class="form-group">
            <label for="edit-telefono">Teléfono:</label>
            <input type="tel" id="edit-telefono" name="telefono" required />
          </div>

          <!-- Fecha de Ingreso -->
          <div class="form-group">
            <label for="edit-fechaIngreso">Fecha de Ingreso:</label>
            <input
              type="date"
              id="edit-fechaIngreso"
              name="fechaIngreso"
              required
            />
          </div>

          <!-- RFC -->
          <div class="form-group">
            <label for="edit-rfc">RFC:</label>
            <input type="text" id="edit-rfc" name="rfc" required />
          </div>

          <!-- CURP -->
          <div class="form-group">
            <label for="edit-curp">CURP:</label>
            <input type="text" id="edit-curp" name="curp" required />
          </div>

          <!-- Puesto -->
          <div class="form-group">
            <label for="edit-puesto">Puesto:</label>
            <input type="text" id="edit-puesto" name="puesto" required />
          </div>

          <!-- Contacto de Emergencia -->
          <div class="form-group">
            <label for="edit-nombreContactoEmergencia"
              >Nombre Contacto Emergencia:</label
            >
            <input
              type="text"
              id="edit-nombreContactoEmergencia"
              name="nombreContactoEmergencia"
              required
            />
          </div>

          <!-- Teléfono Emergencia -->
          <div class="form-group">
            <label for="edit-telefonoEmergencia">Teléfono Emergencia:</label>
            <input
              type="tel"
              id="edit-telefonoEmergencia"
              name="telefonoEmergencia"
              required
            />
          </div>

          <!-- Parentesco -->
          <div class="form-group">
            <label for="edit-parentesco">Parentesco:</label>
            <input
              type="text"
              id="edit-parentesco"
              name="parentesco"
              required
            />
          </div>

          <!-- Contraseña -->
          <div class="form-group">
            <label for="edit-contraseña">Contraseña:</label>
            <input
              type="password"
              id="edit-contraseña"
              name="contraseña"
              required
            />
          </div>

          <!-- Confirmar Contraseña -->
          <div class="form-group">
            <label for="edit-confirmarContraseña">Confirmar Contraseña:</label>
            <input
              type="password"
              id="edit-confirmarContraseña"
              name="confirmarContraseña"
              required
            />
          </div>

          <!-- Sueldo Diario -->
          <div class="form-group">
            <label for="edit-sueldoDiario">Sueldo Diario:</label>
            <input
              type="number"
              id="edit-sueldoDiario"
              name="SueldoDiario"
              step="0.01"
              required
            />
          </div>

          <!-- Sueldo Semanal -->
          <div class="form-group">
            <label for="edit-sueldoSemanal">Sueldo Semanal:</label>
            <input
              type="number"
              id="edit-sueldoSemanal"
              name="SueldoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Bono Semanal -->
          <div class="form-group">
            <label for="edit-bonoSemanal">Bono Semanal:</label>
            <input
              type="number"
              id="edit-bonoSemanal"
              name="BonoSemanal"
              step="0.01"
              required
            />
          </div>

          <!-- Sueldo Mensual -->
          <div class="form-group">
            <label for="edit-Mensual">Sueldo Mensual:</label>
            <input
              type="number"
              id="edit-Mensual"
              name="Mensual"
              step="0.01"
              required
            />
          </div>

          <!-- Fecha de Baja -->
          <div class="form-group">
            <label for="edit-fechaBaja">Fecha de Baja:</label>
            <input type="date" id="edit-fechaBaja" name="fechaBaja" />
          </div>

          <!-- Comentario de Salida -->
          <div class="form-group">
            <label for="edit-comentarioSalida">Comentario de Salida:</label>
            <input
              type="text"
              id="edit-comentarioSalida"
              name="comentarioSalida"
            />
          </div>

          <!-- Vacaciones -->
          <div class="form-group">
            <label for="edit-vacaciones">Vacaciones:</label>
            <input type="number" id="edit-vacaciones" name="Vacaciones" />
          </div>

          <!-- Vacaciones Disponibles -->
          <div class="form-group">
            <label for="edit-diasDisponibles">Vacaciones disponibles:</label>
            <input
              type="text"
              id="edit-diasDisponibles"
              name="diasDisponibles"
            />
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalEditarEmpleado()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Actualizar Empleado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar día festivo -->
    <div id="add-holiday-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarFestivo()">&times;</span>
        <h2>Agregar Día Festivo</h2>
        <form id="holiday-form" class="add-employee-form">
          <!-- Campo Fecha -->
          <div class="form-group">
            <label for="fechaFestivo">Fecha:</label>
            <input type="date" id="fechaFestivo" name="fechaFestivo" required />
          </div>

          <!-- Campo Descripción -->
          <div class="form-group">
            <label for="descripcionFestivo">Descripción:</label>
            <input
              type="text"
              id="descripcionFestivo"
              name="descripcionFestivo"
              required
              placeholder="Ej. Día de la Independencia"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarFestivo()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Agregar Festivo
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para ver días festivos -->
<div id="ver-dias-festivos-modal" class="modal hidden">
<div class="modal-content add-employee-modal">
  <span class="close" onclick="cerrarModalVerDiasFestivos()">&times;</span>
  <h2>Días Festivos</h2>

  <!-- Selector de año -->
  <div class="form-group">
    <label for="anioFestivo">Selecciona un año:</label>
    <select id="anioFestivo" onchange="cargarDiasFestivos()">
      <!-- Se llenará dinámicamente -->
    </select>
  </div>

  <!-- Lista de días festivos -->
  <div id="listaDiasFestivos" class="dias-festivos-lista">
    <!-- Aquí se mostrarán los días -->
  </div>

  <div class="form-actions">
    <button
      type="button"
      class="btn btn-secondary"
      onclick="cerrarModalVerDiasFestivos()"
    >
      Cerrar
    </button>
  </div>
</div>
</div>


    <!-- Modal para agregar área -->
    <div id="add-area-modal" class="modal hidden">
      <div class="modal-content add-employee-modal">
        <span class="close" onclick="cerrarModalAgregarArea()">&times;</span>
        <h2>Agregar Área</h2>
        <form id="area-form" class="add-employee-form">
          <!-- Campo Nombre del Área -->
          <div class="form-group">
            <label for="nombreArea">Nombre del Área:</label>
            <input
              type="text"
              id="nombreArea"
              name="nombreArea"
              required
              placeholder="Ej. Recursos Humanos"
            />
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="cerrarModalAgregarArea()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Agregar Área</button>
          </div>
        </form>
      </div>
    </div>

    
    <!-- Modal para exportar a Excel (actualizado) -->
<div id="export-excel-modal" class="modal hidden">
  <div class="modal-content add-employee-modal">
    <span class="close" onclick="cerrarModalExportarExcel()">&times;</span>

    <!-- Paso 1: Selección de campos -->
    <div id="paso-campos">
      <h2>Exportar datos (1/2)</h2>
      <p>Selecciona los campos que deseas incluir en el reporte:</p>

      <!-- Botones debajo del texto -->
      <div class="export-nav-buttons" style="display: flex; gap: 10px; margin: 10px 0;">
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('generales', this)">Datos generales</button>
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('baja', this)">Baja</button>
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('sueldo', this)">Sueldo</button>
  <button class="btn btn-outline-primary" type="button" onclick="seleccionarCamposPorCategoria('vacaciones', this)">Vacaciones</button>
</div>



      <div id="export-fields-container" class="fields-grid"></div>
      <div class="form-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="cerrarModalExportarExcel()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="mostrarPasoEmpleados()"
        >
          Siguiente
        </button>
      </div>
    </div>

    <!-- Paso 2: Selección de empleados -->
    <div id="paso-empleados" class="hidden">
      <h2>Exportar datos (2/2)</h2>
      <p>Selecciona los empleados a incluir en el reporte:</p>
      <div style="margin-bottom: 10px"></div>
      <div id="export-employees-container" class="fields-grid"></div>
      <div class="form-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="mostrarPasoCampos()"
        >
          Anterior
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="exportarExcel()"
        >
          Generar Excel
        </button>
      </div>
    </div>
  </div>
</div>


    <div id="modal-confirmacion" class="modal-confirmacion hidden">
      <div class="modal-contenido">
        <p id="modal-texto">¿Quieres eliminar este empleado?</p>
        <div class="modal-botones">
          <button id="modal-cancelar" class="btn">Cancelar</button>
          <button id="modal-confirmar" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Empleados por Mes de Ingreso -->
<div id="modal-mes-ingreso" class="modal-confirmacion" style="display: none;"

     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 9999;">
  
  <div class="modal-contenido"
       style="background-color: #fff; padding: 24px; border-radius: 10px;
              width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
    
    <h3 style="margin-top: 0; font-size: 20px; color: #2c3e50; text-align: center;">
      Empleados por Mes de Ingreso
    </h3>

    <label for="filtro-mes" style="display: block; margin: 16px 0 8px; font-weight: bold; color: #333;">
      Selecciona un mes:
    </label>

    <select id="filtro-mes" class="form-control"
            style="width: 100%; padding: 8px 10px; font-size: 14px;
                   border: 1px solid #ccc; border-radius: 5px;">
      <option value="1">Enero</option>
      <option value="2">Febrero</option>
      <option value="3">Marzo</option>
      <option value="4">Abril</option>
      <option value="5">Mayo</option>
      <option value="6">Junio</option>
      <option value="7">Julio</option>
      <option value="8">Agosto</option>
      <option value="9">Septiembre</option>
      <option value="10">Octubre</option>
      <option value="11">Noviembre</option>
      <option value="12">Diciembre</option>
    </select>

    <div id="resultado-empleados"
         style="margin-top: 1rem; max-height: 250px; overflow-y: auto;
                padding: 10px; background-color: #f9f9f9; border: 1px solid #eee;
                border-radius: 5px; font-size: 14px;">
      <!-- Resultados aquí -->
    </div>

    <div class="modal-botones"
         style="margin-top: 20px; text-align: right;">
      <button id="cerrar-modal-mes" class="btn"
              style="padding: 8px 16px; background-color: #007bff;
                     border: none; color: #fff; border-radius: 5px;
                     cursor: pointer; transition: background-color 0.3s;">
        Cerrar
      </button>
    </div>
  </div>
</div>


    
<div id="modal-baja-empleado" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalBajaEmpleado()">&times;</span>
    <h2>Dar de Baja Empleado</h2>

    <div style="margin-bottom: 15px">
      <p>
        Empleado: <strong id="nombre-empleado-baja"></strong> <br /><br />
      </p>
      <p>ID: <strong id="id-empleado-baja"></strong></p>
    </div>

    <form id="form-baja-empleado">
      <input type="hidden" id="baja-idUsuario" />

      <div class="form-group">
        <label for="baja-fecha">Fecha de Baja:</label>
        <input type="date" id="baja-fecha" name="fechaBaja" required />
      </div>

      <!-- Combobox para RazonBaja -->
      <div class="form-group">
        <label for="baja-razon">Razón de Baja:</label>
        <select id="baja-razon" name="idRazonBaja" required>
          <option value="">Seleccione una razón</option>
        </select>
      </div>

      <div class="form-group">
        <label for="baja-comentario">Comentarios sobre la baja:</label>
        <textarea
          id="baja-comentario"
          name="comentarioSalida"
          rows="4"
          required
          class="estilo-textarea"
        ></textarea>
      </div>

      <div class="form-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="cerrarModalBajaEmpleado()"
        >
          Cancelar
        </button>
        <button type="submit" class="btn btn-danger">Confirmar Baja</button>
      </div>
    </form>
  </div>
</div>
   <script>
// ===== VARIABLES GLOBALES =====
let empleadosVisibles = []
let camposSeleccionados = []
let empleadosSeleccionados = []

// Campos disponibles para exportación
const camposExportacion = [
  { id: "idUsuario", nombre: "ID Usuario" },
  { id: "TipoRol", nombre: "Tipo de Rol" },
  { id: "Areas", nombre: "Área" },
  { id: "Nombres", nombre: "Nombres" },
  { id: "Paterno", nombre: "Apellido Paterno" },
  { id: "Materno", nombre: "Apellido Materno" },
  { id: "FechaNacimiento", nombre: "Fecha Nacimiento" },
  { id: "Direccion", nombre: "Dirección" },
  { id: "CodigoPostal", nombre: "Código Postal" },
  { id: "Correo", nombre: "Correo Electrónico" },
  { id: "NSS", nombre: "Número de Seguro Social" },
  { id: "Telefono", nombre: "Teléfono" },
  { id: "FechaIngreso", nombre: "Fecha Ingreso" },
  { id: "RFC", nombre: "RFC" },
  { id: "Curp", nombre: "CURP" },
  { id: "Puesto", nombre: "Puesto" },
  { id: "NombreContactoEmergencia", nombre: "Contacto Emergencia" },
  { id: "TelefonoEmergencia", nombre: "Teléfono Emergencia" },
  { id: "Parentesco", nombre: "Parentesco" },
  { id: "FechaBaja", nombre: "Fecha Baja" },
  { id: "ComentarioSalida", nombre: "Comentario Salida" },
  { id: "Estado", nombre: "Estado" },
  { id: "SueldoDiario", nombre: "Sueldo Diario" },
  { id: "SueldoSemanal", nombre: "Sueldo Semanal" },
  { id: "BonoSemanal", nombre: "Bono Semanal" },
  { id: "Mensual", nombre: "Sueldo Mensual" },
  { id: "Vacaciones", nombre: "Vacaciones" },
  { id: "DiasDisponibles", nombre: "Dias Disponibles" },
]

// ===== UTILIDADES =====
const Utils = {
  // Verificar sesión
  verificarSesion() {
    const idUsuario = localStorage.getItem("idUsuario")
    if (!idUsuario) {
      window.location.href = "index.html"
    }
    return idUsuario
  },

  // Formatear fecha para input
  formatoFechaParaInput(fecha) {
    if (!fecha) return ""
    if (typeof fecha === "string" && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
      return fecha
    }
    const date = new Date(fecha)
    const offset = date.getTimezoneOffset()
    date.setMinutes(date.getMinutes() + offset)
    return date.toISOString().split("T")[0]
  },

  // Formatear fecha local
  formatearFechaLocal(fecha) {
    try {
      if (!fecha || fecha === "null" || fecha === null || fecha === undefined) {
        return "Sin fecha"
      }
      const [anio, mes, dia] = fecha.split("-").map(Number)
      const fechaObj = new Date(anio, mes - 1, dia)
      if (isNaN(fechaObj.getTime())) {
        return "Fecha inválida"
      }
      return fechaObj.toLocaleDateString("es-MX", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      })
    } catch (error) {
      console.error("Error al formatear fecha:", fecha, error)
      return "Error en fecha"
    }
  },

  // Calcular días de vacaciones
  calcularDiasVacaciones(fechaIngreso) {
    const hoy = new Date()
    const ingreso = new Date(fechaIngreso)
    hoy.setHours(0, 0, 0, 0)
    ingreso.setHours(0, 0, 0, 0)

    let años = hoy.getFullYear() - ingreso.getFullYear()
    const mesActual = hoy.getMonth()
    const diaActual = hoy.getDate()
    const mesIngreso = ingreso.getMonth()
    const diaIngreso = ingreso.getDate()

    if (mesActual < mesIngreso || (mesActual === mesIngreso && diaActual < diaIngreso)) {
      años--
    }

    // Tabla LFT
    if (años < 1) return 0
    if (años === 1) return 12
    if (años === 2) return 14
    if (años === 3) return 16
    if (años === 4) return 18
    if (años === 5) return 20
    if (años >= 6 && años <= 10) return 22
    if (años >= 11 && años <= 15) return 24
    if (años >= 16 && años <= 20) return 26
    if (años >= 21 && años <= 25) return 28
    return 30
  },

  // Control de scroll del body
  toggleBodyScroll(disable) {
    document.body.classList.toggle("no-scroll", disable)
  },
}

// ===== VALIDACIONES =====
const Validaciones = {
  // Expresiones regulares
  regexCP: /^\d{5}$/,
  regexTelefono: /^(?:\d\s*){10}$/,
  regexCURP: /^[A-Z0-9]{18}$/i,
  regexRFC: /^[A-Z0-9]{13}$/i,
  regexNSS: /^(?:\d{11}|\d{2}-\d{2}-\d{2}-\d{4}-\d{1}|\d{2}-\d{2}-\d{2}-\d{2}-\d{2}-\d{1})$/,

  // Validar campos del formulario
  validarCampos(prefix = "") {
    const getId = (id) => document.getElementById(prefix + id)

    const codigoPostal = getId("codigoPostal").value.trim()
    const telefono = getId("telefono").value.trim()
    const telefonoEmergencia = getId("telefonoEmergencia").value.trim()
    const curp = getId("curp").value.trim()
    const rfc = getId("rfc").value.trim()
    const nss = getId("nss").value.trim()

    const validaciones = [
      { test: this.regexCP.test(codigoPostal), mensaje: "El código postal debe tener 5 dígitos." },
      { test: this.regexTelefono.test(telefono), mensaje: "El número telefónico debe de tener 10 dígitos." },
      {
        test: this.regexTelefono.test(telefonoEmergencia),
        mensaje: "El número telefónico de emergencia debe de tener 10 dígitos.",
      },
      { test: this.regexCURP.test(curp), mensaje: "La CURP debe tener 18 caracteres alfanúmericos." },
      { test: this.regexRFC.test(rfc), mensaje: "El RFC debe tener 13 caracteres alfánumericos." },
      { test: this.regexNSS.test(nss), mensaje: "El NSS debe de contener 11 dígitos, puede contener guión o no." },
    ]

    for (const validacion of validaciones) {
      if (!validacion.test) {
        Swal.fire({
          icon: "warning",
          title: "Campo incorrecto",
          text: validacion.mensaje,
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        })
        return false
      }
    }
    return true
  },

  // Validar contraseñas
  validarContraseñas(contraseña, confirmar) {
    if (contraseña !== confirmar) {
      Swal.fire({
        icon: "warning",
        title: "Contraseñas no coinciden",
        text: "Por favor, asegúrate de que ambas contraseñas sean iguales.",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      })
      return false
    }
    return true
  },
}

// ===== DROPDOWN =====
const Dropdown = {
  toggle() {
    const dropdown = document.getElementById("dropdownContent")
    const button = document.querySelector(".dropdown-button")
    dropdown.classList.toggle("show")
    button.classList.toggle("active")
  },

  navigateToOption(url) {
    window.location.href = url
  },

  // Cerrar dropdown al hacer clic fuera
  init() {
    window.onclick = (event) => {
      if (!event.target.matches(".dropdown-button") && !event.target.closest(".dropdown-button")) {
        const dropdowns = document.getElementsByClassName("dropdown-content")
        for (const dropdown of dropdowns) {
          if (dropdown.classList.contains("show")) {
            dropdown.classList.remove("show")
            document.querySelector(".dropdown-button").classList.remove("active")
          }
        }
      }
    }
  },
}

// ===== API CALLS =====
const API = {
  // Cargar notificaciones
  async cargarNotificaciones() {
    try {
      const idUsuario = localStorage.getItem("idUsuario")
      if (!idUsuario) return

      const response = await fetch(`/api/totalSolicitudes/${idUsuario}`)
      if (!response.ok) throw new Error(`Error HTTP: ${response.status}`)

      const data = await response.json()

      // Actualizar badges
      const badges = ["notificacion-solicitudes", "dropdown-notificacion-solicitudes"]
      badges.forEach((badgeId) => {
        const badge = document.getElementById(badgeId)
        if (badge) {
          if (data.total > 0) {
            badge.textContent = data.total
            badge.style.display = badgeId.includes("dropdown") ? "inline-flex" : "inline-block"
          } else {
            badge.style.display = "none"
          }
        }
      })
    } catch (error) {
      console.error("Error al cargar notificaciones:", error)
    }
  },

  

  // Cargar nombre de usuario
  async cargarNombreUsuario(idUsuario) {
    try {
      const response = await fetch("/api/usuario/nombre", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idUsuario }),
      })

      if (!response.ok) throw new Error("Error al obtener el nombre del usuario")

      const data = await response.json()
      if (data.error) {
        console.error(data.error)
        document.getElementById("employee-name").textContent = "Administrador"
      } else {
        let nombreCompleto = data.nombres || ""
        if (data.paterno) nombreCompleto += ` ${data.paterno}`
        if (data.materno) nombreCompleto += ` ${data.materno}`
        document.getElementById("employee-name").textContent = nombreCompleto.trim() || "Administrador"
      }
    } catch (error) {
      console.error("Error al cargar nombre:", error)
      document.getElementById("employee-name").textContent = "Administrador"
    }
  },

  

  // Cargar áreas
  async cargarAreas() {
    try {
      const response = await fetch("/api/areas")
      const areas = await response.json()

      const selectArea = document.getElementById("filtro-area")
      selectArea.innerHTML = '<option value="">Todas las áreas</option>'

      areas.forEach((area) => {
        const option = document.createElement("option")
        option.value = area.idArea
        option.textContent = area.NombreArea
        selectArea.appendChild(option)
      })
    } catch (error) {
      console.error("Error al cargar las áreas:", error)
    }
  },

  // Cargar empleado por ID
  async cargarEmpleado(id) {
    const response = await fetch(`/api/empleado/${id}`)
    if (!response.ok) throw new Error("Error al cargar datos del empleado")
    return response.json()
  },

  // Cargar roles
  async cargarRoles() {
    const response = await fetch("/api/roles")
    return response.json()
  },
}

// ===== MODALES =====
const Modales = {
  // Abrir/cerrar modal genérico
  toggle(modalId, show) {
    const modal = document.getElementById(modalId)
    modal.classList.toggle("hidden", !show)
    Utils.toggleBodyScroll(show)
  },

  // Modal de confirmación
  mostrarConfirmacion({
    texto,
    textoBotonConfirmar = "Confirmar",
    claseBotonConfirmar = "btn-danger",
    onConfirmar,
    onCancelar,
  }) {
    const modal = document.getElementById("modal-confirmacion")
    const modalTexto = document.getElementById("modal-texto")
    const btnConfirmar = document.getElementById("modal-confirmar")
    const btnCancelar = document.getElementById("modal-cancelar")

    modalTexto.textContent = texto
    btnConfirmar.textContent = textoBotonConfirmar
    btnConfirmar.className = "btn " + claseBotonConfirmar

    modal.classList.remove("hidden")

    btnConfirmar.onclick = () => {
      if (typeof onConfirmar === "function") onConfirmar()
      modal.classList.add("hidden")
    }

    btnCancelar.onclick = () => {
      if (typeof onCancelar === "function") onCancelar()
      modal.classList.add("hidden")
    }
  },

  // Renderizar campo para modal de empleado
  renderField(label, value) {
    const texto = value === null || value === undefined || value === "" || value === "null" ? "Sin información" : value
    return `<p><strong>${label}:</strong> ${texto}</p>`
  },
}

// ===== EMPLEADOS =====
const Empleados = {
  // Aplicar filtros
  async aplicarFiltros() {
    const estado = document.getElementById("filtro-estado").value
    const area = document.getElementById("filtro-area").value
    const termino = document.getElementById("busquedaEmpleado").value.toLowerCase()

    try {
      let url = "/api/empleados?estado=" + encodeURIComponent(estado)
      if (area && area.trim() !== "") {
        url += "&area=" + encodeURIComponent(area)
      }

      const response = await fetch(url)
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`)

      const empleados = await response.json()

      // Aplicar filtro de búsqueda por nombre/ID
      let empleadosFiltrados = empleados
      if (termino && termino.trim() !== "") {
        empleadosFiltrados = empleados.filter(
          (emp) => emp.id.toString().includes(termino) || emp.nombre.toLowerCase().includes(termino),
        )
      }

      this.actualizarTabla(empleadosFiltrados)
    } catch (error) {
      console.error("Error al aplicar filtros:", error)
      const tbody = document.getElementById("empleados-body")
      tbody.innerHTML = `<tr><td colspan="4">Error al cargar empleados: ${error.message}</td></tr>`
    }
  },

  // Actualizar tabla de empleados
  actualizarTabla(empleados) {
  empleadosVisibles = empleados;
  const tbody = document.getElementById("empleados-body");
  tbody.innerHTML = "";

  if (empleados.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4">No se encontraron empleados</td></tr>`;
    return;
  }

  empleados.forEach((emp) => {
    const row = document.createElement("tr");
    // Agregar clase si está inactivo para estilizar la fila
    if (emp.estado === "Inactivo") {
      row.classList.add("inactive-employee");
    }

    // Crear botones de acción
    let actionButtons = `
      <button class="action-btn" onclick="Empleados.ver(${emp.id})">
        <i class="bi bi-eye"></i>
      </button>
      <button class="action-btn" onclick="Empleados.editar(${emp.id})">
        <i class="bi bi-pencil"></i>
      </button>
    `;

    // Si está inactivo, agregar botón de reactivación
    if (emp.estado === "Inactivo") {
      actionButtons += `
        <button class="action-btn reactivate-btn" onclick="Empleados.reactivar(${emp.id})">
          <i class="bi bi-person-plus"></i> 
        </button>
      `;
    } else {
      // Si está activo, mostrar botón de baja
      actionButtons += `
        <button class="action-btn" onclick="Empleados.abrirModalBaja(${emp.id})">
          <i class="bi bi-trash"></i>
        </button>
      `;
    }

    row.innerHTML = `
      <td>${emp.id}</td>
      <td>
        <button onclick="Empleados.verGenerales(${emp.id})" style="all: unset; cursor: pointer;">
          ${emp.nombre}
        </button>
      </td>
      <td>${emp.puesto}</td>
      <td class="action-buttons">
        ${actionButtons}
      </td>
    `;
    tbody.appendChild(row);
  });
},
  // Ver empleado completo
  async ver(id) {
    Utils.toggleBodyScroll(true)
    try {
      const data = await API.cargarEmpleado(id)
      const modalBody = document.getElementById("modal-body")

      const areasTexto =
        data.Areas && data.Areas.length > 0 ? data.Areas.map((area) => area.NombreArea).join(", ") : "Sin información"

      modalBody.innerHTML = `
        ${Modales.renderField("ID", data.idUsuario)}
        ${Modales.renderField("Rol", data.TipoRol)}
        ${Modales.renderField("Áreas", areasTexto)}
        ${Modales.renderField("Nombre Completo", `${data.Nombres} ${data.Paterno} ${data.Materno}`)}
        ${Modales.renderField("Fecha Nacimiento", data.FechaNacimiento)}
        ${Modales.renderField("Dirección", data.Direccion)}
        ${Modales.renderField("Código Postal", data.CodigoPostal)}
        ${Modales.renderField("Correo", data.Correo)}
        ${Modales.renderField("NSS", data.NSS)}
        ${Modales.renderField("Teléfono", data.Telefono)}
        ${Modales.renderField("Fecha Ingreso", data.FechaIngreso)}
        ${Modales.renderField("RFC", data.RFC)}
        ${Modales.renderField("CURP", data.Curp)}
        ${Modales.renderField("Puesto", data.Puesto)}
        ${Modales.renderField("Contacto Emergencia", data.NombreContactoEmergencia)}
        ${Modales.renderField("Teléfono Emergencia", data.TelefonoEmergencia)}
        ${Modales.renderField("Parentesco", data.Parentesco)}
        ${Modales.renderField("Fecha Baja", data.FechaBaja)}
        ${Modales.renderField("Comentario Salida", data.ComentarioSalida)}
        ${Modales.renderField("Clave", data.clave)}
        ${Modales.renderField("Estado", data.Estado)}
        ${Modales.renderField("Sueldo Diario", data.SueldoDiario)}
        ${Modales.renderField("Sueldo Semanal", data.SueldoSemanal)}
        ${Modales.renderField("Bono Semanal", data.BonoSemanal)}
        ${Modales.renderField("Sueldo Mensual", data.Mensual)}
        ${Modales.renderField("Vacaciones", data.Vacaciones)}
        ${Modales.renderField("Vacaciones disponibles", data.DiasDisponibles)}
      `

      Modales.toggle("modal", true)
    } catch (error) {
      console.error("Error:", error)
      alert("Error al cargar los datos del empleado")
    }
  },

  // Ver datos generales del empleado
  async verGenerales(id) {
    Utils.toggleBodyScroll(true)
    try {
      const data = await API.cargarEmpleado(id)
      const modalBody = document.getElementById("modal-generales-body")

      const areasTexto =
        data.Areas && data.Areas.length > 0 ? data.Areas.map((area) => area.NombreArea).join(", ") : "Sin información"

      modalBody.innerHTML = `
        ${Modales.renderField("ID", data.idUsuario)}
        ${Modales.renderField("Rol", data.TipoRol)}
        ${Modales.renderField("Áreas", areasTexto)}
        ${Modales.renderField("Nombre", data.Nombres)}
        ${Modales.renderField("Paterno", data.Paterno)}
        ${Modales.renderField("Materno", data.Materno)}
        ${Modales.renderField("Fecha nacimiento", data.FechaNacimiento)}
        ${Modales.renderField("Dirección", data.Direccion)}
        ${Modales.renderField("Código postal", data.CodigoPostal)}
        ${Modales.renderField("Correo electrónico", data.Correo)}
        ${Modales.renderField("Teléfono", data.Telefono)}
        ${Modales.renderField("Fecha ingreso", data.FechaIngreso)}
        ${Modales.renderField("CURP", data.Curp)}
        ${Modales.renderField("Puesto", data.Puesto)}
      `

      Modales.toggle("modal-generales", true)
    } catch (error) {
      console.error("Error:", error)
      alert("Error al cargar los datos generales del empleado")
    }
  },

  // Editar empleado
  async editar(id) {
    Modales.toggle("edit-employee-modal", true)

    try {
      const [data, roles] = await Promise.all([API.cargarEmpleado(id), API.cargarRoles()])

      // Llenar select de roles
      const selectRol = document.getElementById("edit-tipoRol")
      selectRol.innerHTML = '<option value="">Seleccione un rol</option>'
      roles.forEach((rol) => {
        const option = document.createElement("option")
        option.value = rol.idRol
        option.textContent = rol.TipoRol
        selectRol.appendChild(option)
      })

      // Llenar campos del formulario
      const campos = {
        "edit-idUsuario": data.idUsuario || "",
        "edit-tipoRol": data.Rol_idRol || "",
        "edit-nombres": data.Nombres || "",
        "edit-paterno": data.Paterno || "",
        "edit-materno": data.Materno || "",
        "edit-fechaNacimiento": Utils.formatoFechaParaInput(data.FechaNacimiento),
        "edit-direccion": data.Direccion || "",
        "edit-codigoPostal": data.CodigoPostal || "",
        "edit-correo": data.Correo || "",
        "edit-nss": data.NSS || "",
        "edit-telefono": data.Telefono || "",
        "edit-rfc": data.RFC || "",
        "edit-curp": data.Curp || "",
        "edit-puesto": data.Puesto || "",
        "edit-nombreContactoEmergencia": data.NombreContactoEmergencia || "",
        "edit-telefonoEmergencia": data.TelefonoEmergencia || "",
        "edit-parentesco": data.Parentesco || "",
        "edit-contraseña": data.clave || "",
        "edit-confirmarContraseña": data.clave || "",
        "edit-sueldoDiario": data.SueldoDiario || "",
        "edit-sueldoSemanal": data.SueldoSemanal || "",
        "edit-bonoSemanal": data.BonoSemanal || "",
        "edit-Mensual": data.Mensual || "",
        "edit-fechaBaja": Utils.formatoFechaParaInput(data.FechaBaja),
        "edit-comentarioSalida": data.ComentarioSalida || "",
        "edit-fechaIngreso": Utils.formatoFechaParaInput(data.FechaIngreso),
        "edit-vacaciones":
          data.Vacaciones != null
            ? data.Vacaciones
            : Utils.calcularDiasVacaciones(Utils.formatoFechaParaInput(data.FechaIngreso)),
        "edit-diasDisponibles": data.DiasDisponibles || 0,
      }

      Object.entries(campos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id)
        if (elemento) elemento.value = valor
      })

      // Cargar áreas
      const idsDeAreas = (data.Areas || []).map((area) => area.idArea)
      await this.cargarAreasParaEditar(data.idUsuario, idsDeAreas)

      // Event listener para recalcular vacaciones
      const fechaIngresoInput = document.getElementById("edit-fechaIngreso")
      fechaIngresoInput.addEventListener("change", function () {
        const nuevaFecha = this.value
        const dias = Utils.calcularDiasVacaciones(nuevaFecha)
        document.getElementById("edit-vacaciones").value = dias
      })
    } catch (error) {
      console.error("Error al cargar datos del empleado:", error)
      alert("No se pudieron cargar los datos del empleado.")
    }
  },

  // Cargar áreas para editar
  async cargarAreasParaEditar(idUsuario, areasSeleccionadas) {
    try {
      const response = await fetch("/api/areas")
      const areas = await response.json()
      const container = document.getElementById("edit-checkbox-areas")
      container.innerHTML = ""

      areas.forEach((area) => {
        const wrapper = document.createElement("div")
        wrapper.className = "area-item"

        const checkbox = document.createElement("input")
        checkbox.type = "checkbox"
        checkbox.name = "areas"
        checkbox.value = area.idArea
        checkbox.id = `area-${area.idArea}`
        checkbox.checked = areasSeleccionadas.includes(area.idArea)
        checkbox.className = "area-checkbox"

        const label = document.createElement("label")
        label.htmlFor = checkbox.id
        label.className = "area-label"
        label.textContent = area.NombreArea

        wrapper.appendChild(label)
        wrapper.appendChild(checkbox)
        container.appendChild(wrapper)
      })
    } catch (error) {
      console.error("Error al cargar áreas:", error)
    }
  },

  // Abrir modal de baja
 abrirModalBaja(idUsuario) {
  Utils.toggleBodyScroll(true);

  // Cargar datos del empleado
  API.cargarEmpleado(idUsuario).then(empleado => {
    document.getElementById("nombre-empleado-baja").textContent =
      `${empleado.Nombres} ${empleado.Paterno} ${empleado.Materno}`;
    document.getElementById("id-empleado-baja").textContent = idUsuario;
    document.getElementById("baja-idUsuario").value = idUsuario;

    // Cargar razones de baja
    const select = document.getElementById("baja-razon");
    fetch("/api/razones-baja")
      .then(response => {
        if (!response.ok) throw new Error("Error al obtener razones de baja");
        return response.json();
      })
      .then(data => {
        // Limpiar opciones existentes
        select.innerHTML = '<option value="">Seleccione una razón</option>';
        data.forEach(razon => {
          const option = document.createElement("option");
          option.value = razon.idRazonBaja;
          option.textContent = razon.RazonBaja;
          select.appendChild(option);
        });
      })
      .catch(error => {
        console.error("Error al cargar razones de baja:", error);
        select.innerHTML = '<option value="">No se pudieron cargar razones</option>';
      });

    // Abrir modal
    Modales.toggle("modal-baja-empleado", true);

  }).catch(err => {
    console.error("Error al cargar empleado:", err);
    alert("No se pudo abrir el modal de baja.");
  });
}
,

  // Cargar empleados por mes
  async cargarPorMes(mes) {
    try {
      const res = await fetch(`/api/empleados/mes/${mes}`)
      if (!res.ok) throw new Error(`Error HTTP: ${res.status}`)

      const data = await res.json()
      const resultadoDiv = document.getElementById("resultado-empleados")

      if (!data.empleados || data.empleados.length === 0) {
        resultadoDiv.innerHTML = `
          <p style="color: #666; text-align: center; padding: 20px; font-style: italic;">
            No hay empleados con aniversario laboral en este mes.
          </p>`
        return
      }

      // Ordenar por día de ingreso
      data.empleados.sort((a, b) => {
        return new Date(a.FechaIngreso).getDate() - new Date(b.FechaIngreso).getDate()
      })

      resultadoDiv.innerHTML = `
        <div style="max-height: 300px; overflow-y: auto;">
          ${data.empleados
            .map((empleado) => {
              const nombre = empleado.Nombres || "Sin nombre"
              const paterno = empleado.Paterno || ""
              const materno = empleado.Materno || ""
              const nombreCompleto = `${nombre} ${paterno} ${materno}`.trim()
              const fechaFormateada = Utils.formatearFechaLocal(empleado.FechaIngreso)

              return `
              <div style="
                padding: 12px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
              ">
                <span style="font-weight: 500; color: #333;">
                  ${nombreCompleto}
                </span>
                <span style="color: #666; font-size: 14px;">
                  ${fechaFormateada}
                </span>
              </div>
            `
            })
            .join("")}
        </div>
      `
    } catch (error) {
      console.error("Error en cargarEmpleadosPorMes:", error)
      document.getElementById("resultado-empleados").innerHTML = `
        <p style="color: red; text-align: center; padding: 20px;">
          Error al cargar empleados: ${error.message}
        </p>`
    }
  },
}

// ===== AREAS =====
const Areas = {
  // Toggle áreas
  toggle(context = "") {
    const prefix = context ? context + "-" : ""
    const contenedor = document.getElementById(`${prefix}checkbox-areas`)
    const boton = document.getElementById(`${prefix}toggle-areas`)

    if (!contenedor || !boton) return

    if (contenedor.classList.contains("abierto")) {
      contenedor.classList.remove("abierto")
      boton.textContent = "Mostrar Áreas ▼"
    } else {
      contenedor.classList.add("abierto")
      boton.textContent = "Ocultar Áreas ▲"
    }
  },

  // Cargar áreas para alta de empleado
  async cargarParaAlta() {
    try {
      const response = await fetch("/api/areas")
      const data = await response.json()
      const container = document.getElementById("checkbox-areas")
      container.innerHTML = ""

      data.forEach((area) => {
        const item = document.createElement("div")
        item.className = "area-item"

        const label = document.createElement("label")
        label.textContent = area.NombreArea
        label.className = "area-label"

        const checkbox = document.createElement("input")
        checkbox.type = "checkbox"
        checkbox.name = "areas"
        checkbox.value = area.idArea
        checkbox.className = "area-checkbox"

        item.appendChild(label)
        item.appendChild(checkbox)
        container.appendChild(item)
      })
    } catch (error) {
      console.error("Error al cargar áreas:", error)
    }
  },
}

// ===== DÍAS FESTIVOS =====
const DiasFestivos = {
  // Abrir modal ver días festivos
  abrir() {
    Modales.toggle("ver-dias-festivos-modal", true)
    this.llenarAnios()
  },

  // Cerrar modal
  cerrar() {
    Modales.toggle("ver-dias-festivos-modal", false)
    document.getElementById("listaDiasFestivos").innerHTML = ""
  },

  // Llenar años en select
  llenarAnios() {
    const select = document.getElementById("anioFestivo")
    const anioActual = new Date().getFullYear()
    select.innerHTML = ""

    for (let i = anioActual; i >= anioActual - 10; i--) {
      const option = document.createElement("option")
      option.value = i
      option.textContent = i
      select.appendChild(option)
    }

    this.cargar()
  },

  // Cargar días festivos
  async cargar() {
    const anio = document.getElementById("anioFestivo").value
    const lista = document.getElementById("listaDiasFestivos")
    lista.innerHTML = "Cargando..."

    try {
      const response = await fetch(`/api/diasfestivos?anio=${anio}`)
      if (!response.ok) throw new Error("Error al obtener días festivos")

      const data = await response.json()

      if (!data || data.length === 0) {
        lista.innerHTML = "<p>No hay días festivos registrados para este año.</p>"
        return
      }

      lista.innerHTML = ""

      const formatter = new Intl.DateTimeFormat("es-MX", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric",
      })

      data.forEach((festivo) => {
        const [anio, mes, dia] = festivo.fecha.split("-").map(Number)
        const fechaObj = new Date(anio, mes - 1, dia)
        const fechaFormateada = formatter.format(fechaObj)

        const item = document.createElement("div")
        item.classList.add("festivo-item")
        item.innerHTML = `<strong>${fechaFormateada}</strong>: ${festivo.descripcion}`
        lista.appendChild(item)
      })
    } catch (error) {
      console.error("Error al cargar días festivos:", error)
      lista.innerHTML = "<p>Error al cargar los días festivos. Intenta nuevamente más tarde.</p>"
    }
  },
}

// ===== EXPORTACIÓN EXCEL (CORREGIDO) =====
const ExportarExcel = {
  // Abrir modal y mostrar paso de campos
  abrir() {
    Modales.toggle("export-excel-modal", true)
    this.mostrarPasoCampos()
  },

  // Mostrar paso de campos
  mostrarPasoCampos() {
    // Asegurar que estamos en el paso correcto
    const pasoEmpleados = document.getElementById("paso-empleados")
    const pasoCampos = document.getElementById("paso-campos")

    pasoEmpleados.classList.remove("visible")
    pasoEmpleados.classList.add("hidden")
    pasoEmpleados.style.display = "none"

    pasoCampos.classList.remove("oculto")
    pasoCampos.style.display = "block"

    const container = document.getElementById("export-fields-container")
    container.innerHTML = ""
    container.style.display = "grid"
    container.style.gridTemplateColumns = "repeat(auto-fill, minmax(200px, 1fr))"
    container.style.gap = "12px"
    container.style.padding = "12px"

    camposExportacion.forEach((campo) => {
      const div = document.createElement("div")
      div.style.cssText = `
        display: flex; align-items: center; gap: 10px; padding: 8px;
        border-radius: 6px; background-color: #f8f9fa; transition: all 0.2s ease;
      `

      div.onmouseenter = () => {
        div.style.backgroundColor = "#e9ecef"
        div.style.transform = "translateY(-2px)"
      }
      div.onmouseleave = () => {
        div.style.backgroundColor = "#f8f9fa"
        div.style.transform = "none"
      }

      const checkbox = document.createElement("input")
      checkbox.type = "checkbox"
      checkbox.id = `export-${campo.id}`
      checkbox.value = campo.id
      checkbox.checked = true
      checkbox.style.cssText = "width: 18px; height: 18px; cursor: pointer; accent-color: #4dabf7;"

      const label = document.createElement("label")
      label.htmlFor = `export-${campo.id}`
      label.textContent = campo.nombre
      label.style.cssText = "cursor: pointer; font-size: 14px; user-select: none; color: #495057;"

      div.appendChild(checkbox)
      div.appendChild(label)
      container.appendChild(div)
    })
  },

  // Seleccionar campos por categoría
  seleccionarPorCategoria(categoria, botonPresionado) {
    const categorias = {
      generales: [
        "idUsuario",
        "TipoRol",
        "Areas",
        "Nombres",
        "Materno",
        "Paterno",
        "FechaNacimiento",
        "Direccion",
        "CodigoPostal",
        "Correo",
        "Telefono",
        "FechaIngreso",
        "Curp",
        "Puesto",
      ],
      baja: [
        "idUsuario",
        "TipoRol",
        "Areas",
        "Nombres",
        "Materno",
        "Paterno",
        "FechaNacimiento",
        "Direccion",
        "CodigoPostal",
        "Correo",
        "Telefono",
        "FechaIngreso",
        "Curp",
        "Puesto",
        "FechaBaja",
        "ComentarioSalida",
      ],
      sueldo: [
        "idUsuario",
        "TipoRol",
        "Areas",
        "Nombres",
        "Materno",
        "Paterno",
        "FechaNacimiento",
        "Direccion",
        "CodigoPostal",
        "Correo",
        "Telefono",
        "FechaIngreso",
        "Curp",
        "Puesto",
        "SueldoDiario",
        "SueldoSemanal",
        "BonoSemanal",
        "Mensual",
      ],
      vacaciones: [
        "idUsuario",
        "TipoRol",
        "Areas",
        "Nombres",
        "Materno",
        "Paterno",
        "FechaNacimiento",
        "Direccion",
        "CodigoPostal",
        "Correo",
        "Telefono",
        "FechaIngreso",
        "Curp",
        "Puesto",
        "Vacaciones",
        "DiasDisponibles",
      ],
    }

    const camposASeleccionar = categorias[categoria] || []

    // Seleccionar checkboxes
    const checkboxes = document.querySelectorAll("#export-fields-container input[type='checkbox']")
    checkboxes.forEach((cb) => {
      cb.checked = camposASeleccionar.includes(cb.value)
    })

    // Actualizar estilos de botones
    document.querySelectorAll(".export-nav-buttons button").forEach((btn) => {
      btn.classList.remove("btn-primary")
      btn.classList.add("btn-outline-primary")
    })

    if (botonPresionado) {
      botonPresionado.classList.remove("btn-outline-primary")
      botonPresionado.classList.add("btn-primary")
    }
  },

  // Mostrar paso empleados
  mostrarPasoEmpleados() {
    const checkboxes = document.querySelectorAll('#export-fields-container input[type="checkbox"]:checked')
    camposSeleccionados = Array.from(checkboxes).map((cb) => cb.value)

    if (camposSeleccionados.length === 0) {
      Swal.fire({
        icon: "warning",
        title: "Campos requeridos",
        text: "Por favor selecciona al menos un campo para exportar",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      })
      return
    }

    // Ocultar paso campos
    const pasoCampos = document.getElementById("paso-campos")
    const pasoEmpleados = document.getElementById("paso-empleados")

    pasoCampos.classList.add("oculto")
    pasoCampos.style.display = "none"

    // Mostrar paso empleados
    pasoEmpleados.classList.remove("hidden")
    pasoEmpleados.classList.add("visible")
    pasoEmpleados.style.display = "block"

    const container = document.getElementById("export-employees-container")
    container.innerHTML = ""
    container.style.cssText = `
      display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px; padding: 16px; max-height: 400px; overflow-y: auto;
    `

    if (empleadosVisibles.length === 0) {
      container.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #6c757d; font-size: 16px;">
          <i class="fas fa-users-slash" style="font-size: 24px; margin-bottom: 8px;"></i>
          <p>No hay empleados para exportar</p>
        </div>
      `
      return
    }

    // Botones select all/none
    const selectAllDiv = document.createElement("div")
    selectAllDiv.style.cssText = "grid-column: 1 / -1; display: flex; gap: 12px; margin-bottom: 8px;"

    const createButton = (text, bgColor, textColor, border, onClick) => {
      const btn = document.createElement("button")
      btn.textContent = text
      btn.style.cssText = `
        padding: 6px 12px; background: ${bgColor}; color: ${textColor};
        border: ${border}; border-radius: 4px; cursor: pointer;
      `
      btn.onclick = onClick
      return btn
    }

    const selectAllBtn = createButton("Seleccionar todos", "#174da3", "white", "none", () => {
      document.querySelectorAll(".empleado-checkbox").forEach((cb) => (cb.checked = true))
      this.updateEmployeeCounter()
    })

    const deselectAllBtn = createButton("Quitar todos", "#f1f3f5", "#495057", "1px solid #dee2e6", () => {
      document.querySelectorAll(".empleado-checkbox").forEach((cb) => (cb.checked = false))
      this.updateEmployeeCounter()
    })

    selectAllDiv.appendChild(selectAllBtn)
    selectAllDiv.appendChild(deselectAllBtn)
    container.appendChild(selectAllDiv)

    // Lista de empleados
    empleadosVisibles.forEach((emp) => {
      const div = document.createElement("div")
      div.style.cssText = `
        display: flex; align-items: center; gap: 12px; padding: 10px;
        border-radius: 6px; background-color: #f8f9fa; transition: all 0.2s ease;
      `

      div.onmouseenter = () => (div.style.backgroundColor = "#e9ecef")
      div.onmouseleave = () => (div.style.backgroundColor = "#f8f9fa")

      const checkbox = document.createElement("input")
      checkbox.type = "checkbox"
      checkbox.className = "empleado-checkbox"
      checkbox.value = emp.id
      checkbox.checked = true
      checkbox.style.cssText = "width: 18px; height: 18px; cursor: pointer; accent-color: #4dabf7;"

      const label = document.createElement("label")
      label.textContent = `${emp.id} - ${emp.nombre}`
      label.style.cssText = `
        cursor: pointer; font-size: 14px; user-select: none; color: #495057;
        flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      `

      div.appendChild(checkbox)
      div.appendChild(label)
      container.appendChild(div)
    })

    // Contador
    const counterDiv = document.createElement("div")
    counterDiv.style.cssText = "grid-column: 1 / -1; text-align: right; font-size: 14px; color: #6c757d;"
    counterDiv.id = "employee-counter"
    container.appendChild(counterDiv)
    this.updateEmployeeCounter()

    container.addEventListener("change", () => this.updateEmployeeCounter())
  },

  // Actualizar contador de empleados
  updateEmployeeCounter() {
    const total = empleadosVisibles.length
    const selected = document.querySelectorAll(".empleado-checkbox:checked").length
    const counter = document.getElementById("employee-counter")
    if (counter) {
      counter.textContent = `${selected} de ${total} empleados seleccionados`
    }
  },

  // Exportar a Excel
  async exportar() {
    const camposSeleccionados = Array.from(
      document.querySelectorAll('#export-fields-container input[type="checkbox"]:checked'),
    ).map((cb) => cb.value)

    const checkboxes = document.querySelectorAll('#export-employees-container input[type="checkbox"]:checked')
    const empleadosSeleccionados = Array.from(checkboxes).map((cb) => cb.value)

    if (empleadosSeleccionados.length === 0 || camposSeleccionados.length === 0) {
      Swal.fire({
        icon: "warning",
        title: "Selección incompleta",
        text: "Por favor selecciona al menos un empleado y al menos un campo para exportar",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      })
      return
    }

    const exportBtn = document.querySelector("#paso-empleados .btn-primary")
    const originalText = exportBtn.textContent
    exportBtn.textContent = "Generando..."
    exportBtn.disabled = true

    try {
      const promises = empleadosSeleccionados.map((id) => fetch(`/api/empleado/${id}`).then((res) => res.json()))

      const empleadosCompletos = await Promise.all(promises)

      const datosExcel = empleadosCompletos.map((empleado) => {
        const fila = {}
        camposSeleccionados.forEach((campo) => {
          if (campo === "Areas" && Array.isArray(empleado.Areas)) {
            fila[campo] = empleado.Areas.map((a) => a.NombreArea).join(", ")
          } else {
            fila[campo] = empleado[campo] !== undefined ? empleado[campo] : ""
          }
        })
        return fila
      })

      // Crear workbook con ExcelJS
      const workbook = new ExcelJS.Workbook()
      const worksheet = workbook.addWorksheet("Empleados")

      // Definir columnas
      worksheet.columns = camposSeleccionados.map((campo) => ({
        header: campo,
        key: campo,
        width: Math.max(campo.length + 2, 10),
      }))

      // Agregar datos
      datosExcel.forEach((empleado) => {
        worksheet.addRow(empleado)
      })

      // Aplicar estilos al encabezado (AMARILLO)
      const headerRow = worksheet.getRow(1)
      headerRow.eachCell((cell) => {
        cell.fill = {
          type: "pattern",
          pattern: "solid",
          fgColor: { argb: "FFFFFF00" },
        }
        cell.font = { bold: true, size: 10, name: "Arial" }
        cell.alignment = { horizontal: "center", vertical: "middle" }
      })

      // Aplicar estilos a filas de datos
      for (let i = 2; i <= worksheet.rowCount; i++) {
        const row = worksheet.getRow(i)
        const empleado = datosExcel[i - 2]

        const tieneFechaBaja = empleado["FechaBaja"] && empleado["FechaBaja"].toString().trim() !== ""
        const tieneComentarioBaja =
          empleado["ComentarioSalida"] && empleado["ComentarioSalida"].toString().trim() !== ""
        const esFilaRoja = tieneFechaBaja && tieneComentarioBaja

        row.eachCell((cell) => {
          if (esFilaRoja) {
            cell.fill = {
              type: "pattern",
              pattern: "solid",
              fgColor: { argb: "FFFF0000" },
            }
            cell.font = { color: { argb: "FFFFFFFF" }, size: 10, name: "Arial" }
          } else {
            cell.font = { size: 10, name: "Arial" }
          }
          cell.alignment = { vertical: "middle" }
        })
      }

      // Ajustar ancho de columnas
      worksheet.columns.forEach((column, index) => {
        const campo = camposSeleccionados[index]
        let maxLength = campo.length

        datosExcel.forEach((row) => {
          const cellValue = row[campo] ? row[campo].toString() : ""
          if (cellValue.length > maxLength) {
            maxLength = cellValue.length
          }
        })

        column.width = Math.min(maxLength + 2, 50)
      })

      // Generar y descargar archivo
      const buffer = await workbook.xlsx.writeBuffer()
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      })

      const url = window.URL.createObjectURL(blob)
      const a = document.createElement("a")
      a.href = url
      a.download = `empleados_exportados_${new Date().toISOString().split("T")[0]}.xlsx`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      window.URL.revokeObjectURL(url)
    } catch (error) {
      console.error("Error al exportar a Excel:", error)
      alert("Ocurrió un error al generar el archivo Excel: " + error.message)
    } finally {
      exportBtn.textContent = originalText
      exportBtn.disabled = false
      this.cerrar()
    }
  },

  // Cerrar modal
  cerrar() {
    Modales.toggle("export-excel-modal", false)
    camposSeleccionados = []
    empleadosSeleccionados = []
  },
}

// ===== FUNCIONES GLOBALES (para mantener compatibilidad con HTML) =====
window.toggleDropdown = () => Dropdown.toggle()
window.navigateToOption = (url) => Dropdown.navigateToOption(url)
window.toggleAreas = (context) => Areas.toggle(context)
window.abrirModalAltaEmpleado = () => Modales.toggle("add-employee-modal", true)
window.cerrarModalAltaEmpleado = () => Modales.toggle("add-employee-modal", false)
window.abrirModalExportarExcel = () => ExportarExcel.abrir() // CORREGIDO
window.cerrarModalExportarExcel = () => ExportarExcel.cerrar()
window.mostrarPasoCampos = () => ExportarExcel.mostrarPasoCampos()
window.mostrarPasoEmpleados = () => ExportarExcel.mostrarPasoEmpleados()
window.seleccionarCamposPorCategoria = (cat, btn) => ExportarExcel.seleccionarPorCategoria(cat, btn)
window.exportarExcel = () => ExportarExcel.exportar()
window.aplicarFiltros = () => Empleados.aplicarFiltros()
window.buscarEmpleado = () => Empleados.aplicarFiltros()
window.verEmpleado = (id) => Empleados.ver(id)
window.verEmpleadoGenerales = (id) => Empleados.verGenerales(id)
window.editarEmpleado = (id) => Empleados.editar(id)
window.cerrarModal = () => Modales.toggle("modal", false)
window.cerrarModalGenerales = () => Modales.toggle("modal-generales", false)
window.cerrarModalEditarEmpleado = () => Modales.toggle("edit-employee-modal", false)
window.abrirModalBajaEmpleado = (id) => Empleados.abrirModalBaja(id)
window.cerrarModalBajaEmpleado = () => Modales.toggle("modal-baja-empleado", false)
window.abrirModalAgregarArea = () => Modales.toggle("add-area-modal", true)
window.cerrarModalAgregarArea = () => Modales.toggle("add-area-modal", false)
window.abrirModalAgregarFestivo = () => Modales.toggle("add-holiday-modal", true)
window.cerrarModalAgregarFestivo = () => Modales.toggle("add-holiday-modal", false)
window.abrirModalVerDiasFestivos = () => DiasFestivos.abrir()
window.cerrarModalVerDiasFestivos = () => DiasFestivos.cerrar()
window.cargarDiasFestivos = () => DiasFestivos.cargar()
window.abrirModalMes = () => {
  const modal = document.getElementById("modal-mes-ingreso")
  modal.style.display = "flex"
  const selectMes = document.getElementById("filtro-mes")
  const mesActual = new Date().getMonth() + 1
  selectMes.value = mesActual
  Empleados.cargarPorMes(mesActual)
}
window.logout = () => {
  localStorage.removeItem("idUsuario")
  window.location.href = "index.html"
}

// ===== INICIALIZACIÓN =====
document.addEventListener("DOMContentLoaded", async () => {
  // Verificar sesión
  const idUsuario = Utils.verificarSesion()

  // Inicializar componentes
  Dropdown.init()

  // Cargar datos iniciales
  await Promise.all([
    API.cargarNotificaciones(),
    API.cargarNombreUsuario(idUsuario),
    API.cargarAreas(),
    Empleados.aplicarFiltros(),
  ])

  // Configurar intervalos
  setInterval(API.cargarNotificaciones, 1200000)

  // Event listeners para formularios
  setupFormListeners()

  // Event listeners para modales
  setupModalListeners()
})

// ===== CONFIGURACIÓN DE EVENT LISTENERS =====
function setupFormListeners() {
  // Formulario de alta de empleado
  const employeeForm = document.getElementById("employee-form")
  if (employeeForm) {
    employeeForm.addEventListener("submit", async function (e) {
      e.preventDefault()

      if (!Validaciones.validarCampos()) return

      const contraseña = document.getElementById("contraseña").value
      const confirmarContraseña = document.getElementById("confirmarContraseña").value

      if (!Validaciones.validarContraseñas(contraseña, confirmarContraseña)) return

      const fechaIngreso = document.getElementById("fechaIngreso").value
      const diasVacaciones = Utils.calcularDiasVacaciones(fechaIngreso)

      const formData = new FormData(this)
      const empleadoData = {}
      formData.forEach((value, key) => {
        empleadoData[key] = value
      })

      const areasSeleccionadas = Array.from(document.querySelectorAll('input[name="areas"]:checked')).map((cb) =>
        Number.parseInt(cb.value),
      )

      if (areasSeleccionadas.length === 0) {
        Swal.fire({
          icon: "warning",
          title: "Área requerida",
          text: "Debes seleccionar al menos un área.",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        })
        return
      }

      empleadoData.areas = areasSeleccionadas
      empleadoData.rol_id = empleadoData.tipoRol
      delete empleadoData.tipoRol
      empleadoData.Vacaciones = diasVacaciones

      // Convertir a números
      empleadoData.idUsuario = Number(empleadoData.idUsuario)
      empleadoData.SueldoDiario = Number(empleadoData.SueldoDiario)
      empleadoData.SueldoSemanal = Number(empleadoData.SueldoSemanal)
      empleadoData.BonoSemanal = Number(empleadoData.BonoSemanal)
      empleadoData.Vacaciones = Number(empleadoData.Vacaciones)
      empleadoData.diasDisponibles = Number(empleadoData.diasDisponibles)

      try {
        const response = await fetch("/api/empleado", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(empleadoData),
        })

        if (!response.ok) {
          const data = await response.json()
          throw new Error(data.error || "Error al guardar el empleado")
        }

        const data = await response.json()
        Swal.fire({
          icon: "success",
          title: "Empleado dado de alta",
          text: data.mensaje,
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        }).then(() => {
          Modales.toggle("add-employee-modal", false)
          location.reload()
        })
      } catch (error) {
        console.error("Error al insertar:", error)
        Swal.fire({
          icon: "error",
          title: "Error al dar de alta",
          text: "Verifica que el id del usuario no esté duplicado",
          confirmButtonColor: "#d33",
          confirmButtonText: "Aceptar",
        })
      }
    })
  }

  // Formulario de edición de empleado
  const editEmployeeForm = document.getElementById("edit-employee-form")
  if (editEmployeeForm) {
    editEmployeeForm.addEventListener("submit", async (e) => {
      e.preventDefault()

      if (!Validaciones.validarCampos("edit-")) return

      const contraseña = document.getElementById("edit-contraseña").value
      const confirmar = document.getElementById("edit-confirmarContraseña").value

      if (!Validaciones.validarContraseñas(contraseña, confirmar)) return

      const empleadoData = {
        idUsuario: Number(document.getElementById("edit-idUsuario").value),
        rol_id: document.getElementById("edit-tipoRol").value,
        nombres: document.getElementById("edit-nombres").value,
        paterno: document.getElementById("edit-paterno").value,
        materno: document.getElementById("edit-materno").value,
        fechaNacimiento: document.getElementById("edit-fechaNacimiento").value,
        direccion: document.getElementById("edit-direccion").value,
        codigoPostal: document.getElementById("edit-codigoPostal").value,
        correo: document.getElementById("edit-correo").value,
        nss: document.getElementById("edit-nss").value,
        telefono: document.getElementById("edit-telefono").value,
        fechaIngreso: document.getElementById("edit-fechaIngreso").value,
        rfc: document.getElementById("edit-rfc").value,
        curp: document.getElementById("edit-curp").value,
        puesto: document.getElementById("edit-puesto").value,
        nombreContactoEmergencia: document.getElementById("edit-nombreContactoEmergencia").value,
        telefonoEmergencia: document.getElementById("edit-telefonoEmergencia").value,
        parentesco: document.getElementById("edit-parentesco").value,
        contraseña: contraseña,
        SueldoDiario: Number(document.getElementById("edit-sueldoDiario").value),
        SueldoSemanal: Number(document.getElementById("edit-sueldoSemanal").value),
        BonoSemanal: Number(document.getElementById("edit-bonoSemanal").value),
        Mensual: Number(document.getElementById("edit-Mensual").value),
        fechaBaja: document.getElementById("edit-fechaBaja").value || null,
        comentarioSalida: document.getElementById("edit-comentarioSalida").value || null,
        Vacaciones: Number(document.getElementById("edit-vacaciones").value) || 0,
        diasDisponibles: Number(document.getElementById("edit-diasDisponibles").value) || 0,
      }

      const checkboxes = document.querySelectorAll("#edit-checkbox-areas input[name='areas']:checked")
      const areasSeleccionadas = Array.from(checkboxes).map((cb) => Number.parseInt(cb.value))
      empleadoData.areas = areasSeleccionadas

      try {
        const response = await fetch(`/api/empleado/${empleadoData.idUsuario}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(empleadoData),
        })

        if (!response.ok) throw new Error("Error al actualizar el empleado")

        const data = await response.json()
        Swal.fire({
          icon: "success",
          title: "Empleado actualizado",
          text: data.mensaje,
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        }).then(() => {
          Modales.toggle("edit-employee-modal", false)
          location.reload()
        })
      } catch (err) {
        console.error("Error:", err)
        alert("Hubo un error al actualizar: " + err.message)
      }
    })
  }

  // Otros formularios...
  setupOtherForms()
}

function setupOtherForms() {
  // Formulario de baja de empleado
const formBajaEmpleado = document.getElementById("form-baja-empleado");
if (formBajaEmpleado) {
  formBajaEmpleado.addEventListener("submit", async function (e) {
    e.preventDefault();

    const idUsuario = document.getElementById("baja-idUsuario").value;
    const fechaBaja = document.getElementById("baja-fecha").value;
    const comentarioSalida = document.getElementById("baja-comentario").value;
    const idRazonBaja = document.getElementById("baja-razon").value; // <-- NUEVO

    if (!fechaBaja || !comentarioSalida || !idRazonBaja) {
      alert("Todos los campos son obligatorios");
      return;
    }

    const body = { fechaBaja, comentarioSalida, idRazonBaja }; // <-- incluyes el campo
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Procesando...";

    try {
      const response = await fetch(`/api/empleado/baja/${idUsuario}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      let data = null;
      try {
        data = await response.json();
      } catch (_) {}

      if (!response.ok || !data) {
        throw new Error(data?.error || "Error al dar de baja al empleado");
      }

      Swal.fire({
        icon: "success",
        title: "Empleado dado de baja correctamente",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Aceptar",
      }).then(() => {
        Modales.toggle("modal-baja-empleado", false);
        location.reload();
      });
    } catch (err) {
      console.error("Error al dar de baja:", err);
      alert("Hubo un error al procesar la baja: " + err.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
}


  // Formulario de área
  const areaForm = document.getElementById("area-form")
  if (areaForm) {
    areaForm.addEventListener("submit", async (e) => {
      e.preventDefault()

      const nombreArea = document.getElementById("nombreArea").value

      try {
        const response = await fetch("/api/agregarArea", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ Area: nombreArea }),
        })

        if (!response.ok) throw new Error("Error al guardar el área")

        await response.json()
        Modales.toggle("add-area-modal", false)
        document.getElementById("area-form").reset()
      } catch (error) {
        console.error("Error:", error)
        alert("Error al guardar el área: " + error.message)
      }
    })
  }

  // Formulario de día festivo
  const holidayForm = document.getElementById("holiday-form")
  if (holidayForm) {
    holidayForm.addEventListener("submit", async (e) => {
      e.preventDefault()

      const fecha = document.getElementById("fechaFestivo").value
      const descripcion = document.getElementById("descripcionFestivo").value
      const anio = new Date(fecha).getFullYear()

      try {
        const response = await fetch("/api/diafestivo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha, descripcion, anio }),
        })

        if (!response.ok) throw new Error("Error al guardar el día festivo")

        await response.json()
        Swal.fire({
          icon: "success",
          title: "Día Festivo agregado al calendario",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "Aceptar",
        })
      } catch (error) {
        console.error("Error:", error)
        alert("Error al guardar el día festivo: " + error.message)
      }
    })
  }
}

function setupModalListeners() {
  // Modal de empleados por mes
  const selectMes = document.getElementById("filtro-mes")
  const cerrarBtn = document.getElementById("cerrar-modal-mes")

  if (selectMes) {
    selectMes.addEventListener("change", () => {
      Empleados.cargarPorMes(selectMes.value)
    })
  }

  if (cerrarBtn) {
    cerrarBtn.addEventListener("click", () => {
      document.getElementById("modal-mes-ingreso").style.display = "none"
    })
  }

  // Cargar roles y áreas para modal de alta
  const addEmployeeModal = document.getElementById("add-employee-modal")
  if (addEmployeeModal) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === "attributes" && mutation.attributeName === "class") {
          if (!addEmployeeModal.classList.contains("hidden")) {
            // Modal se abrió, cargar datos
            Promise.all([API.cargarRoles(), Areas.cargarParaAlta()]).then(([roles]) => {
              const selectRol = document.getElementById("tipoRol")
              selectRol.innerHTML = '<option value="">Seleccione un rol</option>'
              roles.forEach((rol) => {
                const option = document.createElement("option")
                option.value = rol.idRol
                option.textContent = rol.TipoRol
                selectRol.appendChild(option)
              })
            })
          }
        }
      })
    })
    observer.observe(addEmployeeModal, { attributes: true })
  }

  // Función para cargar razones de baja en el select
function cargarRazonesBaja() {
  const select = document.getElementById("baja-razon");
  
  fetch('/api/razones-baja')
    .then(response => response.json())
    .then(data => {
      // Limpiar opciones existentes (excepto la primera)
      select.innerHTML = '<option value="">Seleccione una razón</option>';
      
      data.forEach(razon => {
        const option = document.createElement("option");
        option.value = razon.idRazonBaja;
        option.textContent = razon.RazonBaja;
        select.appendChild(option);
      });
    })
    .catch(error => console.error("Error al cargar razones de baja:", error));
}

  // Event listener para recalcular vacaciones en formulario de alta
  const fechaIngresoInput = document.getElementById("fechaIngreso")
  if (fechaIngresoInput) {
    fechaIngresoInput.addEventListener("change", function () {
      const nuevaFecha = this.value
      const dias = Utils.calcularDiasVacaciones(nuevaFecha)
      const vacacionesField = document.getElementById("diasDisponibles")
      if (vacacionesField) {
        vacacionesField.value = dias
      }
    })
  }
}

    </script>

  </body>
</html>
